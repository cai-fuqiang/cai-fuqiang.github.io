<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="drain pasid" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="PASID 简介" /><meta property="og:description" content="PASID 简介" /><link rel="canonical" href="/posts/drain-pasid/" /><meta property="og:url" content="/posts/drain-pasid/" /><meta property="og:site_name" content="one step at a time" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-04-22T21:51:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="drain pasid" /><meta name="twitter:site" content="@fuqiang_cai" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2025-04-22T21:51:00+08:00","datePublished":"2025-04-22T21:51:00+08:00","description":"PASID 简介","headline":"drain pasid","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/drain-pasid/"},"url":"/posts/drain-pasid/"}</script><title>drain pasid | one step at a time</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="one step at a time"><meta name="application-name" content="one step at a time"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"></a><h1 class="site-title"> <a href="/">one step at a time</a></h1><p class="site-subtitle fst-italic mb-0">a noob's growing diary</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cai-fuqiang" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fuqiang_cai" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['iwng86','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>drain pasid</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>drain pasid</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1745329860" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 22, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2287 words" > <em>12 min</em> read</span></div></div></div></header><div class="content"><h2 id="pasid-简介"><span class="me-2">PASID 简介</span><a href="#pasid-简介" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="pasid-overflow"><span class="me-2">PASID overflow</span><a href="#pasid-overflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>PASID 全称Process Address Space ID, PASID 同 requester ID结合，共同确定该request 所映射的地址空间。所以 PASID 和 ASID 类似, 均标识一个地址映射关系。但是ASID 用于 标识CPU 侧的memory request，而PASID 则标识PCIe end point 的DMA（还有其他request， 下面描述）.</p><p><img src="./pic/pasid_vs_asid.svg" alt="PASID VS ASID" /></p><p>我们结合上图, 对比下两者: ||ASID|PASID| |—|—|—| |memory request 发起者|CPU|PCIe EP| |通过该ID查阅对象|TLB|IOMMU DMA remapping table| |作用|让TLB中可以缓存多个地址空间映射|让IOMMU 可以为一个function 的request 使用不同的地址空间|</p><p>每个 function 都有一组独特的 PASID 值。一个 function 使用的 PASID 值与任何其他 function 使用的 PASID 值无关</p><p><img src="./pic/pasid_overflow.svg" alt="PASID_overflow" /></p><p>如上图所示 request1, request2, request3 来源于一个设备，Request ID相同. 但是request1 和request2/3 的PASID 不相同，所以该地址使用的 <code class="language-plaintext highlighter-rouge">request address</code>-&gt;<code class="language-plaintext highlighter-rouge">phyiscal address</code> 的映射关系”数据库” 不同. 而request2， request 3 PASID 也相同。其两者均使用同一套映射关系进行地址映射。</p><p>而request 4 和request 3 即使PASID 相同，但是该request来自于不同的function， 所以两者使用不同的映射关系进行映射。</p><p><strong><em>总结</em></strong></p><p>PASID 用来标识PCIe EP 发出的memory request, 当该request到达iommu时，IOMMU会 根据PASID查询该function并所属于该PASID的 remapping table, 最终得到访问的物理 地址.</p><hr /><p>上面我们提到，可以用PASID标识一个request，在PCIe协议中就是一个TLP，那么问题来了:</p><ol><li>TLP的种类有那么多，PASID可以标记哪些request ?<li>标记无非是在TLP中加字段，PASID在TLP中的哪个位置呢 ?</ol><h3 id="pasid-in-pcie"><span class="me-2">PASID in PCIe</span><a href="#pasid-in-pcie" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="pasid-request"><span class="me-2">PASID request</span><a href="#pasid-request" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PASID 可以作用与下面的request:</p><ul><li><p>Memory Requests(including AtomicOp Requests)</p><p>with Address Type (AT) of Untranslated or Translated Request(个人认为还包括Translation Request)</p><li><p>Address Translation Requests:</p><ul><li>ATS Invalidation Request Messages<li>Page Request Messages<li>PRG Response Messages</ul></ul><h4 id="paisd-prefix"><span class="me-2">PAISD Prefix</span><a href="#paisd-prefix" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img src="pic/PASID_Prefix_no_Flit_mode.png" alt="PASID_Prefix_no_Flit_mode" /></p><p>关于各个字段的解释，见PCIe 6.0 spec <code class="language-plaintext highlighter-rouge">6.20.2.1 PASID TLP Prefix - Non-Flit Mode</code></p><p>接下来，我们来看下PASID的生命周期</p><h2 id="pasid-drain"><span class="me-2">PASID drain</span><a href="#pasid-drain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>PASID 可以分配，释放，再分配。这里面比较关键的步骤是释放步骤，也就是将PASID drain.</p><p>那释放一个PASID 有什么难点么?</p><p>难点就在于，在释放期间，如何彻底的clean/flush 掉 在PCIe 拓扑中的和该PASID 相关的 所有资源. 那PASID 的资源，可以在哪些地方呢?</p><p>我们以下图展示:</p><p><img src="./pic/pasid_res.svg" alt="pasid_res" /></p><p>主要包括下面部分:</p><ul><li>IOMMU<ul><li>IOTLB in IOMMU : IOMMU 保存该 pasid的iotlb<li>page request queue: page request queue中有该pasid相关的未处理的page request</ul><li>链路上的各种request:<ul><li>to upstream:<ul><li>Memory Request<li>Translation Request<li>Page Request</ul><li>to downstream:<ul><li>Memory Read Completion<li>Translation Completion (include translation fault)<li>Page Request Response</ul></ul><li>Device 上 Pending 的 request<ul><li>IOTLB in Device: 设备端保存的IOTLB<li>Memory Request: 设备还未发出的Memory Request<li>Page Request: 设备还未发出的Page Request</ul></ul><p>这里面比较重要的是各种request, 为什么这么说, 因为这些request 往往和其他组件有交 互, 举个例子:</p><ol><li>当device发出了 Translation Request<li>当IOMMU处理后，可能会更新其本地的IOTLB（<font color="red"><strong>存疑需确认</strong></font>).<li>IOMMU 向 Device发出Translation Completion(当然有可能还是 表示 translation fault的消息).<li>设备更新本地IOTLB</ol><p>如果我们非常武断的在步骤2后，发出PASID drain动作，并认为在步骤3执行之前，该动作 已经完成. 那么IOMMU 和 Device 中的IOTLB 将是stale的. 而随后如果software侧又分配 了该PASID，则可能使用stale IOTLB 酿成严重后果。</p><p>所以，我们需要一个规范，来规定，PASID drain 需要做什么动作，并且需要达到一个什么 样的状态可以认为PASID drain 动作完成. 对于设备/iommu 两个角色来说，谁在这个过程 中比较关键呢? 是设备，因为设备是这些request的发起者和接收者, 正说为做事有始有终, 最保险的方式是设备端将所有pending的request全部处理完, 再将PASID drain。</p><p>PCIe SPEC <code class="language-plaintext highlighter-rouge">6.20.1 Managing PASID Usage</code> 章节中描述了 设备应该做的事情, 原文如下:</p><ul><li>Stopped queuing new Requests for this PASID.<blockquote><p>不再发出新的request</p></blockquote><li>Completed all Non-Posted Requests associated with this PASID.<blockquote><p>等待所有 Non-Posted Request 完成</p></blockquote><li>Flushed to the host all Posted Requests addressing host memory in all TCs that were used by the PASID. The mechanism used for this is device specific (for example: a non-relaxed Posted Write to host memory or a processor read of the Function can flush TC0; a zero length read to host memory can flush non-zero TCs).<blockquote><p>确保所有到host memory 的 Posted Request 完成</p></blockquote><li>Optionally flushed all Peer-to-Peer Posted Requests to their destination(s). The mechanism used for this is device specific.<blockquote><p>确保所有PTP Posted Request 完成</p></blockquote><li>Complied with additional rules described in Address Translation Services (§ Chapter 10. ) if Address Translations or Page Requests were issued on the behalf of this PASID.<blockquote><p>Page Requests 相关请求要服从 Chatper 10 描述的规则.</p></blockquote></ul><p>总结下上面的规则:</p><ul><li>new memory request: 不发<li>链路上的 memory request: flush or wait, 总之就是等其complete.<li>Page Request: 额外的规则</ul><p>Page Request 为什么如此特殊呢? 能不能按照上面的规则来？(no new and wait old complete). 当然可以。但是可以做一些优化。</p><p>我们先展示下Page Request正常的处理流程，在展示在处理Page Request过程中如果触发 了PASID drain, 会有一些什么问题, 或者说可优化的点 ? ***</p><p>正常处理流程:</p><p><img src="./pic/Page_Request_Process.svg" alt="Page Request Process" /></p><p>重点是步骤3和4, 当PCIe EP 发送 Page Request Message 到IOMMU后，IOMMU会将该 Message 的信息存放到Page Request Queue中，并notify to host (deliver interrupt). 软件收到该notify后，会从Page Request Queue中获取Request，并建立IOVA-&gt;PA的映射。</p><p>而如果在这个过程中发生了PASID Drain 呢?</p><p><img src="./pic/PageRequestWithPASID_Drain.svg" alt="PageRequest_with_PASID_Drain" /></p><p>在步骤3后，发生PASID Drain(host software 发起), 此时如果PCIe EP一定要等Page Request Response 的话，host software 就比较纠结，我是为其建立映射好，还是不建立 映射好，如果为其建立映射，在设备发出Stop Request Completion 后，还得把这些映射销 毁。如果不为其建立映射, 软件也不知道现在 PCIe EP是否正在执行 Stop Request(或者说 是否不再发出新的request), 所以为了保险起见，软件一般会正确处理该Page Request，为其 建立映射，在收到Stop Request Completion后，再销毁该映射。</p><p>所以这就导致了一些不必要的处理。</p><p>能不能有一些优化呢?</p><h3 id="pasid-drain-with-page-request-optimization"><span class="me-2">PASID Drain with Page Request optimization</span><a href="#pasid-drain-with-page-request-optimization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>PCIe Spec <code class="language-plaintext highlighter-rouge">10.4.1.2 Managing PASID Usage on PRG Requests</code>, 描述了这一优化。</p><p>该章节起到了两种方式:</p><ul><li>未优化:<ul><li><ul><li>Stop queueing new Page Request Messages for this PASID.<li>Finish transmitting any multi-page Page Request Messages for this PASID (i.e., send the Page Request Message with the L bit Set).<li>Wait for PRG Response Messages associated any outstanding Page Request Messages for the PASID.<li>Indicate that the PASID has stopped using a device specific mechanism. This mechanism must indicate that a Stop Marker Message will not be generated.</ul><li>这种就是典型的<code class="language-plaintext highlighter-rouge">no new and wait old completion</code></ul><li>优化(use Stop Marker Message):<ul><li><ul><li>Stop queueing new Page Request Messages for this PASID.<li>Finish transmitting any multi-page Page Request Messages for this PASID (i.e., send the Page Request Message with the L bit Set).<li>(3)Internally mark all outstanding Page Request Messages for this PASID as stale. PRG Response Messages associated with these requests will return Page Request Allocation credits and PRG Index values but are otherwise ignored.<li>(4)Indicate that the PASID has stopped using a device specific mechanism. This mechanism must indicate that a Stop Marker Message will be generated.<li>(5)Send a Stop Marker Message to indicate to the host that all subsequent Page Request Messages for this PASID are for a new use of the PASID value.</ul><li><p>首先设备端首先支持去 Mark 那些标记该PASID的为complete 的 Page Request Message为stale. 如果收到标记的这些request的PRG Response Message, 仅获取PRG index value 并获取Page Request Allocation credits(<font color="red">待研究</font>) 并不会根据该 Response Message 更新其IOTLB.</p><p>然后，PCIe EP 就认为自己已经准备好drain 该PASID, 做了两件事情:</p><ol><li>stop message complete<li>Send a Stop Marker Messages</ol><p>并且手册中提到, 这两个操作是无顺序的，可以并行.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Note: Steps 4 and 5 may be performed in either order, or in parallel.
</pre></table></code></div></div><p>这里比较关键的是步骤3, 将外面的PRG Response Request标记为Stale之后, Software 就可以随意处理”Stale Page Request”（不为其建立映射了，随意回下就可以了). 但是 这里有一个问题:</p></ul></ul><p>host software 如何看到设备做完了第三步 ?</p><p>Stop Marker Message 可以用来指示, Stop Marker Message, 本身就是一个Page Request 只不过(L, W, R) 为(1, 0, 0), 该消息只是起到一个指示的作用, 无需 Response:</p><p><img src="pic/Stop_Marker_Message_no_Flit.png" alt="Stop_Marker_Message_no_Flit" /></p><p>当 Software 在收到Stop Marker后, 认为该设备已经stopped pasid.</p><blockquote><p>NOTE</p><p>这里有一个疑问 ?</p><p>步骤5也可以指示设备是否完成stopped pasid, 为什么非得要另加一个Stop Marker Message的机制 ??</p></blockquote><blockquote><p>WARN</p><p>以上内容，都是自己的理解，如有错误或者其他的想法，欢迎评论一起讨论</p></blockquote><h3 id="todo"><span class="me-2">TODO</span><a href="#todo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>ATS<li>Page Request<ul><li>credits ??</ul><li>VT-d SMS<li>Kernel Handle</ul><h2 id="参考链接"><span class="me-2">参考链接</span><a href="#参考链接" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li>PCIe 6.0 6.20 PASID</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/virt/">virt</a>, <a href="/categories/iommu/">iommu</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/virt/" class="post-tag no-text-decoration" >virt</a> <a href="/tags/pcie/" class="post-tag no-text-decoration" >pcie</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=drain%20pasid%20-%20one%20step%20at%20a%20time&url=%2Fposts%2Fdrain-pasid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=drain%20pasid%20-%20one%20step%20at%20a%20time&u=%2Fposts%2Fdrain-pasid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fdrain-pasid%2F&text=drain%20pasid%20-%20one%20step%20at%20a%20time" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/bpf-ISA/">Bpf Isa</a><li class="text-truncate lh-lg"> <a href="/posts/bpf-jit/">Bpf Jit</a><li class="text-truncate lh-lg"> <a href="/posts/bpf-verify/">Bpf Verify</a><li class="text-truncate lh-lg"> <a href="/posts/ebpf/">Ebpf</a><li class="text-truncate lh-lg"> <a href="/posts/bpf-overflow/">Bpf Overflow</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/cache/">cache</a> <a class="post-tag btn btn-outline-primary" href="/tags/kvm/">kvm</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/perftest/">perftest</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/pml/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713841200" data-df="ll" > Apr 23, 2024 </time><h4 class="pt-0 my-2">protected-mode memory management</h4><div class="text-muted"><p>29.3.6 Page-Modification Logging When accessed and dirty flags for EPT are enabled, software can track writes to guest-physical addresses using a feature called page-modification logging. 当启用了...</p></div></div></a></article><article class="col"> <a href="/posts/proctected-mode/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713841200" data-df="ll" > Apr 23, 2024 </time><h4 class="pt-0 my-2">protected-mode memory management</h4><div class="text-muted"><p>FROM intel sdm CHAPTER 3 PROTECTED-MODE MEMORY MANAGEMENT abstract This chapter describes the Intel 64 and IA-32 architecture’s protected-mode memory management facilities, including the phys...</p></div></div></a></article><article class="col"> <a href="/posts/virtualization-cr0/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713954600" data-df="ll" > Apr 24, 2024 </time><h4 class="pt-0 my-2">virtualization cr0</h4><div class="text-muted"><p>Guest/Host Masks and Read Shadows for CR0 and CR4 FROM intel sdm CHAPTER 25 VIRTUAL MACHINE CONTROL STRUCTURES 25.6 VM-EXECUTION CONTROL FIELDS 25.6.6 VM-execution control fields ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/Core-to-Core-latency/" class="btn btn-outline-primary" aria-label="Older" ><p>[perftest] core-to-core-latency</p></a> <a href="/posts/page-request/" class="btn btn-outline-primary" aria-label="Newer" ><p>page request</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/fuqiang_cai">fuqiang wang</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v6.5.5" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/cache/">cache</a> <a class="post-tag btn btn-outline-primary" href="/tags/kvm/">kvm</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/perftest/">perftest</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
