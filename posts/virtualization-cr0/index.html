<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="virtualization cr0" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="Guest/Host Masks and Read Shadows for CR0 and CR4" /><meta property="og:description" content="Guest/Host Masks and Read Shadows for CR0 and CR4" /><link rel="canonical" href="/posts/virtualization-cr0/" /><meta property="og:url" content="/posts/virtualization-cr0/" /><meta property="og:site_name" content="one step at a time" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-04-24T18:30:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="virtualization cr0" /><meta name="twitter:site" content="@fuqiang_cai" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2024-04-24T18:30:00+08:00","datePublished":"2024-04-24T18:30:00+08:00","description":"Guest/Host Masks and Read Shadows for CR0 and CR4","headline":"virtualization cr0","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/virtualization-cr0/"},"url":"/posts/virtualization-cr0/"}</script><title>virtualization cr0 | one step at a time</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="one step at a time"><meta name="application-name" content="one step at a time"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"></a><h1 class="site-title"> <a href="/">one step at a time</a></h1><p class="site-subtitle fst-italic mb-0">a noob's growing diary</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cai-fuqiang" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fuqiang_cai" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['iwng86','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>virtualization cr0</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>virtualization cr0</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1713954600" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 24, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2035 words" > <em>11 min</em> read</span></div></div></div></header><div class="content"><h2 id="guesthost-masks-and-read-shadows-for-cr0-and-cr4"><span class="me-2">Guest/Host Masks and Read Shadows for CR0 and CR4</span><a href="#guesthost-masks-and-read-shadows-for-cr0-and-cr4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>FROM intel sdm</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>CHAPTER 25 VIRTUAL MACHINE CONTROL STRUCTURES
  25.6 VM-EXECUTION CONTROL FIELDS
    25.6.6
</pre></table></code></div></div></blockquote><p>VM-execution control fields include <strong>guest/host masks</strong> and <strong>read shadows</strong> for the CR0 and CR4 registers. These fields control executions of instructions that access those registers (including CLTS, LMSW, MOV CR, and SMSW). They are 64 bits on processors that support Intel 64 architecture and 32 bits on processors that do not.</p><blockquote><p>VM-execution control 字段包括对于CR0 和 CR4 寄存器的 <strong>guest/host masks</strong> 和 <strong>read shadows</strong>. 这些字段控制访问这些寄存器的指令的执行（包括 CLTS、 LMSW、MOV CR 和 SMSW）。 它们在支持 Intel 64 架构的处理器上为 64 位，在不支持 Intel 64 架构的处理器上为 32 位。</p></blockquote><p>In general, bits set to 1 in a guest/host mask correspond to bits “owned” by the host:</p><blockquote><p>一般来说，<code class="language-plaintext highlighter-rouge">guest/host mask</code>中设置为 1 的位对应于host“owned(拥有)”的位：</p></blockquote><ul><li>Guest attempts to set them (using CLTS, LMSW, or MOV to CR) to values differing from the corresponding bits in the corresponding read shadow cause VM exits.<blockquote><p>guest尝试将它们（使用 CLTS、LMSW 或 MOV 到 CR）设置为与<code class="language-plaintext highlighter-rouge">read shadow</code>中的相应 位不同的值，导致 VM exit</p></blockquote><li>Guest reads (using MOV from CR or SMSW) return values for these bits from the corresponding read shadow. Bits cleared to 0 correspond to bits “owned” by the guest; guest attempts to modify them succeed and guest reads return values for these bits from the control register itself.<blockquote><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>correspond [ˌkɔːrəˈspɑːnd]: : 相一致, 符合;相当于;类似于
</pre></table></code></div></div><p>guest读取（使用 CR 或 SMSW 中的 MOV）从相应的<code class="language-plaintext highlighter-rouge">read shadow</code>中返回这些位的值。 cleared为 0 的位对应于guest “拥有”的位；guest尝试修改它们成功，并且guest从他们 自己的控制寄存器读取这些位的值.</p></blockquote></ul><p>See Chapter 28 for details regarding how these fields affect VMX non-root operation.</p><blockquote><p>有关这些字段如何影响 VMX 非 root 操作的详细信息，请参阅第 <strong>26</strong> 章。</p><blockquote class="prompt-info"><p>这里intel sdm 中写错了, 应该是26章</p></blockquote></blockquote><h2 id="mov-to-cr0-cause-vm-exits-conditionally"><span class="me-2">MOV to CR0 cause VM Exits Conditionally</span><a href="#mov-to-cr0-cause-vm-exits-conditionally" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>FROM intel sdm</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>CHAPTER 26 VMX NON-ROOT OPERATION
  26.1 INSTRUCTIONS THAT CAUSE VM EXITS
    26.1.3 Instructions That Cause VM Exits Conditionally
</pre></table></code></div></div></blockquote><ul><li><p><strong>MOV to CR0.</strong></p><p>The MOV to CR0 instruction causes a VM exit unless the value of its source operand matches, for the position of each bit set in the CR0 guest/host mask, the corresponding bit in the CR0 read shadow. (If every bit is clear in the CR0 guest/host mask, MOV to CR0 cannot cause a VM exit.)</p><blockquote><p>MOV 到 CR0 指令会导致 VM 退出，除非其源操作数的值与CR0<code class="language-plaintext highlighter-rouge">guest/host mask</code>中设 置的每个位的位置对应的 CR0 <code class="language-plaintext highlighter-rouge">read shadow</code>中相应位的值匹配。 （如果 CR0 <code class="language-plaintext highlighter-rouge">guest/host mask</code>中的每一位都被清除，则 MOV 到 CR0 不会导致 VM 退出。）</p><blockquote class="prompt-tip"><p>E.g.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>CR0 guest host mask : 0 0 0 0 1 0 1 0 1 0 1
                              |   |   |   |
                              |   |   |   |
CR0 read shadow     : 1 1 1 1 1 1 1 1 1 1 1
compare bit         :         ^   ^   ^   ^
source operand      : x x x x 1 x 1 x 1 x 1   ---&gt; NO vm exit
source operand      : x x x x x x x x x x 0   ---&gt; need vm exit
</pre></table></code></div></div><p>会将设置的值和 compare bit进行比较, 如果两者一样, 则不需要vm exit, 如果不一样, 则需要VM exit, 下面会说明原因</p></blockquote></blockquote></ul><h2 id="changes-to-mov-fromto-cr0-behavior-in-vmx-non-root-operation"><span class="me-2">CHANGES TO “MOV from/to CR0” BEHAVIOR IN VMX NON-ROOT OPERATION</span><a href="#changes-to-mov-fromto-cr0-behavior-in-vmx-non-root-operation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>FROM intel sdm</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>CHAPTER 26 VMX NON-ROOT OPERATION
  26.3 CHANGES TO INSTRUCTION BEHAVIOR IN VMX NON-ROOT OPERATION
</pre></table></code></div></div></blockquote><ul><li><p><strong>MOV from CR0.</strong></p><p>The behavior of MOV from CR0 is determined by the CR0 guest/host mask and the CR0 read shadow. For each position corresponding to a bit clear in the CR0 guest/host mask, the destination operand is loaded with the value of the corresponding bit in CR0. For each position corresponding to a bit set in the CR0 guest/host mask, the destination operand is loaded with the value of the corresponding bit in the CR0 read shadow. Thus, if every bit is cleared in the CR0 guest/host mask, MOV from CR0 reads normally from CR0; if every bit is set in the CR0 guest/host mask, MOV from CR0 returns the value of the CR0 read shadow. Depending on the contents of the CR0 guest/host mask and the CR0 read shadow, bits may be set in the destination that would never be set when reading directly from CR0.</p><blockquote><p><code class="language-plaintext highlighter-rouge">MOV from CR0</code> 的行为由 CR0 <code class="language-plaintext highlighter-rouge">guest/host mask</code>和 CR0 <code class="language-plaintext highlighter-rouge">read shadow</code>决定。 对于与 CR0 <code class="language-plaintext highlighter-rouge">guest/host mask</code>中清零位相对应的每个位置，目标操作数将加载 CR0 中相应位的值。 对于与 CR0 <code class="language-plaintext highlighter-rouge">guest/host mask</code>中设置的位相对应的每个位置， 目标操作数将加载 CR0 <code class="language-plaintext highlighter-rouge">read shadow</code>中相应位的值。 因此，如果 <code class="language-plaintext highlighter-rouge">CR0 guest/host mask</code>中的每一位都被清除，则 MOV from CR0 会正常从 CR0 读取； 如果在 CR0 <code class="language-plaintext highlighter-rouge">guest/host mask</code>中设置了每个位，则<code class="language-plaintext highlighter-rouge">MOV from CR0</code> 将返回 CR0 <code class="language-plaintext highlighter-rouge">read shadow</code>的值。 根据 CR0 <code class="language-plaintext highlighter-rouge">guest/host mask</code>和 CR0 <code class="language-plaintext highlighter-rouge">read shadow</code>的内容，可能会在destination设置 一些 直接从 CR0 读取的永远不会设置的位。</p></blockquote><li><p><strong>MOV to CR0</strong></p><p>An execution of MOV to CR0 that does not cause a VM exit (see Section 26.1.3) leaves unmodified any bit in CR0 corresponding to a bit set in the CR0 guest/host mask. Treatment of attempts to modify other bits in CR0 depends on the setting of the “unrestricted guest” VM-execution control:</p><blockquote><p>执行 <code class="language-plaintext highlighter-rouge">MOV to CR0</code> 不会导致 VM 退出（请参阅第 26.1.3 节），从而使 CR0 中与 CR0 <code class="language-plaintext highlighter-rouge">guest/host mask</code>中设置的位相对应的任何位保持不变。 对修改 CR0 中其他位的尝试 的处理取决于“unrestricted guest”VM-execution control 的设置：</p></blockquote><ul><li>If the control is 0, MOV to CR0 causes a general-protection exception if it attempts to set any bit in CR0 to a value not supported in VMX operation (see Section 24.8).<blockquote><p>如果控制为 0，则 <code class="language-plaintext highlighter-rouge">MOV to CR0</code> 尝试将 CR0 中的任何位设置为 VMX operation不支持 的值时会导致一般保护异常（请参见第 24.8 节）。</p></blockquote><li>If the control is 1, MOV to CR0 causes a general-protection exception if it attempts to set any bit in CR0 other than bit 0 (PE) or bit 31 (PG) to a value not supported in VMX operation. It remains the case, however, that MOV to CR0 causes a general-protection exception if it would result in CR0.<blockquote><p>如果控制为 1，则 <code class="language-plaintext highlighter-rouge">MOV to CR0</code> 尝试将 CR0 中除位 0 (PE) 或位 31 (PG) 之外的 任何位设置为 VMX operation 不支持的值时，会导致一般保护异常。 然而，情况 仍然如此，如果 MOV to CR0 会导致 CR0，则会导致一般保护异常。</p></blockquote></ul></ul><h2 id="my-note"><span class="me-2">MY note</span><a href="#my-note" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="读取操作"><span class="me-2">读取操作:</span><a href="#读取操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-75150b4de17bd88865df62a6317d07dc" width="342pt" height="268pt" viewBox="0.00 0.00 342.00 268.00"><title>graphviz-75150b4de17bd88865df62a6317d07dc</title><desc> digraph G { subgraph cluster_cr0 { cr0_bitmap [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;0|&lt;2&gt;0|&lt;3&gt;0&quot; ] label=&quot;cr0&quot; } subgraph cluster_cr0_host_guest_mask { cr0_host_guest_mask_bitmap [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;1|&lt;2&gt;1|&lt;3&gt;1&quot; ] label=&quot;cr0 host/guest mask&quot; } subgraph cluster_cr0_read_shadow { cr0_read_shadow_bitmap [ shape=&quot;record&quot; label=&quot;&lt;0&gt;1|&lt;1&gt;1|&lt;2&gt;1|&lt;3&gt;1&quot; ] label=&quot;cr0 read shadow bitmap&quot; } subgraph cluster_destination_value { destination_value [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;1|&lt;2&gt;1|&lt;3&gt;1&quot; ] label=&quot;destination value&quot; } cr0_host_guest_mask_bitmap:0-&gt;cr0_bitmap:0 cr0_host_guest_mask_bitmap:1-&gt;cr0_read_shadow_bitmap:1 cr0_host_guest_mask_bitmap:2-&gt;cr0_read_shadow_bitmap:2 cr0_host_guest_mask_bitmap:3-&gt;cr0_read_shadow_bitmap:3 cr0_bitmap:0-&gt;destination_value:0 cr0_read_shadow_bitmap:1-&gt;destination_value:1 cr0_read_shadow_bitmap:2-&gt;destination_value:2 cr0_read_shadow_bitmap:3-&gt;destination_value:3 } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 264)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-264 338,-264 338,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_cr0</title><polygon fill="none" stroke="black" points="8,-92 8,-168 128,-168 128,-92 8,-92" /> <text text-anchor="middle" x="68" y="-152.8" font-family="Times,serif" font-size="14.00">cr0</text> </g> <g id="clust2" class="cluster"><title>cluster_cr0_host_guest_mask</title><polygon fill="none" stroke="black" points="116,-176 116,-252 277,-252 277,-176 116,-176" /> <text text-anchor="middle" x="196.5" y="-236.8" font-family="Times,serif" font-size="14.00">cr0 host/guest mask</text> </g> <g id="clust3" class="cluster"><title>cluster_cr0_read_shadow</title><polygon fill="none" stroke="black" points="136,-92 136,-168 326,-168 326,-92 136,-92" /> <text text-anchor="middle" x="231" y="-152.8" font-family="Times,serif" font-size="14.00">cr0 read shadow bitmap</text> </g> <g id="clust4" class="cluster"><title>cluster_destination_value</title><polygon fill="none" stroke="black" points="126,-8 126,-84 266,-84 266,-8 126,-8" /> <text text-anchor="middle" x="196" y="-68.8" font-family="Times,serif" font-size="14.00">destination value</text> </g> <g id="node1" class="node"><title>cr0_bitmap</title><polygon fill="none" stroke="black" points="16,-100.5 16,-136.5 120,-136.5 120,-100.5 16,-100.5" /> <text text-anchor="middle" x="29" y="-114.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="42,-100.5 42,-136.5 " /> <text text-anchor="middle" x="55" y="-114.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="68,-100.5 68,-136.5 " /> <text text-anchor="middle" x="81" y="-114.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="94,-100.5 94,-136.5 " /> <text text-anchor="middle" x="107" y="-114.8" font-family="Times,serif" font-size="14.00">0</text> </g> <g id="node4" class="node"><title>destination_value</title><polygon fill="none" stroke="black" points="144,-16.5 144,-52.5 248,-52.5 248,-16.5 144,-16.5" /> <text text-anchor="middle" x="157" y="-30.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="170,-16.5 170,-52.5 " /> <text text-anchor="middle" x="183" y="-30.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="196,-16.5 196,-52.5 " /> <text text-anchor="middle" x="209" y="-30.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="222,-16.5 222,-52.5 " /> <text text-anchor="middle" x="235" y="-30.8" font-family="Times,serif" font-size="14.00">1</text> </g> <g id="edge5" class="edge"><title>cr0_bitmap:0&#45;&gt;destination_value:0</title><path fill="none" stroke="black" d="M29,-99.5C29,-42.95 141.03,-104.86 155.47,-63.57" /><polygon fill="black" stroke="black" points="158.96,-63.91 157,-53.5 152.04,-62.86 158.96,-63.91" /> </g> <g id="node2" class="node"><title>cr0_host_guest_mask_bitmap</title><polygon fill="none" stroke="black" points="144,-184.5 144,-220.5 248,-220.5 248,-184.5 144,-184.5" /> <text text-anchor="middle" x="157" y="-198.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="170,-184.5 170,-220.5 " /> <text text-anchor="middle" x="183" y="-198.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="196,-184.5 196,-220.5 " /> <text text-anchor="middle" x="209" y="-198.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="222,-184.5 222,-220.5 " /> <text text-anchor="middle" x="235" y="-198.8" font-family="Times,serif" font-size="14.00">1</text> </g> <g id="edge1" class="edge"><title>cr0_host_guest_mask_bitmap:0&#45;&gt;cr0_bitmap:0</title><path fill="none" stroke="black" d="M157,-183.5C157,-170.63 64.18,-157.28 36.62,-144.27" /><polygon fill="black" stroke="black" points="38.8,-141.52 29,-137.5 34.15,-146.76 38.8,-141.52" /> </g> <g id="node3" class="node"><title>cr0_read_shadow_bitmap</title><polygon fill="none" stroke="black" points="144,-100.5 144,-136.5 248,-136.5 248,-100.5 144,-100.5" /> <text text-anchor="middle" x="157" y="-114.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="170,-100.5 170,-136.5 " /> <text text-anchor="middle" x="183" y="-114.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="196,-100.5 196,-136.5 " /> <text text-anchor="middle" x="209" y="-114.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="222,-100.5 222,-136.5 " /> <text text-anchor="middle" x="235" y="-114.8" font-family="Times,serif" font-size="14.00">1</text> </g> <g id="edge2" class="edge"><title>cr0_host_guest_mask_bitmap:1&#45;&gt;cr0_read_shadow_bitmap:1</title><path fill="none" stroke="black" d="M183,-183.5C183,-166.89 183,-160.4 183,-147.58" /><polygon fill="black" stroke="black" points="186.5,-147.5 183,-137.5 179.5,-147.5 186.5,-147.5" /> </g> <g id="edge3" class="edge"><title>cr0_host_guest_mask_bitmap:2&#45;&gt;cr0_read_shadow_bitmap:2</title><path fill="none" stroke="black" d="M209,-183.5C209,-166.89 209,-160.4 209,-147.58" /><polygon fill="black" stroke="black" points="212.5,-147.5 209,-137.5 205.5,-147.5 212.5,-147.5" /> </g> <g id="edge4" class="edge"><title>cr0_host_guest_mask_bitmap:3&#45;&gt;cr0_read_shadow_bitmap:3</title><path fill="none" stroke="black" d="M235,-183.5C235,-166.89 235,-160.4 235,-147.58" /><polygon fill="black" stroke="black" points="238.5,-147.5 235,-137.5 231.5,-147.5 238.5,-147.5" /> </g> <g id="edge6" class="edge"><title>cr0_read_shadow_bitmap:1&#45;&gt;destination_value:1</title><path fill="none" stroke="black" d="M183,-99.5C183,-82.89 183,-76.4 183,-63.58" /><polygon fill="black" stroke="black" points="186.5,-63.5 183,-53.5 179.5,-63.5 186.5,-63.5" /> </g> <g id="edge7" class="edge"><title>cr0_read_shadow_bitmap:2&#45;&gt;destination_value:2</title><path fill="none" stroke="black" d="M209,-99.5C209,-82.89 209,-76.4 209,-63.58" /><polygon fill="black" stroke="black" points="212.5,-63.5 209,-53.5 205.5,-63.5 212.5,-63.5" /> </g> <g id="edge8" class="edge"><title>cr0_read_shadow_bitmap:3&#45;&gt;destination_value:3</title><path fill="none" stroke="black" d="M235,-99.5C235,-82.89 235,-76.4 235,-63.58" /><polygon fill="black" stroke="black" points="238.5,-63.5 235,-53.5 231.5,-63.5 238.5,-63.5" /> </g> </g> </svg></div><h3 id="write-操作"><span class="me-2">write 操作</span><a href="#write-操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>write to <code class="language-plaintext highlighter-rouge">read shadow</code></ul><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-e91004f4e482ae0d030678a73454dad1" width="484pt" height="348pt" viewBox="0.00 0.00 484.00 348.00"><title>graphviz-e91004f4e482ae0d030678a73454dad1</title><desc> digraph G { subgraph cluster_cr0_host_guest_mask { cr0_host_guest_mask_bitmap [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;0|&lt;2&gt;0|&lt;3&gt;1&quot; ] label=&quot;cr0 host/guest mask&quot; } subgraph cluster_cr0_read_shadow { cr0_read_shadow_bitmap [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;0|&lt;2&gt;0|&lt;3&gt;1&quot; ] label=&quot;cr0 read shadow bitmap&quot; } subgraph cluster_source_value { source_value [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;0|&lt;2&gt;0|&lt;3&gt;0&quot; ] label=&quot;source value&quot; } subgraph cluster_source_value2 { source_value2 [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;0|&lt;2&gt;0|&lt;3&gt;1&quot; ] label=&quot;source value2&quot; } cr0_host_guest_mask_bitmap:3-&gt;source_value:3 [ label=&quot;indicate compare bit&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] cr0_host_guest_mask_bitmap:3-&gt;source_value2:3 [ label=&quot;indicate compare bit&quot; color=&quot;blue&quot; fontcolor=&quot;blue&quot; ] source_value2:3-&gt;cr0_read_shadow_bitmap:3 [ label=&quot;compare equal SKIP&quot; color=&quot;blue&quot; fontcolor=&quot;blue&quot; ] source_value:3-&gt;cr0_read_shadow_bitmap:3 [ label=&quot;compare NOT equal \nvm EXIT, hypervisor \nmay execute some emulations&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 344)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-344 480,-344 480,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_cr0_host_guest_mask</title><polygon fill="none" stroke="black" points="115,-256 115,-332 276,-332 276,-256 115,-256" /> <text text-anchor="middle" x="195.5" y="-316.8" font-family="Times,serif" font-size="14.00">cr0 host/guest mask</text> </g> <g id="clust2" class="cluster"><title>cluster_cr0_read_shadow</title><polygon fill="none" stroke="black" points="58,-8 58,-84 248,-84 248,-8 58,-8" /> <text text-anchor="middle" x="153" y="-68.8" font-family="Times,serif" font-size="14.00">cr0 read shadow bitmap</text> </g> <g id="clust3" class="cluster"><title>cluster_source_value</title><polygon fill="none" stroke="black" points="8,-147 8,-223 128,-223 128,-147 8,-147" /> <text text-anchor="middle" x="68" y="-207.8" font-family="Times,serif" font-size="14.00">source value</text> </g> <g id="clust4" class="cluster"><title>cluster_source_value2</title><polygon fill="none" stroke="black" points="234,-147 234,-223 354,-223 354,-147 234,-147" /> <text text-anchor="middle" x="294" y="-207.8" font-family="Times,serif" font-size="14.00">source value2</text> </g> <g id="node1" class="node"><title>cr0_host_guest_mask_bitmap</title><polygon fill="none" stroke="black" points="123,-264.5 123,-300.5 227,-300.5 227,-264.5 123,-264.5" /> <text text-anchor="middle" x="136" y="-278.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="149,-264.5 149,-300.5 " /> <text text-anchor="middle" x="162" y="-278.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="175,-264.5 175,-300.5 " /> <text text-anchor="middle" x="188" y="-278.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="201,-264.5 201,-300.5 " /> <text text-anchor="middle" x="214" y="-278.8" font-family="Times,serif" font-size="14.00">1</text> </g> <g id="node3" class="node"><title>source_value</title><polygon fill="none" stroke="black" points="16,-155.5 16,-191.5 120,-191.5 120,-155.5 16,-155.5" /> <text text-anchor="middle" x="29" y="-169.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="42,-155.5 42,-191.5 " /> <text text-anchor="middle" x="55" y="-169.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="68,-155.5 68,-191.5 " /> <text text-anchor="middle" x="81" y="-169.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="94,-155.5 94,-191.5 " /> <text text-anchor="middle" x="107" y="-169.8" font-family="Times,serif" font-size="14.00">0</text> </g> <g id="edge1" class="edge"><title>cr0_host_guest_mask_bitmap:3&#45;&gt;source_value:3</title><path fill="none" stroke="red" d="M214,-263.5C214,-237.85 180.82,-259.49 159,-246 133.99,-230.54 112.45,-226.5 107.89,-202.67" /><polygon fill="red" stroke="red" points="111.36,-202.16 107,-192.5 104.38,-202.77 111.36,-202.16" /> <text text-anchor="middle" x="233" y="-234.8" font-family="Times,serif" font-size="14.00" fill="red">indicate compare bit</text> </g> <g id="node4" class="node"><title>source_value2</title><polygon fill="none" stroke="black" points="242,-155.5 242,-191.5 346,-191.5 346,-155.5 242,-155.5" /> <text text-anchor="middle" x="255" y="-169.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="268,-155.5 268,-191.5 " /> <text text-anchor="middle" x="281" y="-169.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="294,-155.5 294,-191.5 " /> <text text-anchor="middle" x="307" y="-169.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="320,-155.5 320,-191.5 " /> <text text-anchor="middle" x="333" y="-169.8" font-family="Times,serif" font-size="14.00">1</text> </g> <g id="edge2" class="edge"><title>cr0_host_guest_mask_bitmap:3&#45;&gt;source_value2:3</title><path fill="none" stroke="blue" d="M228,-282.5C285.98,-282.5 328.01,-257.1 332.59,-202.63" /><polygon fill="blue" stroke="blue" points="336.09,-202.63 333,-192.5 329.09,-202.35 336.09,-202.63" /> <text text-anchor="middle" x="399" y="-234.8" font-family="Times,serif" font-size="14.00" fill="blue">indicate compare bit</text> </g> <g id="node2" class="node"><title>cr0_read_shadow_bitmap</title><polygon fill="none" stroke="black" points="101,-16.5 101,-52.5 205,-52.5 205,-16.5 101,-16.5" /> <text text-anchor="middle" x="114" y="-30.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="127,-16.5 127,-52.5 " /> <text text-anchor="middle" x="140" y="-30.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="153,-16.5 153,-52.5 " /> <text text-anchor="middle" x="166" y="-30.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="179,-16.5 179,-52.5 " /> <text text-anchor="middle" x="192" y="-30.8" font-family="Times,serif" font-size="14.00">1</text> </g> <g id="edge4" class="edge"><title>source_value:3&#45;&gt;cr0_read_shadow_bitmap:3</title><path fill="none" stroke="red" d="M107,-154.5C107,-146.12 101.58,-145.23 100,-137 96.22,-117.36 88.92,-108.65 100,-92 122.35,-58.42 180.23,-90.79 190.45,-63.46" /><polygon fill="red" stroke="red" points="193.92,-63.92 192,-53.5 187,-62.84 193.92,-63.92" /> <text text-anchor="middle" x="208" y="-125.8" font-family="Times,serif" font-size="14.00" fill="red">compare NOT equal </text> <text text-anchor="middle" x="208" y="-110.8" font-family="Times,serif" font-size="14.00" fill="red">vm EXIT, hypervisor </text> <text text-anchor="middle" x="208" y="-95.8" font-family="Times,serif" font-size="14.00" fill="red">may execute some emulations</text> </g> <g id="edge3" class="edge"><title>source_value2:3&#45;&gt;cr0_read_shadow_bitmap:3</title><path fill="none" stroke="blue" d="M333,-154.5C333,-80.33 287.99,-38.38 216.29,-34.76" /><polygon fill="blue" stroke="blue" points="216.08,-31.25 206,-34.5 215.91,-38.25 216.08,-31.25" /> <text text-anchor="middle" x="403.5" y="-110.8" font-family="Times,serif" font-size="14.00" fill="blue">compare equal SKIP</text> </g> </g> </svg></div><ul><li>direct write to CR3</ul><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-ce0fa82903fbaa57303151b692d88cc2" width="287pt" height="427pt" viewBox="0.00 0.00 287.00 427.00"><title>graphviz-ce0fa82903fbaa57303151b692d88cc2</title><desc> digraph G { subgraph cluster_cr0_host_guest_mask { cr0_host_guest_mask_bitmap [ shape=&quot;record&quot; label=&quot;&lt;0&gt;0|&lt;1&gt;0|&lt;2&gt;0|&lt;3&gt;1&quot; ] label=&quot;cr0 host/guest mask&quot; } subgraph cluster_source_value { source_value [ shape=&quot;record&quot; label=&quot;&lt;0&gt;1|&lt;1&gt;0|&lt;2&gt;1|&lt;3&gt;0&quot; ] label=&quot;source value&quot; } subgraph cluster_beg_write_cr0 { cr0_beg_w [ shape=&quot;record&quot; label=&quot;&lt;0&gt;x|&lt;1&gt;x|&lt;2&gt;x|&lt;3&gt;x&quot; ] label=&quot;cr0 beg write&quot; } subgraph cluster_end_write_cr0 { cr0_end_w [ shape=&quot;record&quot; label=&quot;&lt;0&gt;1|&lt;1&gt;0|&lt;2&gt;1|&lt;3&gt;x&quot; ] label=&quot;cr0 : end write&quot; } cr0_host_guest_mask_bitmap:0-&gt;source_value:0 cr0_host_guest_mask_bitmap:1-&gt;source_value:1 cr0_host_guest_mask_bitmap:2-&gt;source_value:2 [ label=&quot;indicate write direct cr0 bit&quot; ] source_value:0-&gt;cr0_beg_w:0 source_value:1-&gt;cr0_beg_w:1 source_value:2-&gt;cr0_beg_w:2 [ label=&quot;write&quot; ] cr0_beg_w:0-&gt;cr0_end_w:0 cr0_beg_w:1-&gt;cr0_end_w:1 cr0_beg_w:2-&gt;cr0_end_w:2 [ label=&quot;write success&quot; ] } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 423)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-423 283,-423 283,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_cr0_host_guest_mask</title><polygon fill="none" stroke="black" points="8,-335 8,-411 169,-411 169,-335 8,-335" /> <text text-anchor="middle" x="88.5" y="-395.8" font-family="Times,serif" font-size="14.00">cr0 host/guest mask</text> </g> <g id="clust2" class="cluster"><title>cluster_source_value</title><polygon fill="none" stroke="black" points="8,-226 8,-302 128,-302 128,-226 8,-226" /> <text text-anchor="middle" x="68" y="-286.8" font-family="Times,serif" font-size="14.00">source value</text> </g> <g id="clust3" class="cluster"><title>cluster_beg_write_cr0</title><polygon fill="none" stroke="black" points="9,-117 9,-193 125,-193 125,-117 9,-117" /> <text text-anchor="middle" x="67" y="-177.8" font-family="Times,serif" font-size="14.00">cr0 beg write</text> </g> <g id="clust4" class="cluster"><title>cluster_end_write_cr0</title><polygon fill="none" stroke="black" points="8,-8 8,-84 130,-84 130,-8 8,-8" /> <text text-anchor="middle" x="69" y="-68.8" font-family="Times,serif" font-size="14.00">cr0 : end write</text> </g> <g id="node1" class="node"><title>cr0_host_guest_mask_bitmap</title><polygon fill="none" stroke="black" points="16,-343.5 16,-379.5 120,-379.5 120,-343.5 16,-343.5" /> <text text-anchor="middle" x="29" y="-357.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="42,-343.5 42,-379.5 " /> <text text-anchor="middle" x="55" y="-357.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="68,-343.5 68,-379.5 " /> <text text-anchor="middle" x="81" y="-357.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="94,-343.5 94,-379.5 " /> <text text-anchor="middle" x="107" y="-357.8" font-family="Times,serif" font-size="14.00">1</text> </g> <g id="node2" class="node"><title>source_value</title><polygon fill="none" stroke="black" points="16,-234.5 16,-270.5 120,-270.5 120,-234.5 16,-234.5" /> <text text-anchor="middle" x="29" y="-248.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="42,-234.5 42,-270.5 " /> <text text-anchor="middle" x="55" y="-248.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="68,-234.5 68,-270.5 " /> <text text-anchor="middle" x="81" y="-248.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="94,-234.5 94,-270.5 " /> <text text-anchor="middle" x="107" y="-248.8" font-family="Times,serif" font-size="14.00">0</text> </g> <g id="edge1" class="edge"><title>cr0_host_guest_mask_bitmap:0&#45;&gt;source_value:0</title><path fill="none" stroke="black" d="M29,-342.5C29,-314.64 29,-305.23 29,-281.69" /><polygon fill="black" stroke="black" points="32.5,-281.5 29,-271.5 25.5,-281.5 32.5,-281.5" /> </g> <g id="edge2" class="edge"><title>cr0_host_guest_mask_bitmap:1&#45;&gt;source_value:1</title><path fill="none" stroke="black" d="M55,-342.5C55,-314.64 55,-305.23 55,-281.69" /><polygon fill="black" stroke="black" points="58.5,-281.5 55,-271.5 51.5,-281.5 58.5,-281.5" /> </g> <g id="edge3" class="edge"><title>cr0_host_guest_mask_bitmap:2&#45;&gt;source_value:2</title><path fill="none" stroke="black" d="M81,-342.5C81,-314.64 81,-305.23 81,-281.69" /><polygon fill="black" stroke="black" points="84.5,-281.5 81,-271.5 77.5,-281.5 84.5,-281.5" /> <text text-anchor="middle" x="180" y="-313.8" font-family="Times,serif" font-size="14.00">indicate write direct cr0 bit</text> </g> <g id="node3" class="node"><title>cr0_beg_w</title><polygon fill="none" stroke="black" points="17,-125.5 17,-161.5 117,-161.5 117,-125.5 17,-125.5" /> <text text-anchor="middle" x="29.5" y="-139.8" font-family="Times,serif" font-size="14.00">x</text><polyline fill="none" stroke="black" points="42,-125.5 42,-161.5 " /> <text text-anchor="middle" x="54.5" y="-139.8" font-family="Times,serif" font-size="14.00">x</text><polyline fill="none" stroke="black" points="67,-125.5 67,-161.5 " /> <text text-anchor="middle" x="79.5" y="-139.8" font-family="Times,serif" font-size="14.00">x</text><polyline fill="none" stroke="black" points="92,-125.5 92,-161.5 " /> <text text-anchor="middle" x="104.5" y="-139.8" font-family="Times,serif" font-size="14.00">x</text> </g> <g id="edge4" class="edge"><title>source_value:0&#45;&gt;cr0_beg_w:0</title><path fill="none" stroke="black" d="M29,-233.5C29,-205.64 29,-196.23 29,-172.69" /><polygon fill="black" stroke="black" points="32.5,-172.5 29,-162.5 25.5,-172.5 32.5,-172.5" /> </g> <g id="edge5" class="edge"><title>source_value:1&#45;&gt;cr0_beg_w:1</title><path fill="none" stroke="black" d="M55,-233.5C55,-205.64 54.22,-196.23 54.04,-172.7" /><polygon fill="black" stroke="black" points="57.54,-172.49 54,-162.5 50.54,-172.51 57.54,-172.49" /> </g> <g id="edge6" class="edge"><title>source_value:2&#45;&gt;cr0_beg_w:2</title><path fill="none" stroke="black" d="M81,-233.5C81,-205.64 80.22,-196.23 80.04,-172.7" /><polygon fill="black" stroke="black" points="83.54,-172.49 80,-162.5 76.54,-172.51 83.54,-172.49" /> <text text-anchor="middle" x="99" y="-204.8" font-family="Times,serif" font-size="14.00">write</text> </g> <g id="node4" class="node"><title>cr0_end_w</title><polygon fill="none" stroke="black" points="16.5,-16.5 16.5,-52.5 119.5,-52.5 119.5,-16.5 16.5,-16.5" /> <text text-anchor="middle" x="29.5" y="-30.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="42.5,-16.5 42.5,-52.5 " /> <text text-anchor="middle" x="55.5" y="-30.8" font-family="Times,serif" font-size="14.00">0</text><polyline fill="none" stroke="black" points="68.5,-16.5 68.5,-52.5 " /> <text text-anchor="middle" x="81.5" y="-30.8" font-family="Times,serif" font-size="14.00">1</text><polyline fill="none" stroke="black" points="94.5,-16.5 94.5,-52.5 " /> <text text-anchor="middle" x="107" y="-30.8" font-family="Times,serif" font-size="14.00">x</text> </g> <g id="edge7" class="edge"><title>cr0_beg_w:0&#45;&gt;cr0_end_w:0</title><path fill="none" stroke="black" d="M29,-124.5C29,-96.64 29,-87.23 29,-63.69" /><polygon fill="black" stroke="black" points="32.5,-63.5 29,-53.5 25.5,-63.5 32.5,-63.5" /> </g> <g id="edge8" class="edge"><title>cr0_beg_w:1&#45;&gt;cr0_end_w:1</title><path fill="none" stroke="black" d="M54,-124.5C54,-96.64 54.78,-87.23 54.96,-63.7" /><polygon fill="black" stroke="black" points="58.46,-63.51 55,-53.5 51.46,-63.49 58.46,-63.51" /> </g> <g id="edge9" class="edge"><title>cr0_beg_w:2&#45;&gt;cr0_end_w:2</title><path fill="none" stroke="black" d="M80,-124.5C80,-96.63 81.56,-87.24 81.92,-63.7" /><polygon fill="black" stroke="black" points="85.43,-63.53 82,-53.5 78.43,-63.47 85.43,-63.53" /> <text text-anchor="middle" x="128.5" y="-95.8" font-family="Times,serif" font-size="14.00">write success</text> </g> </g> </svg></div><blockquote class="prompt-tip"><p>上面是 MOV from CR0的大概流程</p><p>这里需要注意的是, <code class="language-plaintext highlighter-rouge">cr0 host/guest mask</code>能决定的是</p><ul><li>MOV from CR0 的这些bit 从哪个地方获取:<ul><li>CR0<li>CR0 read shadow</ul><li>MOV to CR0, 要不要VM exit.<ul><li>如果修改了 cr0 host/guest mask中bit对应的 read shadow, 是一定要vm exit.<li>当然 在 VMX OPERATION中CR0还有一些限制, 不满足这些限制也会 VM exit.</ul></ul><p>这里需要思考下</p><p>Q: 为什么要这样设计?</p><p>A: 为的就是对CR0 的某些bit进行软件(hypervisor)上的虚拟化.</p><p>Q: 怎么控制虚拟化哪些呢?</p><p>A: 虚拟化 <code class="language-plaintext highlighter-rouge">cr0 host/guest mask</code>为1 的bit.</p><ul><li><strong>read</strong> from read shadow<li><strong>write</strong> cause VM-exit<li>other bit normal read/write to CR0</ul></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/intel-sdm/">intel_sdm</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/virt/" class="post-tag no-text-decoration" >virt</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=virtualization%20cr0%20-%20one%20step%20at%20a%20time&url=%2Fposts%2Fvirtualization-cr0%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=virtualization%20cr0%20-%20one%20step%20at%20a%20time&u=%2Fposts%2Fvirtualization-cr0%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fvirtualization-cr0%2F&text=virtualization%20cr0%20-%20one%20step%20at%20a%20time" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/dirty-tracking/">dirty tracking</a><li class="text-truncate lh-lg"> <a href="/posts/vfio/">vfio</a><li class="text-truncate lh-lg"> <a href="/posts/host-bridge/">host-bridge is pci device BUT NOT pci bridge</a><li class="text-truncate lh-lg"> <a href="/posts/wbinvd-emulate/">emulate wbinvd</a><li class="text-truncate lh-lg"> <a href="/posts/pci_bridge/">qemu brige migration</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/apic-timer/">apic-timer</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-bitmap/">dirty-bitmap</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/vm86/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713753000" data-df="ll" > Apr 22, 2024 </time><h4 class="pt-0 my-2">vm86</h4><div class="text-muted"><p>FROM intel sdm chapter 21 8086 emulation abstract IA-32 processors (beginning with the Intel386 processor) provide two ways to execute new or legacy programs that are assembled and/or compiled t...</p></div></div></a></article><article class="col"> <a href="/posts/pml/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713841200" data-df="ll" > Apr 23, 2024 </time><h4 class="pt-0 my-2">protected-mode memory management</h4><div class="text-muted"><p>29.3.6 Page-Modification Logging When accessed and dirty flags for EPT are enabled, software can track writes to guest-physical addresses using a feature called page-modification logging. 当启用了...</p></div></div></a></article><article class="col"> <a href="/posts/proctected-mode/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713841200" data-df="ll" > Apr 23, 2024 </time><h4 class="pt-0 my-2">protected-mode memory management</h4><div class="text-muted"><p>FROM intel sdm CHAPTER 3 PROTECTED-MODE MEMORY MANAGEMENT abstract This chapter describes the Intel 64 and IA-32 architecture’s protected-mode memory management facilities, including the phys...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/proctected-mode/" class="btn btn-outline-primary" aria-label="Older" ><p>protected-mode memory management</p></a> <a href="/posts/user-timer/" class="btn btn-outline-primary" aria-label="Newer" ><p>user-timer event and interrupt</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/fuqiang_cai">fuqiang wang</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v6.5.5" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/apic-timer/">apic-timer</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-bitmap/">dirty-bitmap</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
