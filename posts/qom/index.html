<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="qemu qom" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="本篇文章，我们主要以edu device 为例，来看一下 qom的框架." /><meta property="og:description" content="本篇文章，我们主要以edu device 为例，来看一下 qom的框架." /><link rel="canonical" href="/posts/qom/" /><meta property="og:url" content="/posts/qom/" /><meta property="og:site_name" content="one step at a time" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-10-11T19:27:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="qemu qom" /><meta name="twitter:site" content="@fuqiang_cai" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2024-10-11T19:27:00+08:00","datePublished":"2024-10-11T19:27:00+08:00","description":"本篇文章，我们主要以edu device 为例，来看一下 qom的框架.","headline":"qemu qom","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/qom/"},"url":"/posts/qom/"}</script><title>qemu qom | one step at a time</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="one step at a time"><meta name="application-name" content="one step at a time"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"></a><h1 class="site-title"> <a href="/">one step at a time</a></h1><p class="site-subtitle fst-italic mb-0">a noob's growing diary</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cai-fuqiang" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fuqiang_cai" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['iwng86','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>qemu qom</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>qemu qom</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1728646020" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Oct 11, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3724 words" > <em>20 min</em> read</span></div></div></div></header><div class="content"><p>本篇文章，我们主要以edu device 为例，来看一下 qom的框架.</p><blockquote class="prompt-tip"><p>edu device 的代码在 <code class="language-plaintext highlighter-rouge">hw/misc/edu.c</code></p></blockquote><h2 id="简介"><span class="me-2">简介</span><a href="#简介" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>QOM 全称 QEMU Object Model, 是QEMU 使用面向对象的方式来进行抽象 设计。面向对象包括封装，继承与多态。而qom就是根据自己自身的需求， 设计的一套面向对象的框架。</p><p>面向对象的几个概念:</p><ul><li>封装: 将数据和操作封装在对象中，隐藏内部细节<li>继承: 子类可以继承父类的属性和方法，重用代码<li>多态: 对象可以根据具体类型表现不同行为，通过相同接口调用不同实现，提高灵活性和可扩展性。</ul><p>我们会在下面的流程中讲解到qom是如何针对上面三种面向对象的特性进行设计的。</p><blockquote class="prompt-tip"><p>本文主要参考的书籍是 <code class="language-plaintext highlighter-rouge">&lt;&lt;QEMU-KVM 源码解析与应用&gt;&gt; 李强</code>, 该书集写的 很详细，本文主要是根据书中的思路做了一些笔记，以及调试过程。</p></blockquote><h2 id="qom的class-instance-interface-type-object"><span class="me-2">QOM的class, instance, interface, type, object</span><a href="#qom的class-instance-interface-type-object" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我们知道C++有class和Object, class是面向对象的 type, 可以使用具体的 class来创建实例化的object。</p><p>而QOM 则有点区别, 增加了一层type，需要使用type来实例化object, 而 type又包含可以包含class，instance和interface，我们来解释下.</p><ul><li><p>class</p><p>只是针对某一类object抽象出具有共同特征的封装集合。个人认为主要 是包含了一些方法和该类型的”const public”部分。”const public” 如何理 解呢，例如对于edu设备类型，其<code class="language-plaintext highlighter-rouge">vendor_id</code>, <code class="language-plaintext highlighter-rouge">device_id</code> 都是一样的， 所以就可以把这些成员定义到class中, class一旦 initialize, 就无需在修改。 使用不同的object 实例可以引用一个 class. (当然 方法我们也可以这样认为).</p><li><p>instance</p><p>而instance不同，instance 是每个object的 private结构，每个object可以根据 自己的信息自定义该部分，例如对于edu device来说, 其<code class="language-plaintext highlighter-rouge">io_region</code>, <code class="language-plaintext highlighter-rouge">irq_state</code> 都属于instance.</p><li><p>interface</p><p>interface是qom一个比较难琢磨的部分，以下是我个人理解。个人认为interface部分， 实际上体现了QOM中对于多态的面向对象的实现。可以实现用父类class，来调用子类 的function. 当然，子类也可以区别与父类，定义自己的interface。区别于class中的 function，class中的function，必须定位到其具体的class层，例如PCIDeviceClass, 才可以找到其中的<code class="language-plaintext highlighter-rouge">realize()</code>方法</p><li><p>type</p><p>type其实才是QOM中的类似于C++的class，其综合了上面三种数据结构。可以用type来 进行object相关操作，例如new, destroy.</p><li><p>object</p><p>具体的对象实例.</p></ul><p>大家可以想一下，C++做到这些事情是比较简单的，直接按照语法定义好class，编译器会 帮忙做这些事情。而QOM 不同，需要自己实现。</p><p>所以, 我们需要关注下， 这些type 是如何注册，并且初始化好的，然后我们在来介绍下， 如何用type来实例化object, 如下图所示:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>
+--------------+    +------ type_init
|type的注册    +----+------ register_module_init
+--------------+    +------ type_register

+--------------+
|type的初始化  +----------- type_initialize
+--------------+

+--------------+    +------- object_new
|object的初始化+----+------- object_initialize
+--------------+    +------- object_init_with_type
</pre></table></code></div></div><h2 id="类型注册"><span class="me-2">类型注册</span><a href="#类型注册" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">MODULE_INIT_MIGRATION</span><span class="p">,</span>
    <span class="n">MODULE_INIT_BLOCK</span><span class="p">,</span>
    <span class="n">MODULE_INIT_OPTS</span><span class="p">,</span>
    <span class="n">MODULE_INIT_QOM</span><span class="p">,</span>
    <span class="n">MODULE_INIT_TRACE</span><span class="p">,</span>
    <span class="n">MODULE_INIT_XEN_BACKEND</span><span class="p">,</span>
    <span class="n">MODULE_INIT_LIBQOS</span><span class="p">,</span>
    <span class="n">MODULE_INIT_FUZZ_TARGET</span><span class="p">,</span>
    <span class="n">MODULE_INIT_MAX</span>
<span class="p">}</span> <span class="n">module_init_type</span><span class="p">;</span>
</pre></table></code></div></div><p>类型注册相关函数, 早于main执行</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Breakpoint 4, do_qemu_init_pci_edu_register_types <span class="o">()</span> at ../hw/misc/edu.c:442
442     type_init<span class="o">(</span>pci_edu_register_types<span class="o">)</span>
<span class="o">(</span>gdb<span class="o">)</span> bt
<span class="c">#0  do_qemu_init_pci_edu_register_types () at ../hw/misc/edu.c:442</span>
<span class="c">#1  0x00007ffff67f3cc4 in __libc_start_main_impl () at /lib64/libc.so.6</span>
<span class="c">#2  0x0000555555884885 in _start ()</span>
</pre></table></code></div></div><h3 id="init-流程"><span class="me-2">init 流程</span><a href="#init-流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>_start
   =&gt; __libc_start_main_imp
      =&gt; foreach constructor:
      {
         do_qemu_init_pci_edu_register_types
            =&gt; register_module_init
               =&gt; alloc ModuleEntry
               =&gt; init it
               {
                 e-&gt;init
                 e-&gt;type
               }
               =&gt; link to init_type_list[e-&gt;type] list
      }
main
   =&gt; qemu_init
      =&gt; qemu_init_subsystems
         =&gt; module_call_init(MODULE_INIT_QOM)
            =&gt; foreach_list init_type_list[MODULE_INIT_QOM]
            {
               e-&gt;init(): pci_edu_register_types
            }
</pre></table></code></div></div><h3 id="pci_edu_register_types"><span class="me-2">pci_edu_register_types</span><a href="#pci_edu_register_types" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>pci_edu_register_types
=&gt; define : TypeInfo edu_info
=&gt; type_register_static
   =&gt; type_register
       =&gt; type_register_internal
          =&gt; type_new  :return TypeImpl* ti
             =&gt; {
                   alloc TypeInfo ti
                   ti-&gt;name = "edu"
                   ti-&gt;parent = "pci-device"
                   ...
                }
          =&gt; type_table_add
</pre></table></code></div></div><h2 id="类型初始化"><span class="me-2">类型初始化</span><a href="#类型初始化" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="type_initialize"><span class="me-2">type_initialize</span><a href="#type_initialize" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>type_initialize
   =&gt; alloc_class {
         init: ti-&gt;class_size:                 ## if not define, get parent 's class size
         init: ti-&gt;instance_size: 
         ti-&gt;class = g_malloc0(ti-&gt;class_size) alloc class
      }
   =&gt; init_class {
      如果是祖先interface type, 则需要判断一些东西， 
         例如instance_size必须是0
         abstract 必须是1 等等

   =&gt; init_parent_type and copy_class_from_parent 
   {
      =&gt; type_initialize(parent) :            ## 递归
      =&gt; memcpy(ti-&gt;class, parent-&gt;class, parent-&gt;class_size)   ## copy parent class
      =&gt; init_interface                       ## 这块逻辑有点怪，我们在后面贴下具体代码
   }
   =&gt; init properties: g_hash_table_new_full(g_str_hash, g_str_equal, NULL, object_property_free);
   =&gt; ti-&gt;class-&gt;type = ti                    ## 设置该class的type

   =&gt; while (parent = parent-&gt;parent) 
      parent-&gt;class_base_init()               ## 递归循环
   =&gt; ti-&gt;class_init()
}
</pre></table></code></div></div><p>该部分的逻辑是初始化TypeImpl, 其实主要的是初始化ti-&gt;class 和 interface , 在初始化本type的class时， 首先要将class-&gt;parent 初始化，以及其 class 的interface初始化.</p><p>我们展开下和interface相关的代码, 在看<code class="language-plaintext highlighter-rouge">type_initialize</code>相关代码之前， 我们先看下<code class="language-plaintext highlighter-rouge">type_initialize_interface</code></p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">type_initialize_interface</span><span class="p">(</span><span class="n">TypeImpl</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">interface_type</span><span class="p">,</span>
                                      <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">parent_type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">InterfaceClass</span> <span class="o">*</span><span class="n">new_iface</span><span class="p">;</span>
    <span class="n">TypeInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
    <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">iface_impl</span><span class="p">;</span>

    <span class="n">info</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="n">info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">g_strdup_printf</span><span class="p">(</span><span class="s">"%s::%s"</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">interface_type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">info</span><span class="p">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="n">iface_impl</span> <span class="o">=</span> <span class="n">type_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
    <span class="n">iface_impl</span><span class="o">-&gt;</span><span class="n">parent_type</span> <span class="o">=</span> <span class="n">parent_type</span><span class="p">;</span>
    <span class="n">type_initialize</span><span class="p">(</span><span class="n">iface_impl</span><span class="p">);</span>
    <span class="n">g_free</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

    <span class="n">new_iface</span> <span class="o">=</span> <span class="p">(</span><span class="n">InterfaceClass</span> <span class="o">*</span><span class="p">)</span><span class="n">iface_impl</span><span class="o">-&gt;</span><span class="k">class</span><span class="p">;</span>
    <span class="n">new_iface</span><span class="o">-&gt;</span><span class="n">concrete_class</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="k">class</span><span class="p">;</span>
    <span class="n">new_iface</span><span class="o">-&gt;</span><span class="n">interface_type</span> <span class="o">=</span> <span class="n">interface_type</span><span class="p">;</span>

    <span class="n">ti</span><span class="o">-&gt;</span><span class="k">class</span><span class="o">-&gt;</span><span class="n">interfaces</span> <span class="o">=</span> <span class="n">g_slist_append</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="k">class</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">new_iface</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>该函数的作用是, get and init该interface的 <code class="language-plaintext highlighter-rouge">TypeImpl</code>, 需要做的动作大概是:</p><ul><li>init a TypeInfo<ul><li>TypeInfo.name = “ti-&gt;name::interface_type-&gt;name”<li><p>Type.parent = parent_type-&gt;name</p><p>eg</p><ul><li><code class="language-plaintext highlighter-rouge">interface_type-&gt;name = vmstate-if</code><li><code class="language-plaintext highlighter-rouge">ti-&gt;name = cpu</code><li><code class="language-plaintext highlighter-rouge">interface_type-&gt;name = device::vmstate-if</code><li><code class="language-plaintext highlighter-rouge">TypeInfo.name = cpu::vmsate-if</code><li><code class="language-plaintext highlighter-rouge">TypeInfo.parent = device::vmsate-if</code></ul></ul><p>这样来看，是不是就有面向对象编程中，interface的作用了， 如果底层有对interface的实现，则给他覆盖，而且能够实现对父类的覆盖</p><li>alloc TypeImpl : type_new(TypeInfo)<li>type_initialize(iface_impl)<li>init InterfaceClass<ul><li>concrete_clas = ti-&gt;class<li>interface_type = interface_type</ul><li>将新分配的 interface 加入到 <code class="language-plaintext highlighter-rouge">ti-&gt;class-&gt;interfaces</code></ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">type_initialize</span><span class="p">(</span><span class="n">TypeImpl</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
		<span class="p">...</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">type_get_parent</span><span class="p">(</span><span class="n">ti</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
				<span class="c1">//===(1)===</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="k">class</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">;</span> <span class="n">e</span><span class="p">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">InterfaceClass</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
            <span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span> <span class="o">=</span> <span class="n">OBJECT_CLASS</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

            <span class="n">type_initialize_interface</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">interface_type</span><span class="p">,</span> <span class="n">klass</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">num_interfaces</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">type_get_by_name</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="k">typename</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">error_report</span><span class="p">(</span><span class="s">"missing interface '%s' for object '%s'"</span><span class="p">,</span>
                             <span class="n">ti</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="k">typename</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="n">abort</span><span class="p">();</span>
            <span class="p">}</span>
						<span class="c1">//===(2)===</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="k">class</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">;</span> <span class="n">e</span><span class="p">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">target_type</span> <span class="o">=</span> <span class="n">OBJECT_CLASS</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">type_is_ancestor</span><span class="p">(</span><span class="n">target_type</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

						<span class="c1">//===(2.1)===</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//===(3)===</span>
            <span class="n">type_initialize_interface</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
		<span class="p">...</span>
<span class="p">}</span> 
</pre></table></code></div></div><ol><li>调用查看<code class="language-plaintext highlighter-rouge">parent-&gt;class-&gt;interfaces</code>, 然后，根据parent interface，来init 当前<code class="language-plaintext highlighter-rouge">ti-&gt;class-&gt;interface</code><li>查看当前的<code class="language-plaintext highlighter-rouge">ti-&gt;interfaces</code>, 然后和<code class="language-plaintext highlighter-rouge">ti-&gt;class-&gt;interfaces</code>中的每个进行对比， 判断是否在（1）过程中添加过，如果添加过，则不需要再添加（2.1)<li>执行到这里，说明ti中定义了新的interface，在父类中没有定义过，所以这里<code class="language-plaintext highlighter-rouge">parent_type:arg3</code> 传递的仍然是t</ol><h3 id="edu-class-init"><span class="me-2">edu class init</span><a href="#edu-class-init" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">edu_class_init</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="k">class</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DeviceClass</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">DEVICE_CLASS</span><span class="p">(</span><span class="k">class</span><span class="p">);</span>
    <span class="n">PCIDeviceClass</span> <span class="o">*</span><span class="n">k</span> <span class="o">=</span> <span class="n">PCI_DEVICE_CLASS</span><span class="p">(</span><span class="k">class</span><span class="p">);</span>

    <span class="n">k</span><span class="o">-&gt;</span><span class="n">realize</span> <span class="o">=</span> <span class="n">pci_edu_realize</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">pci_edu_uninit</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_QEMU</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="mh">0x11e8</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">=</span> <span class="n">PCI_CLASS_OTHERS</span><span class="p">;</span>
    <span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_CATEGORY_MISC</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">categories</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>因为<code class="language-plaintext highlighter-rouge">edu</code> 这里 初始化 其父类，<code class="language-plaintext highlighter-rouge">PCIDeviceClass</code> 和 父类的父类<code class="language-plaintext highlighter-rouge">DeviceClass</code>, 的部分成员。并将<code class="language-plaintext highlighter-rouge">k-&gt;realize</code>赋值为<code class="language-plaintext highlighter-rouge">pci_edu_realize</code></p><p>下面展示<code class="language-plaintext highlighter-rouge">DEVICE_CLASS</code>宏, 我们看下如果通过当前的<code class="language-plaintext highlighter-rouge">ObjectClass</code>，找到相应的父类</p><blockquote class="prompt-tip"><p>ObjectClass: 实际上是对所有类的抽象，其ObjectClass-&gt;type 指向的是当前类 的类型, 我们将此处的class认定为当前class（edu class), device class是其 父类</p></blockquote><details open=""> <summary>DEVICE_CLASS 展开, 以edu为例</summary><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">DEVICE_CLASS</span> <span class="o">:</span> <span class="k">this</span> <span class="n">is</span> <span class="n">a</span> <span class="k">static</span> <span class="n">function</span><span class="p">,</span> <span class="n">declare</span> <span class="n">here</span><span class="o">:</span>

<span class="n">OBJECT_DECLARE_TYPE</span><span class="p">(</span><span class="n">DeviceState</span><span class="p">,</span> <span class="n">DeviceClass</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">)</span>

<span class="n">OBJECT_DECLARE_TYPE</span><span class="p">(</span><span class="n">InstanceType</span><span class="o">:</span><span class="n">DeviceState</span><span class="p">,</span> <span class="n">ClassType</span><span class="o">:</span><span class="n">DeviceClass</span><span class="p">,</span> <span class="n">MODULE_OBJ_NAME</span><span class="o">:</span><span class="n">DEVICE</span><span class="p">)</span>
  <span class="o">=&gt;</span> <span class="n">DECLARE_OBJ_CHECKERS</span><span class="p">(</span><span class="n">InstanceType</span><span class="o">:</span><span class="n">DeviceState</span><span class="p">,</span> <span class="n">ClassType</span><span class="o">:</span><span class="n">DeviceClass</span><span class="p">,</span> <span class="n">MODULE_OBJ_NAME</span><span class="o">:</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">TYPE_</span><span class="err">##</span><span class="n">MODLE_OBJ_NAME</span><span class="o">:</span><span class="n">TYPE_DEVICE</span><span class="p">)</span>
     <span class="o">=&gt;</span> <span class="n">DECLARE_CLASS_CHECKERS</span><span class="p">(</span><span class="n">ClassType</span><span class="o">:</span><span class="n">DeviceClass</span><span class="p">,</span> <span class="n">OBJ_NAME</span><span class="o">:</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">TYPENAME</span><span class="o">:</span><span class="n">TYPE_DEVICE</span><span class="p">)</span>
        <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="k">static</span> <span class="kr">inline</span> <span class="n">DeviceClass</span> <span class="o">*</span> <span class="n">DEVICE_GET_CLASS</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
              <span class="p">{</span>
                 <span class="k">return</span> <span class="n">OBJECT_GET_CLASS</span><span class="p">(</span><span class="n">DeviceClass</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">TYPE_DEVICE</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">static</span> <span class="kr">inline</span> <span class="n">DeviceClass</span> <span class="o">*</span> <span class="nf">DEVICE_CLASS</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">klass</span><span class="p">)</span> 
              <span class="p">{</span>
                 <span class="k">return</span> <span class="n">OBJECT_CLASS_CHECK</span><span class="p">(</span><span class="n">DeviceClass</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span>  <span class="n">TYPE_DEVICE</span><span class="p">);</span>
              <span class="p">}</span>
           <span class="p">}</span> 
<span class="cp">#define OBJECT_CLASS_CHECK(class_type, class, name) \
    ((class_type *)object_class_dynamic_cast_assert(OBJECT_CLASS(class), (name), \
                                               __FILE__, __LINE__, __func__))
</span>
    <span class="p">(</span><span class="n">DeviceClass</span> <span class="o">*</span><span class="p">)</span><span class="n">object_class_dynamic_cast_assert</span><span class="p">(</span><span class="n">Objectclass</span> <span class="o">*</span><span class="k">class</span><span class="p">,</span> <span class="s">"device"</span><span class="p">,</span> <span class="p">...)</span>
</pre></table></code></div></div><p>可以看到，如果调用<code class="language-plaintext highlighter-rouge">DEVICE_CLASS(class)</code>, 先把<code class="language-plaintext highlighter-rouge">class</code>强转未<code class="language-plaintext highlighter-rouge">ObjectClass</code>, 然后调用 <code class="language-plaintext highlighter-rouge">object_class_dynamic_cast_assert</code>, 然后最终返回<code class="language-plaintext highlighter-rouge">DeviceClass *</code>, 我们来看下具体调用:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>object_class_dynamic_cast_assert
   =&gt; object_class_dynamic_cast
      =&gt; type = class-&gt;type										## 获取该类的 TypeImpl
      =&gt; target_type = type_get_by_name() 		## 首先根据typename获取TypeImpl
      =&gt; 查看type所在的class是否有interfaces，如果有，查看target_type是否是interface类型
        =&gt; Y: 遍历class-&gt;interfaces 链表，看看哪个interface是target_type
              的子类型(type_is_ancestor)，如果是则说明找到了, 可以强转
        =&gt; N: 说明target_type不是interface
      =&gt; 查看target_type 是不是该type的父类型(type_is_ancestor), 如果是，则说明找到了，可以强转
   =&gt; 如果发现可以强转，返回 object, 如果发现不能强转，则返回NULL
</pre></table></code></div></div><p>所以<code class="language-plaintext highlighter-rouge">DEVICE_CLASS</code>作用是， 判断传入的class查看是否是继承的<code class="language-plaintext highlighter-rouge">DeviceClass</code>， 如果是则进行强转 <code class="language-plaintext highlighter-rouge">(DeviceClass *) class</code>, 如果不是， 则返回NULL</p></details><h2 id="object-初始化"><span class="me-2">object 初始化</span><a href="#object-初始化" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>现在注册好了类型，如果我们在qemu命令行执行<code class="language-plaintext highlighter-rouge">-device edu</code>, qemu则会使用前面定义好的类型 来创建一个object</p><p>以edu为例，在下面的流程中，会执行对该edu device的初始化:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>main
 qemu_init
  qmp_x_exit_preconfig
   qemu_create_cli_devices
    qemu_opts_foreach
     device_init_func
</pre></table></code></div></div><p>简单看下<code class="language-plaintext highlighter-rouge">device_init_func</code>流程</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>device_init_func<span class="o">(</span>QDict <span class="k">*</span>opts, ...<span class="o">)</span>        <span class="c"># opts 和字典相关，</span>
<span class="o">=&gt;</span> driver <span class="o">=</span> qdict_get_try_str<span class="o">(</span>opts, <span class="s2">"driver"</span><span class="o">)</span>      <span class="c"># 通过opts查询 driver, 返回"edu"</span>
<span class="o">=&gt;</span> qdev_get_device_class<span class="o">(</span>&amp;driver, errp<span class="o">)</span>   <span class="c"># 通过"edu"找到其class， 转换为DeviceClass</span>
<span class="o">=&gt;</span> path <span class="o">=</span> qdict_get_try_str<span class="o">(</span>opts, <span class="s2">"bus"</span><span class="o">)</span><span class="p">;</span> <span class="c"># 找到bus</span>
<span class="o">=&gt;</span> dev <span class="o">=</span> qdev_new<span class="o">(</span>driver<span class="o">)</span><span class="p">;</span>
   <span class="o">=&gt;</span> ObjectClass <span class="k">*</span>oc <span class="o">=</span> object_class_by_name<span class="o">(</span>edu<span class="o">)</span>  <span class="c"># 找到edu 的class</span>
   <span class="o">=&gt;</span> <span class="k">return </span>DEVICE<span class="o">(</span>object_new<span class="o">(</span>name<span class="o">))</span><span class="p">;</span>    <span class="c"># 调用object_new , 然后强转为DeviceState实例</span>
<span class="o">=&gt;</span> dev-&gt;opts <span class="o">=</span> qdict_clone_shallow<span class="o">(</span>opts<span class="o">)</span><span class="p">;</span>
<span class="o">=&gt;</span> object_set_properties_from_keyval<span class="o">()</span>
<span class="o">=&gt;</span> qdev_realize<span class="o">(</span>DEVICE<span class="o">(</span>dev<span class="o">)</span>, bus, errp<span class="o">)</span>   <span class="c"># 对该device实例化</span>
   <span class="o">=&gt;</span> qdev_set_parent_bus<span class="o">(</span>dev, bus, errp<span class="o">)</span><span class="p">;</span> <span class="c"># 设置parent_bus</span>
   <span class="o">=&gt;</span> object_property_set_bool<span class="o">(</span>OBJECT<span class="o">(</span>dev<span class="o">)</span>, <span class="s2">"realized"</span>, <span class="nb">true</span>, errp<span class="o">)</span><span class="p">;</span>
      <span class="o">{</span>
         这里先不展开, 在device_class_init, 会通过
           object_class_property_add_bool<span class="o">(</span>class, <span class="s2">"realized"</span>,
              device_get_realized, device_set_realized<span class="o">)</span>
         注册好<span class="s2">"realized"</span> 的get callbak和set callbak
      <span class="o">}</span>
      <span class="o">=&gt;</span> device_set_realized              <span class="c"># 代码比较多, 只看一个地方</span>
         <span class="o">=&gt;</span> dc-&gt;realize<span class="o">()</span>                 <span class="c"># 这里回调用到pci_edu_realize</span>
</pre></table></code></div></div><p>我们主要看下<code class="language-plaintext highlighter-rouge">object_new</code></p><p>object new 流程：</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>object_new
<span class="o">=&gt;</span> ti <span class="o">=</span> type_get_by_name<span class="o">(</span>typename<span class="o">)</span>        <span class="c"># 通过typename，找到TypeImpl</span>
<span class="o">=&gt;</span> object_new_with_type<span class="o">(</span>Type <span class="nb">type</span>:ti<span class="o">)</span>
   <span class="o">=&gt;</span> type_initialize<span class="o">(</span><span class="nb">type</span><span class="o">)</span>               <span class="c"># 如果该type没有初始化过，在这里初始化</span>
   <span class="o">=&gt;</span> alloc object instance 
      <span class="o">{</span>
         size <span class="o">=</span> type-&gt;instance_size<span class="p">;</span>
         align <span class="o">=</span> type-&gt;instance_align<span class="p">;</span>
         这里会根据align_size的大小，选择是否对其分配，下面我们展开代码:
         obj <span class="o">=</span> g_malloc<span class="o">()</span> / qemu_memalign
				 obj_free <span class="o">=</span> g_free / qemu_vfree
      <span class="o">}</span>
      
   <span class="o">=&gt;</span> object_initialize_with_type<span class="o">(</span>obj, size, <span class="nb">type</span><span class="o">)</span>
      <span class="o">=&gt;</span> memset<span class="o">(</span>obj, 0, type-&gt;instance_size<span class="o">)</span><span class="p">;</span>
      <span class="o">=&gt;</span> obj-&gt;class <span class="o">=</span> type-&gt;class<span class="p">;</span>
      <span class="o">=&gt;</span> object_ref<span class="o">(</span>obj<span class="o">)</span>                  <span class="c"># org refcount</span>
      <span class="o">=&gt;</span> object_class_property_init_all<span class="o">(</span>obj<span class="o">)</span>  <span class="c">#和properties相关</span>
      <span class="o">=&gt;</span> obj-&gt;properties <span class="o">=</span> g_hash_table_new_full<span class="o">()</span>
      <span class="o">=&gt;</span> object_init_with_type<span class="o">(</span>obj, <span class="nb">type</span><span class="o">)</span><span class="p">;</span>
         <span class="o">=&gt;</span> 递归对obj以及parent 都调用 ti-&gt;instance_init<span class="o">()</span>
      <span class="o">=&gt;</span> object_post_init_with_type<span class="o">()</span>
         <span class="o">=&gt;</span> 递归， 对其 obj 以及parent调用 ti-&gt;instance_post_init<span class="o">()</span>
</pre></table></code></div></div><blockquote><p>这里需要注意的是, <code class="language-plaintext highlighter-rouge">object_init_with_type()</code>, 调用<code class="language-plaintext highlighter-rouge">ti-&gt;instance_init()</code>时，需要 先对父类进行init，再对子类， 而<code class="language-plaintext highlighter-rouge">object_post_init_with_type()</code>则相反。</p></blockquote><p>看下<code class="language-plaintext highlighter-rouge">pci_edu_realize</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>pci_edu_realize
  <span class="o">=&gt;</span> pci_config_set_interrupt_pin<span class="o">(</span>pci_conf, 1<span class="o">)</span> <span class="c"># 设置interrupt_pin</span>
  <span class="o">=&gt;</span> msi_init<span class="o">(</span>pdev, 0, 1, <span class="nb">true</span>, <span class="nb">false</span>, errp<span class="o">)</span>   <span class="c"># 设置msi</span>
  <span class="o">=&gt;</span> timer_init_ms<span class="o">(</span>&amp;edu-&gt;dma_timer, ...<span class="o">)</span>       <span class="c"># dma timer</span>
  <span class="o">=&gt;</span> memory_region_init_io<span class="o">(</span>&amp;edu-&gt;mmio, &amp;edu_mmio_ops, edu, <span class="s2">"edi-mmio"</span>, 1<span class="k">*</span> MiB<span class="o">)</span>
     <span class="c"># register mmio</span>
  <span class="o">=&gt;</span> pci_register_bar<span class="o">(</span>pdev, 0, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;edu-&gt;mmio<span class="o">)</span>
     <span class="c"># register bar</span>
</pre></table></code></div></div><p>经过上面流程，edu 实例已经初始化完成。</p><h2 id="qom-properties"><span class="me-2">qom properties</span><a href="#qom-properties" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>QOM为了便于管理对象，为每个class定义了properties</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">ObjectClass</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">GHashTable</span> <span class="o">*</span><span class="n">properties</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>每个Property object定义如下:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">ObjectProperty</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">;</span>
    <span class="n">ObjectPropertyAccessor</span> <span class="o">*</span><span class="n">get</span><span class="p">;</span>
    <span class="n">ObjectPropertyAccessor</span> <span class="o">*</span><span class="n">set</span><span class="p">;</span>
    <span class="n">ObjectPropertyResolve</span> <span class="o">*</span><span class="n">resolve</span><span class="p">;</span>
    <span class="n">ObjectPropertyRelease</span> <span class="o">*</span><span class="n">release</span><span class="p">;</span>
    <span class="n">ObjectPropertyInit</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">;</span>
    <span class="n">QObject</span> <span class="o">*</span><span class="n">defval</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>name: property name，key value<li>type: property type, 类型名，例如bool, string, link<li>init, get, set, resolve, release 则是注册的回调<li>opaque: 指向一个具体的类型(type中指定的), 其内定义了更具体的回调</ul><p>我们来看下几个具体类型:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">BoolProperty</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="n">Object</span> <span class="o">*</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)(</span><span class="n">Object</span> <span class="o">*</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="p">);</span>
<span class="p">}</span> <span class="n">BoolProperty</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">StringProperty</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="n">Object</span> <span class="o">*</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)(</span><span class="n">Object</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="p">);</span>
<span class="p">}</span> <span class="n">StringProperty</span><span class="p">;</span>
</pre></table></code></div></div><p>以执行下面语句为例， 我们看下:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>device_class_init
...
=&gt; object_class_property_add_bool(class, "realized",
    device_get_realized, device_set_realized);
=&gt; object_class_property_add_bool(class, "hotpluggable",
    device_get_hotpluggable, NULL);
...

</pre></table></code></div></div><p>我们来画下edu class 的图:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>+--------------+    
|ObjectClass   |    
+--------------+  
|DeviceClass   |
|其他成员      |---------- PCIDeviceClass, 也就是edu class parent, 但是edu class并没有增加其他member
+--------------+     
|PCIDeviceClass|     
|其他成员      |      
+--------------+        
</pre></table></code></div></div><p>ObjectClass</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>+--------------------+           +---------------+
|ObjectClass         |    +------+               |
+--------------------+    |      +---------------+
|type:Type(TypeImpl*)+----+  
+--------------------+    
|interfaces:GSList   |  
+--------------------+
|properties          |
+--------------------+
</pre></table></code></div></div><p>图:</p><details open=""> <summary>DeviceClass-&gt;properity图示</summary><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre> +-----------+
 |ObjectClass|
 +-----------+
 |           |
 +-----------+
 |properity  +---+------+-------------
 +-----------+   |      |
 |           |   |      |
 +-----------+   |      |
                 |      |
                 |   +-------+
                 |   |name   +--------- "realized"
                 |   +-------+
                 |   |type   +--------- "bool"
                 |   +-------+
                 |   |set    +--------- properity_set_bool
                 |   +-------+
                 |   |get    +--------- properity_get_bool
                 |   +-------+
                 |   |opaque +-------+  +-------------+
                 |   +-------+       +--+BoolProperty |
                 |                      +-------------+
                 |                      |get          +---- device_get_realized
                 |                      +-------------+
                 |                      |set          +---- device_set_realized
                 +--------+             +-------------+
                          |
                      +---+---+
                      |name   +--------- "hotpluggable"
                      +-------+
                      |type   +--------- "bool"
                      +-------+
                      |set    +--------- properity_set_bool
                      +-------+
                      |get    +--------- properity_get_bool
                      +-------+
                      |opaque +-----+    +------------+
                      +-------+     +----+BoolProperty|
                                         +------------+
                                         |get         +--- device_set_hotplugable
                                         +------------+
                                         |set         +--- NULL
                                         +------------+
</pre></table></code></div></div></details><h3 id="init"><span class="me-2">init</span><a href="#init" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>该成员是一个hash表，在type_initialize()初始化:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">type_initialize</span>

<span class="o">=&gt;</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="k">class</span><span class="o">-&gt;</span><span class="n">properties</span> <span class="o">=</span> <span class="n">g_hash_table_new_full</span><span class="p">(</span><span class="n">g_str_hash</span><span class="p">,</span> <span class="n">g_str_equal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                                                  <span class="n">object_property_free</span><span class="p">);</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">g_hash_table_new_full</code>的参数依次为:</p><ul><li>hash_func: get key hash<li>key_equal_func: compare key<li>key_destroy_func: free key<li>value_destroy_func: free value</ul><h3 id="add"><span class="me-2">add</span><a href="#add" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>上面列出来一些，这次，我们列举全:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">device_class_init</span>
  <span class="o">=&gt;</span> <span class="n">object_class_property_add_bool</span><span class="p">(</span><span class="k">class</span><span class="p">,</span> <span class="s">"realized"</span><span class="p">,</span>
                               <span class="n">device_get_realized</span><span class="p">,</span> <span class="n">device_set_realized</span><span class="p">);</span>
  <span class="o">=&gt;</span> <span class="n">object_class_property_add_bool</span><span class="p">(</span><span class="k">class</span><span class="p">,</span> <span class="s">"hotpluggable"</span><span class="p">,</span>
                               <span class="n">device_get_hotpluggable</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="o">=&gt;</span> <span class="n">object_class_property_add_bool</span><span class="p">(</span><span class="k">class</span><span class="p">,</span> <span class="s">"hotplugged"</span><span class="p">,</span>
                               <span class="n">device_get_hotplugged</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="o">=&gt;</span> <span class="n">object_class_property_add_link</span><span class="p">(</span><span class="k">class</span><span class="p">,</span> <span class="s">"parent_bus"</span><span class="p">,</span> <span class="n">TYPE_BUS</span><span class="p">,</span>
                               <span class="n">offsetof</span><span class="p">(</span><span class="n">DeviceState</span><span class="p">,</span> <span class="n">parent_bus</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></table></code></div></div><p>以简单的bool类型为例:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">object_class_property_add_bool</span>
   <span class="o">=&gt;</span> <span class="n">BoolProperty</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">g_malloc</span>
   <span class="o">=&gt;</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">device_get_realized</span>
   <span class="o">=&gt;</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">device_set_realized</span>
   <span class="o">=&gt;</span> <span class="n">object_class_property_add</span><span class="p">(</span><span class="k">class</span><span class="p">,</span> <span class="s">"realized"</span><span class="p">,</span> <span class="s">"bool"</span><span class="p">,</span> 
      <span class="n">property_get_bool</span><span class="p">,</span> <span class="n">property_set_bool</span><span class="p">,</span>
      <span class="nb">NULL</span><span class="p">,</span>
      <span class="kt">void</span> <span class="o">*</span> <span class="n">opaque</span><span class="o">:</span> <span class="n">prop</span>
      <span class="p">)</span>
      <span class="o">=&gt;</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">g_malloc0</span><span class="p">(</span><span class="n">ObjectProperty</span><span class="p">)</span>
      <span class="o">=&gt;</span> <span class="n">init</span> <span class="p">{</span>
            <span class="n">prop</span><span class="o">-&gt;</span><span class="n">name</span>
            <span class="n">prop</span><span class="o">-&gt;</span><span class="n">type</span>
            <span class="n">prop</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">opaque</span>
         <span class="p">}</span>
      <span class="o">=&gt;</span> <span class="n">g_hash_table_insert</span><span class="p">(</span><span class="k">class</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="find"><span class="me-2">find</span><a href="#find" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">ObjectProperty</span> <span class="o">*</span><span class="nf">object_class_property_find</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ObjectClass</span> <span class="o">*</span><span class="n">parent_klass</span><span class="p">;</span>

    <span class="n">parent_klass</span> <span class="o">=</span> <span class="n">object_class_get_parent</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parent_klass</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ObjectProperty</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span>
            <span class="n">object_class_property_find</span><span class="p">(</span><span class="n">parent_klass</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">prop</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nf">g_hash_table_lookup</span><span class="p">(</span><span class="n">klass</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote class="prompt-info"><p>NOTE: 自己理解</p><p>这里搜索<code class="language-plaintext highlighter-rouge">prop</code>时，有顺序要求么，为什么还要先递归search parent class</p><p>是因为在进行<code class="language-plaintext highlighter-rouge">type_realized</code>时，并没有继承property, 理论上也不允许 父类和子类有相同name 的 property, 所以，这里会search parent class， 并且search顺序无所谓</p></blockquote><h3 id="set"><span class="me-2">set</span><a href="#set" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">object_property_set_bool</span>
  <span class="o">=&gt;</span> <span class="n">object_property_set</span>
     <span class="o">=&gt;</span> <span class="n">ObjectProperty</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">object_property_find_err</span>
     <span class="o">=&gt;</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">()</span>    <span class="err">#</span> <span class="n">property_set_bool</span>
        <span class="o">=&gt;</span> <span class="n">BoolProperty</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">opaque</span>
        <span class="o">=&gt;</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">()</span> <span class="err">#</span> <span class="n">device_set_realized</span>
</pre></table></code></div></div><p>流程比较简单，先find, 再set</p><h2 id="others"><span class="me-2">others</span><a href="#others" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="gcc-constructor-attribute-test"><span class="me-2">gcc constructor attribute test</span><a href="#gcc-constructor-attribute-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>编写程序测试:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="n">before_main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"before main</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"main exec </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>执行程序获取输出:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>➜  constructor_test ./main
before main
main <span class="nb">exec</span>
</pre></table></code></div></div><p>gdb 调试下:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>#0  before_main () at main.c:5
#1  0x00007ffff7df5cc4 in __libc_start_main_impl () from /lib64/libc.so.6
#2  0x0000000000401065 in _start ()
</pre></table></code></div></div><p>发现在main前, 执行<code class="language-plaintext highlighter-rouge">_start</code>时，会执行constructor之前的函数</p><h2 id="参考文献"><span class="me-2">参考文献</span><a href="#参考文献" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>[1]. «QEMU-KVM 源码解析与应用»</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/qemu/">qemu</a>, <a href="/categories/qom/">qom</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/qemo-qmo/" class="post-tag no-text-decoration" >qemo_qmo</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=qemu%20qom%20-%20one%20step%20at%20a%20time&url=%2Fposts%2Fqom%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=qemu%20qom%20-%20one%20step%20at%20a%20time&u=%2Fposts%2Fqom%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fqom%2F&text=qemu%20qom%20-%20one%20step%20at%20a%20time" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/host-bridge/">host-bridge is pci device BUT NOT pci bridge</a><li class="text-truncate lh-lg"> <a href="/posts/pci_bridge/">qemu brige migration</a><li class="text-truncate lh-lg"> <a href="/posts/time/">time</a><li class="text-truncate lh-lg"> <a href="/posts/setup-apic-timer/">apic timer</a><li class="text-truncate lh-lg"> <a href="/posts/kvm-stats/">kvm stats</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/apic-timer/">apic-timer</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-bitmap/">dirty-bitmap</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-ring/">dirty-ring</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/hot-upgrade-my-test/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1728646020" data-df="ll" > Oct 11, 2024 </time><h4 class="pt-0 my-2">qemu hot update my test</h4><div class="text-muted"><p>cpr-reboot test (upstream已经合入, 直接用上游测试) 测试过程如下: 测试过程 # org process ./qemu-system-x86_64 -machine type=q35 -object memory-backend-memfd,size=2G,id=ram0 -m 2G -monitor stdio ~/qemu-hotupdate&amp;...</p></div></div></a></article><article class="col"> <a href="/posts/qemu-hot-upgrade-upstream-org/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1728646020" data-df="ll" > Oct 11, 2024 </time><h4 class="pt-0 my-2">qemu hot_upgrade org patch</h4><div class="text-muted"><p>patch link https://patchew.org/QEMU/1658851843-236870-1-git-send-email-steven.sistare@oracle.com/ commit message This version of the live update patch series integrates live update into the live ...</p></div></div></a></article><article class="col"> <a href="/posts/qemu-mem/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1729044000" data-df="ll" > Oct 16, 2024 </time><h4 class="pt-0 my-2">live migration</h4><div class="text-muted"><p>struct 内存初始化流程 初始化MemoryRegion 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/qemu-hot-upgrade-upstream-org/" class="btn btn-outline-primary" aria-label="Older" ><p>qemu hot_upgrade org patch</p></a> <a href="/posts/acs/" class="btn btn-outline-primary" aria-label="Newer" ><p>acs</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/fuqiang_cai">fuqiang wang</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v6.5.5" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/apic-timer/">apic-timer</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-bitmap/">dirty-bitmap</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-ring/">dirty-ring</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
