<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="async pf" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="introduce" /><meta property="og:description" content="introduce" /><link rel="canonical" href="/posts/async-pf/" /><meta property="og:url" content="/posts/async-pf/" /><meta property="og:site_name" content="one step at a time" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-04-10T12:20:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="async pf" /><meta name="twitter:site" content="@fuqiang_cai" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2024-04-10T12:20:00+08:00","datePublished":"2024-04-10T12:20:00+08:00","description":"introduce","headline":"async pf","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/async-pf/"},"url":"/posts/async-pf/"}</script><title>async pf | one step at a time</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="one step at a time"><meta name="application-name" content="one step at a time"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"></a><h1 class="site-title"> <a href="/">one step at a time</a></h1><p class="site-subtitle fst-italic mb-0">a noob's growing diary</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cai-fuqiang" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fuqiang_cai" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['iwng86','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>async pf</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>async pf</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1712722800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 10, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="8026 words" > <em>44 min</em> read</span></div></div></div></header><div class="content"><h2 id="introduce"><span class="me-2">introduce</span><a href="#introduce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在支持EPT的架构中, 对于<code class="language-plaintext highlighter-rouge">GVA-&gt;HPA</code>一般有两段映射:</p><ul><li><code class="language-plaintext highlighter-rouge">GVA-&gt;GPA</code><li><code class="language-plaintext highlighter-rouge">GPA-&gt;HPA</code></ul><p>而host kernel (kvm) 需要关心的是 <code class="language-plaintext highlighter-rouge">GPA-&gt;HPA</code>的映射, 需要host做的事情主要有 以下几个:</p><ol><li>捕捉相关 VM-exit event (EPT violation), 得到 GPA<li>分配page<li>建立映射关系(当然这个映射关系, 不止是GPA-&gt;HPA的mmu pgtable, 还有 HVA – GPA, 在这里不展开, 总之分配好具体的page(分配HPA), 以及为其建立好 mmu pgtable, 就可以完成该事件的处理)</ol><p>如下图:</p><details open=""> <summary>图示</summary><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-ae4ca25f7bf30b9e61f0f3b83bc12338" width="480pt" height="745pt" viewBox="0.00 0.00 480.00 744.96"><title>graphviz-ae4ca25f7bf30b9e61f0f3b83bc12338</title><desc> digraph G { subgraph cluster_guest { EPT_violation [ label=&quot;EPT mapping(GPA-&gt;HPA) \nloss, trigger EPT violation&quot; ] &quot;access a VA&quot;-&gt; &quot;trigger PF in VMX\n non-root operation&quot;-&gt; &quot;mapping GVA-&gt;GPA\n in GUEST #PF hook&quot;-&gt; &quot;fixup #PF, continue \naccess this VA&quot;-&gt; EPT_violation label=&quot;guest&quot; } subgraph cluster_host { &quot;find HVA though GPA&quot;-&gt; &quot;GUP(HVA)&quot;-&gt; &quot;mapping GPA-&gt;HPA&quot; label=&quot;host&quot; } &quot;mapping GPA-&gt;HPA&quot;-&gt;&quot;access a VA&quot; [ label=&quot;fixup EPT violation,\n VM entry&quot; ] EPT_violation-&gt;&quot;find HVA though GPA&quot; [ label=&quot;VM exit&quot; ] } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 740.96)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-740.96 476,-740.96 476,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_guest</title><polygon fill="none" stroke="black" points="8,-262 8,-728.96 312,-728.96 312,-262 8,-262" /> <text text-anchor="middle" x="160" y="-713.76" font-family="Times,serif" font-size="14.00">guest</text> </g> <g id="clust2" class="cluster"><title>cluster_host</title><polygon fill="none" stroke="black" points="69,-8 69,-229 303,-229 303,-8 69,-8" /> <text text-anchor="middle" x="186" y="-213.8" font-family="Times,serif" font-size="14.00">host</text> </g> <g id="node1" class="node"><title>EPT_violation</title><ellipse fill="none" stroke="black" cx="160" cy="-296.87" rx="143.59" ry="26.74" /> <text text-anchor="middle" x="160" y="-300.67" font-family="Times,serif" font-size="14.00">EPT mapping(GPA&#45;&gt;HPA) </text> <text text-anchor="middle" x="160" y="-285.67" font-family="Times,serif" font-size="14.00">loss, trigger EPT violation</text> </g> <g id="node6" class="node"><title>find HVA though GPA</title><ellipse fill="none" stroke="black" cx="186" cy="-180" rx="108.58" ry="18" /> <text text-anchor="middle" x="186" y="-176.3" font-family="Times,serif" font-size="14.00">find HVA though GPA</text> </g> <g id="edge8" class="edge"><title>EPT_violation&#45;&gt;find HVA though GPA</title><path fill="none" stroke="black" d="M165.9,-269.8C170.08,-251.35 175.67,-226.66 179.89,-207.99" /><polygon fill="black" stroke="black" points="183.34,-208.59 182.14,-198.06 176.52,-207.04 183.34,-208.59" /> <text text-anchor="middle" x="201" y="-240.8" font-family="Times,serif" font-size="14.00">VM exit</text> </g> <g id="node2" class="node"><title>access a VA</title><ellipse fill="none" stroke="black" cx="200" cy="-679.96" rx="64.19" ry="18" /> <text text-anchor="middle" x="200" y="-676.26" font-family="Times,serif" font-size="14.00">access a VA</text> </g> <g id="node3" class="node"><title>trigger PF in VMX\n non&#45;root operation</title><ellipse fill="none" stroke="black" cx="194" cy="-598.09" rx="108.79" ry="26.74" /> <text text-anchor="middle" x="194" y="-601.89" font-family="Times,serif" font-size="14.00">trigger PF in VMX</text> <text text-anchor="middle" x="194" y="-586.89" font-family="Times,serif" font-size="14.00"> non&#45;root operation</text> </g> <g id="edge1" class="edge"><title>access a VA&#45;&gt;trigger PF in VMX\n non&#45;root operation</title><path fill="none" stroke="black" d="M198.7,-661.63C198.12,-653.9 197.41,-644.48 196.72,-635.32" /><polygon fill="black" stroke="black" points="200.2,-634.9 195.96,-625.19 193.22,-635.43 200.2,-634.9" /> </g> <g id="node4" class="node"><title>mapping GVA&#45;&gt;GPA\n in GUEST #PF hook</title><ellipse fill="none" stroke="black" cx="176" cy="-507.35" rx="117.26" ry="26.74" /> <text text-anchor="middle" x="176" y="-511.15" font-family="Times,serif" font-size="14.00">mapping GVA&#45;&gt;GPA</text> <text text-anchor="middle" x="176" y="-496.15" font-family="Times,serif" font-size="14.00"> in GUEST #PF hook</text> </g> <g id="edge2" class="edge"><title>trigger PF in VMX\n non&#45;root operation&#45;&gt;mapping GVA&#45;&gt;GPA\n in GUEST #PF hook</title><path fill="none" stroke="black" d="M188.7,-570.95C186.99,-562.55 185.08,-553.1 183.26,-544.14" /><polygon fill="black" stroke="black" points="186.68,-543.41 181.27,-534.31 179.82,-544.8 186.68,-543.41" /> </g> <g id="node5" class="node"><title>fixup #PF, continue \naccess this VA</title><ellipse fill="none" stroke="black" cx="166" cy="-416.61" rx="113.69" ry="26.74" /> <text text-anchor="middle" x="166" y="-420.41" font-family="Times,serif" font-size="14.00">fixup #PF, continue </text> <text text-anchor="middle" x="166" y="-405.41" font-family="Times,serif" font-size="14.00">access this VA</text> </g> <g id="edge3" class="edge"><title>mapping GVA&#45;&gt;GPA\n in GUEST #PF hook&#45;&gt;fixup #PF, continue \naccess this VA</title><path fill="none" stroke="black" d="M173.05,-480.21C172.12,-471.9 171.07,-462.56 170.07,-453.69" /><polygon fill="black" stroke="black" points="173.52,-453.11 168.93,-443.57 166.57,-453.9 173.52,-453.11" /> </g> <g id="edge4" class="edge"><title>fixup #PF, continue \naccess this VA&#45;&gt;EPT_violation</title><path fill="none" stroke="black" d="M164.67,-389.48C163.84,-373.17 162.76,-351.94 161.84,-334.03" /><polygon fill="black" stroke="black" points="165.33,-333.74 161.33,-323.93 158.34,-334.09 165.33,-333.74" /> </g> <g id="node7" class="node"><title>GUP(HVA)</title><ellipse fill="none" stroke="black" cx="187" cy="-107" rx="59.29" ry="18" /> <text text-anchor="middle" x="187" y="-103.3" font-family="Times,serif" font-size="14.00">GUP(HVA)</text> </g> <g id="edge5" class="edge"><title>find HVA though GPA&#45;&gt;GUP(HVA)</title><path fill="none" stroke="black" d="M186.24,-161.81C186.36,-153.79 186.49,-144.05 186.62,-135.07" /><polygon fill="black" stroke="black" points="190.12,-135.08 186.76,-125.03 183.12,-134.98 190.12,-135.08" /> </g> <g id="node8" class="node"><title>mapping GPA&#45;&gt;HPA</title><ellipse fill="none" stroke="black" cx="191" cy="-34" rx="103.18" ry="18" /> <text text-anchor="middle" x="191" y="-30.3" font-family="Times,serif" font-size="14.00">mapping GPA&#45;&gt;HPA</text> </g> <g id="edge6" class="edge"><title>GUP(HVA)&#45;&gt;mapping GPA&#45;&gt;HPA</title><path fill="none" stroke="black" d="M187.97,-88.81C188.42,-80.79 188.97,-71.05 189.47,-62.07" /><polygon fill="black" stroke="black" points="192.97,-62.21 190.04,-52.03 185.98,-61.82 192.97,-62.21" /> </g> <g id="edge7" class="edge"><title>mapping GPA&#45;&gt;HPA&#45;&gt;access a VA</title><path fill="none" stroke="black" d="M268.51,-46.1C301.28,-55.6 332,-73.25 332,-106 332,-599.09 332,-599.09 332,-599.09 332,-634.96 295.88,-655.16 261.43,-666.26" /><polygon fill="black" stroke="black" points="260.36,-662.93 251.79,-669.16 262.38,-669.63 260.36,-662.93" /> <text text-anchor="middle" x="402" y="-360.54" font-family="Times,serif" font-size="14.00">fixup EPT violation,</text> <text text-anchor="middle" x="402" y="-345.54" font-family="Times,serif" font-size="14.00"> VM entry</text> </g> </g> </svg></div></details><p>但是, 已经建立好映射的页面, 也是qemu进程的虚拟地址空间(匿名页), 是可以被swap out, 当被swap out后, GUEST 访问该HPA对应的 GVA/GPA时, 仍然会触发 EPT violation. 这时还会 再走一次 VM-exit, 而且也需要完成上面所述的三件事, 其中第二件:分配page, 需要swap in 之前被swap out的page, 路径比较长, 如下:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>VM-exit
  handle_ept_violation
    kvm_mmu_page_fault
      tdp_page_fault
        gfn_to_pfn
          hva_to_pfn
            get_user_pages --slow path
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">get_user_pages</code>会走到slow path, 由于会走swap in流程, 所以该过程执行较慢. 所以大佬们就想着 能不能让其异步执行, 然后让vcpu先不complete 造成 EPT violation 的 instruction, 去干别的事 情, 等page present后, 再去执行该指令. 另外将 get_user_pages 让一个 dedicated thread 去完成, 这样, 对于虚拟机来说, 就相当于搞了一个额外的 硬件, 专门去处理 swap in, 解放了vcpu的算力.</p><blockquote class="prompt-tip"><p>NOTE</p><p>大家思考下, 如果要达到该目的, 一定是让GUEST有意无意的 sche out 造成 EPT violation 的进程,</p></blockquote><p>该上面流程总结如下:</p><hr /><hr /> <details open=""> <summary>流程图</summary><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-f8c81926c9687c237f8513f3a6fb3624" width="713pt" height="728pt" viewBox="0.00 0.00 713.00 727.74"><title>graphviz-f8c81926c9687c237f8513f3a6fb3624</title><desc> digraph G { subgraph cluster_host { style=&quot;filled&quot; color=&quot;#693886699&quot; subgraph cluster_host_dedicated_thread { do_slow_path [ shape=&quot;note&quot; label=&quot;I&#39;m a delicated \nthread, Like a \nspecial hardware, \nsharing the \npressure of VCPU&quot; ] label=&quot;dedicated thread&quot; have_got_page_success [ label=&quot;work in done!\n tell the guest&quot; ] do_slow_path-&gt;have_got_page_success [ label=&quot;a. get page, swap in...&quot; fontcolor=&quot;blue&quot; color=&quot;blue&quot; ] } subgraph cluster_host_kvm_vcpu_thread { ept_violation_handler [ label=&quot;ept violation handler&quot; ] dont_do_slow_path [ shape=&quot;note&quot; label=&quot;I don&#39;t want \nhandle slow path, \nit will speed\nto much time&quot; ] tell_guest_sched_out [ shape=&quot;note&quot; label=&quot;work is doing,\nneed wait\n a a bit time,\n let guest do\n other things&quot; ] dont_do_slow_path -&gt;tell_guest_sched_out [ label=&quot;4.let guest \ndo other thing&quot; fontcolor=&quot;green&quot; color=&quot;green&quot; ] ept_violation_handler-&gt; dont_do_slow_path [ label=&quot;2.find page swap out&quot; fontcolor=&quot;green&quot; color=&quot;green&quot; ] label=&quot;host kvm vcpu thread&quot; } label = &quot;host&quot; } subgraph cluster_guest { style=&quot;filled&quot; color=&quot;#77323456&quot; subgraph cluster_trigger_ept_violation_task { task1_access_a_memory [ label=&quot;acesss a memory\n address [BEG]&quot; color=&quot;white&quot; style=&quot;filled&quot; ] label=&quot;TASK1 trigger ept vioaltion&quot; } subgraph cluster_sched_in_task2 { task2_run_a_time [ label=&quot;task2_run_a_time&quot; ] label=&quot;task2&quot; } label=&quot;guest&quot; } dont_do_slow_path-&gt;do_slow_path [ label=&quot;3. start a work \nto do it&quot; fontcolor=&quot;green&quot; color=&quot;green&quot; ] task1_access_a_memory -&gt; ept_violation_handler [ label=&quot;1.page NOT present,\ntrigger EPT violation&quot; fontcolor=&quot;green&quot; color=&quot;green&quot; ] have_got_page_success -&gt; task2_run_a_time [ label=&quot;b. page NOT present\n SCHED IN&quot; fontcolor=&quot;blue&quot; color=&quot;blue&quot; ] tell_guest_sched_out -&gt; task1_access_a_memory [ label=&quot;5. page NOT present\n SCHED OUT&quot; fontcolor=&quot;green&quot; color=&quot;green&quot; ] task2_run_a_time-&gt;task1_access_a_memory [ label=&quot;c. sched in\n task1&quot; fontcolor=&quot;blue&quot; color=&quot;blue&quot; ] task1_access_a_memory-&gt;task2_run_a_time [ label=&quot;6.sched out\n task1&quot; fontcolor=&quot;green&quot; color=&quot;green&quot; ] } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 723.74)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-723.74 709,-723.74 709,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_host</title><polygon fill="#693886" fill-opacity="0.411765" stroke="#693886" stroke-opacity="0.411765" points="8,-137 8,-711.74 453,-711.74 453,-137 8,-137" /> <text text-anchor="middle" x="230.5" y="-696.54" font-family="Times,serif" font-size="14.00">host</text> </g> <g id="clust2" class="cluster"><title>cluster_host_dedicated_thread</title><polygon fill="#693886" fill-opacity="0.411765" stroke="#693886" stroke-opacity="0.411765" points="16,-145 16,-438.74 207,-438.74 207,-145 16,-145" /> <text text-anchor="middle" x="111.5" y="-423.54" font-family="Times,serif" font-size="14.00">dedicated thread</text> </g> <g id="clust3" class="cluster"><title>cluster_host_kvm_vcpu_thread</title><polygon fill="#693886" fill-opacity="0.411765" stroke="#693886" stroke-opacity="0.411765" points="215,-316.74 215,-680.74 445,-680.74 445,-316.74 215,-316.74" /> <text text-anchor="middle" x="330" y="-665.54" font-family="Times,serif" font-size="14.00">host kvm vcpu thread</text> </g> <g id="clust4" class="cluster"><title>cluster_guest</title><polygon fill="#773234" fill-opacity="0.337255" stroke="#773234" stroke-opacity="0.337255" points="461,-8 461,-268.74 689,-268.74 689,-8 461,-8" /> <text text-anchor="middle" x="575" y="-253.54" font-family="Times,serif" font-size="14.00">guest</text> </g> <g id="clust5" class="cluster"><title>cluster_trigger_ept_violation_task</title><polygon fill="#773234" fill-opacity="0.337255" stroke="#773234" stroke-opacity="0.337255" points="469,-145 469,-237.74 681,-237.74 681,-145 469,-145" /> <text text-anchor="middle" x="575" y="-222.54" font-family="Times,serif" font-size="14.00">TASK1 trigger ept vioaltion</text> </g> <g id="clust6" class="cluster"><title>cluster_sched_in_task2</title><polygon fill="#773234" fill-opacity="0.337255" stroke="#773234" stroke-opacity="0.337255" points="469,-16 469,-91 669,-91 669,-16 469,-16" /> <text text-anchor="middle" x="569" y="-75.8" font-family="Times,serif" font-size="14.00">task2</text> </g> <g id="node1" class="node"><title>do_slow_path</title><polygon fill="none" stroke="black" points="179,-407.74 37,-407.74 37,-324.74 185,-324.74 185,-401.74 179,-407.74" /><polyline fill="none" stroke="black" points="179,-407.74 179,-401.74 " /><polyline fill="none" stroke="black" points="185,-401.74 179,-401.74 " /> <text text-anchor="middle" x="111" y="-392.54" font-family="Times,serif" font-size="14.00">I&#39;m a delicated </text> <text text-anchor="middle" x="111" y="-377.54" font-family="Times,serif" font-size="14.00">thread, Like a </text> <text text-anchor="middle" x="111" y="-362.54" font-family="Times,serif" font-size="14.00">special hardware, </text> <text text-anchor="middle" x="111" y="-347.54" font-family="Times,serif" font-size="14.00">sharing the </text> <text text-anchor="middle" x="111" y="-332.54" font-family="Times,serif" font-size="14.00">pressure of VCPU</text> </g> <g id="node2" class="node"><title>have_got_page_success</title><ellipse fill="none" stroke="black" cx="111" cy="-179.87" rx="82.05" ry="26.74" /> <text text-anchor="middle" x="111" y="-183.67" font-family="Times,serif" font-size="14.00">work in done!</text> <text text-anchor="middle" x="111" y="-168.67" font-family="Times,serif" font-size="14.00"> tell the guest</text> </g> <g id="edge1" class="edge"><title>do_slow_path&#45;&gt;have_got_page_success</title><path fill="none" stroke="blue" d="M111,-324.32C111,-292.25 111,-248.03 111,-217.19" /><polygon fill="blue" stroke="blue" points="114.5,-216.89 111,-206.89 107.5,-216.89 114.5,-216.89" /> <text text-anchor="middle" x="189.5" y="-288.04" font-family="Times,serif" font-size="14.00" fill="blue">a. get page, swap in...</text> </g> <g id="node7" class="node"><title>task2_run_a_time</title><ellipse fill="none" stroke="black" cx="569" cy="-42" rx="91.78" ry="18" /> <text text-anchor="middle" x="569" y="-38.3" font-family="Times,serif" font-size="14.00">task2_run_a_time</text> </g> <g id="edge6" class="edge"><title>have_got_page_success&#45;&gt;task2_run_a_time</title><path fill="none" stroke="blue" d="M161.8,-158.63C206.24,-141.37 272.76,-116.64 332,-99 387.04,-82.61 450.4,-67.85 497.75,-57.6" /><polygon fill="blue" stroke="blue" points="498.56,-61 507.6,-55.48 497.09,-54.16 498.56,-61" /> <text text-anchor="middle" x="406.5" y="-117.8" font-family="Times,serif" font-size="14.00" fill="blue">b. page NOT present</text> <text text-anchor="middle" x="406.5" y="-102.8" font-family="Times,serif" font-size="14.00" fill="blue"> SCHED IN</text> </g> <g id="node3" class="node"><title>ept_violation_handler</title><ellipse fill="none" stroke="black" cx="330" cy="-631.74" rx="107.48" ry="18" /> <text text-anchor="middle" x="330" y="-628.04" font-family="Times,serif" font-size="14.00">ept violation handler</text> </g> <g id="node4" class="node"><title>dont_do_slow_path</title><polygon fill="none" stroke="black" points="364.5,-562.74 223.5,-562.74 223.5,-494.74 370.5,-494.74 370.5,-556.74 364.5,-562.74" /><polyline fill="none" stroke="black" points="364.5,-562.74 364.5,-556.74 " /><polyline fill="none" stroke="black" points="370.5,-556.74 364.5,-556.74 " /> <text text-anchor="middle" x="297" y="-547.54" font-family="Times,serif" font-size="14.00">I don&#39;t want </text> <text text-anchor="middle" x="297" y="-532.54" font-family="Times,serif" font-size="14.00">handle slow path, </text> <text text-anchor="middle" x="297" y="-517.54" font-family="Times,serif" font-size="14.00">it will speed</text> <text text-anchor="middle" x="297" y="-502.54" font-family="Times,serif" font-size="14.00">to much time</text> </g> <g id="edge3" class="edge"><title>ept_violation_handler&#45;&gt;dont_do_slow_path</title><path fill="none" stroke="green" d="M324.4,-613.61C320.73,-602.36 315.74,-587.11 311.04,-572.7" /><polygon fill="green" stroke="green" points="314.27,-571.34 307.84,-562.92 307.62,-573.51 314.27,-571.34" /> <text text-anchor="middle" x="393.5" y="-584.54" font-family="Times,serif" font-size="14.00" fill="green">2.find page swap out</text> </g> <g id="edge4" class="edge"><title>dont_do_slow_path&#45;&gt;do_slow_path</title><path fill="none" stroke="green" d="M223.43,-496.07C213.41,-490.32 203.63,-483.86 195,-476.74 174.37,-459.72 155.77,-436.72 141.34,-416.2" /><polygon fill="green" stroke="green" points="144.17,-414.13 135.62,-407.88 138.4,-418.1 144.17,-414.13" /> <text text-anchor="middle" x="250" y="-465.54" font-family="Times,serif" font-size="14.00" fill="green">3. start a work </text> <text text-anchor="middle" x="250" y="-450.54" font-family="Times,serif" font-size="14.00" fill="green">to do it</text> </g> <g id="node5" class="node"><title>tell_guest_sched_out</title><polygon fill="none" stroke="black" points="384.5,-407.74 273.5,-407.74 273.5,-324.74 390.5,-324.74 390.5,-401.74 384.5,-407.74" /><polyline fill="none" stroke="black" points="384.5,-407.74 384.5,-401.74 " /><polyline fill="none" stroke="black" points="390.5,-401.74 384.5,-401.74 " /> <text text-anchor="middle" x="332" y="-392.54" font-family="Times,serif" font-size="14.00">work is doing,</text> <text text-anchor="middle" x="332" y="-377.54" font-family="Times,serif" font-size="14.00">need wait</text> <text text-anchor="middle" x="332" y="-362.54" font-family="Times,serif" font-size="14.00"> a a bit time,</text> <text text-anchor="middle" x="332" y="-347.54" font-family="Times,serif" font-size="14.00"> let guest do</text> <text text-anchor="middle" x="332" y="-332.54" font-family="Times,serif" font-size="14.00"> other things</text> </g> <g id="edge2" class="edge"><title>dont_do_slow_path&#45;&gt;tell_guest_sched_out</title><path fill="none" stroke="green" d="M304.25,-494.48C309.07,-472.37 315.5,-442.91 320.95,-417.91" /><polygon fill="green" stroke="green" points="324.43,-418.37 323.14,-407.85 317.59,-416.88 324.43,-418.37" /> <text text-anchor="middle" x="366.5" y="-465.54" font-family="Times,serif" font-size="14.00" fill="green">4.let guest </text> <text text-anchor="middle" x="366.5" y="-450.54" font-family="Times,serif" font-size="14.00" fill="green">do other thing</text> </g> <g id="node6" class="node"><title>task1_access_a_memory</title><ellipse fill="white" stroke="white" cx="575" cy="-179.87" rx="98.08" ry="26.74" /> <text text-anchor="middle" x="575" y="-183.67" font-family="Times,serif" font-size="14.00">acesss a memory</text> <text text-anchor="middle" x="575" y="-168.67" font-family="Times,serif" font-size="14.00"> address [BEG]</text> </g> <g id="edge7" class="edge"><title>tell_guest_sched_out&#45;&gt;task1_access_a_memory</title><path fill="none" stroke="green" d="M359.96,-324.51C372.26,-308.41 387.63,-290.51 404,-276.74 437.59,-248.48 480.74,-224.36 515.29,-207.38" /><polygon fill="green" stroke="green" points="516.85,-210.51 524.33,-203.01 513.8,-204.21 516.85,-210.51" /> <text text-anchor="middle" x="478.5" y="-295.54" font-family="Times,serif" font-size="14.00" fill="green">5. page NOT present</text> <text text-anchor="middle" x="478.5" y="-280.54" font-family="Times,serif" font-size="14.00" fill="green"> SCHED OUT</text> </g> <g id="edge5" class="edge"><title>task1_access_a_memory&#45;&gt;ept_violation_handler</title><path fill="none" stroke="green" d="M577.12,-206.77C581.55,-279.59 583.39,-487.81 472,-595.74 460.93,-606.47 447.13,-614.07 432.51,-619.44" /><polygon fill="green" stroke="green" points="431.2,-616.18 422.8,-622.65 433.4,-622.83 431.2,-616.18" /> <text text-anchor="middle" x="629.5" y="-465.54" font-family="Times,serif" font-size="14.00" fill="green">1.page NOT present,</text> <text text-anchor="middle" x="629.5" y="-450.54" font-family="Times,serif" font-size="14.00" fill="green">trigger EPT violation</text> </g> <g id="edge9" class="edge"><title>task1_access_a_memory&#45;&gt;task2_run_a_time</title><path fill="none" stroke="green" d="M519.36,-157.41C507.65,-150.2 496.8,-140.88 490,-129 483.37,-117.43 483.88,-110.84 490,-99 497.54,-84.42 510.81,-72.82 524.35,-64.04" /><polygon fill="green" stroke="green" points="526.48,-66.84 533.23,-58.68 522.86,-60.85 526.48,-66.84" /> <text text-anchor="middle" x="531.5" y="-117.8" font-family="Times,serif" font-size="14.00" fill="green">6.sched out</text> <text text-anchor="middle" x="531.5" y="-102.8" font-family="Times,serif" font-size="14.00" fill="green"> task1</text> </g> <g id="edge8" class="edge"><title>task2_run_a_time&#45;&gt;task1_access_a_memory</title><path fill="none" stroke="blue" d="M572.08,-60.09C573.92,-71.15 576.07,-85.87 577,-99 577.95,-112.3 577.27,-115.67 577,-129 576.91,-133.51 576.77,-138.24 576.61,-142.93" /><polygon fill="blue" stroke="blue" points="573.11,-142.87 576.24,-152.99 580.11,-143.13 573.11,-142.87" /> <text text-anchor="middle" x="615" y="-117.8" font-family="Times,serif" font-size="14.00" fill="blue">c. sched in</text> <text text-anchor="middle" x="615" y="-102.8" font-family="Times,serif" font-size="14.00" fill="blue"> task1</text> </g> </g> </svg></div></details><hr /><hr /><p>由上图可见, 引入async pf 的逻辑是让其能够在触发 EPT violation后, 能够让VCPU 调度 到另外一个task, 从而阻塞触发 EPT violation 的进程执行. 为了达到这一目的, 做了以下改动:</p><ul><li>VCPU 线程在执行<code class="language-plaintext highlighter-rouge">get_user_page()</code>时, 仅执行fast path, 如果page 不是present的, 该接口直接 返回, 而剩下的工作, 则交给另外一个<code class="language-plaintext highlighter-rouge">dedicated thread</code> 去做<li>KVM 会通过一些方式, 让 GUEST 执行调度, 从而避免再次执行触发<code class="language-plaintext highlighter-rouge">EPT violation</code>的指令. 而<code class="language-plaintext highlighter-rouge">dedicated thread</code> 完成了swap in 的动作后, 会通知guest再次唤醒该之前调度出去的进程</ul><h2 id="代码细节"><span class="me-2">代码细节</span><a href="#代码细节" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="para-virt-interface"><span class="me-2">para virt interface</span><a href="#para-virt-interface" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>一般的半虚拟化实现往往都有一下几个特征:</p><ul><li>use CPUID report this feature<li>use MSR transparent less information, e.g. :<ul><li>a share memory address<li>enable/disable</ul><li>use a share memory transparent more information</ul><p>而 para virt async PF 也是这样实现的.</p><blockquote class="prompt-tip"><p>在<a href="https://lore.kernel.org/all/1257076590-29559-2-git-send-email-gleb@redhat.com/">v1 Add shared memory hypercall to PV Linux guest</a>版本中, 作者以 hypercall的方式实现了半虚拟化, 但是avi在随后建议(<a href="https://lore.kernel.org/all/4AEECE2E.2050609@redhat.com/">link</a>) 使用MSR来替代 hypercall, 因为该方式 在INIT和热迁移流程中有现成的 save/restore 接口</p><p>原文如下:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>Better to set this up as an MSR (with bit zero enabling, bits 1-5 
features, and 64-byte alignment).  This allows auto-reset on INIT and 
live migration using the existing MSR save/restore infrastructure.

最好将其设置为MSR
  - bit 0: enabling
  - bit 1-5: features
  - 64-byte alignment

他允许在INIT时 auto-reset, 并且可以使用现有的 MSR save/restore 
infrastructure 完成热迁移
</pre></table></code></div></div></blockquote><h3 id="接口流程图"><span class="me-2">接口流程图</span><a href="#接口流程图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details open=""> <summary>图示</summary><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-5816c8c78422729ad7411897407bd311" width="1177pt" height="616pt" viewBox="0.00 0.00 1177.50 615.95"><title>graphviz-5816c8c78422729ad7411897407bd311</title><desc> digraph G { subgraph cluster_host { host_page_not_present [ label=&quot;initiate page \nnot present\n APF&quot; color=&quot;red&quot; ] host_page_present [ label=&quot;initiate page \nhave been\n present APF&quot; color=&quot;green&quot; ] label=&quot;host&quot; } subgraph cluster_guest { pf_handler [ label=&quot;page fault handler&quot; ] guest_invoke_task [ label=&quot;invoke task&quot; ] label=&quot;guest&quot; } cpuid [ shape=&quot;record&quot; label=&quot;cpuid:\n KVM_FEATURE_ASYNC_PF:\n 1&quot; ] subgraph cluster_msr { msr_bit_map [ shape=&quot;record&quot; label=&quot;{ bit0\n enable bit\n value 1(enable)| bit 1-5\n reserved\n value 0| &lt;shm_gpa&gt;bit 63-6\n 64-byte aligned GPA\n value 0xabc }&quot; ] label=&quot;MSR_KVM_ASYNC_PF_EN&quot; } subgraph cluster_cr2 { token [ shape=&quot;record&quot; label=&quot;token: \n unique id&quot; ] label=&quot;cr2&quot; } subgraph cluster_shm { shm [ shape=&quot;record&quot; label=&quot;APF reason&quot; ] label=&quot;share memory&quot; } cpuid-&gt;msr_bit_map [ arrowhead=&quot;none&quot; style=&quot;dashed&quot; label=&quot;indicate apf \nfeature \navailable,\n so access\n MSR_KVM_ASYNC_PF_EN \nis valid&quot; ] msr_bit_map:shm_gpa-&gt;shm [ arrowhead=&quot;none&quot; style=&quot;dashed&quot; label=&quot;point base GPA \nof this share\n memory&quot; ] host_page_not_present-&gt;token [ label=&quot;1. initiate page \nnot present \nAPF, generate \ntoken write \nto CR2&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] host_page_not_present-&gt;shm [ label=&quot;2. update apf \nreason to 1&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] host_page_not_present-&gt;pf_handler [ label=&quot;3. inject page \nnot present \n#APF&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] pf_handler-&gt;shm [ label=&quot;4. get reason \nfrom shm:\n PAGE \nnot present\n&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] pf_handler-&gt;token [ label=&quot;5. get token \nfrom cr2,\nbind sched\n out thread\n and token\n&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] pf_handler-&gt;guest_invoke_task [ label=&quot;6. sched\n out it&quot; color=&quot;red&quot; fontcolor=&quot;red&quot; ] host_page_present-&gt;token [ label=&quot;a. initiate page \n present APF, \nwrite prev \ntoken write \nto CR2&quot; color=&quot;green&quot; fontcolor=&quot;green&quot; ] host_page_present-&gt;shm [ label=&quot;b. update apf \nreason to 2&quot; color=&quot;green&quot; fontcolor=&quot;green&quot; ] host_page_present-&gt;pf_handler [ label=&quot;c. inject page \n present \n#APF&quot; color=&quot;green&quot; fontcolor=&quot;green&quot; ] pf_handler-&gt;shm [ label=&quot;d. get reason \nfrom shm:\nPAGE present &quot; color=&quot;green&quot; fontcolor=&quot;green&quot; ] pf_handler-&gt;token [ label=&quot;e. get token \nfrom cr2,\n find sched \nout thread \nby token&quot; color=&quot;green&quot; fontcolor=&quot;green&quot; ] pf_handler-&gt;guest_invoke_task [ label=&quot;f.wakeup it&quot; color=&quot;green&quot; fontcolor=&quot;green&quot; ] } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 611.95)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-611.95 1173.5,-611.95 1173.5,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_host</title><polygon fill="none" stroke="black" points="223.5,-486 223.5,-599.95 570.5,-599.95 570.5,-486 223.5,-486" /> <text text-anchor="middle" x="397" y="-584.75" font-family="Times,serif" font-size="14.00">host</text> </g> <g id="clust2" class="cluster"><title>cluster_guest</title><polygon fill="none" stroke="black" points="292.5,-9.5 292.5,-316 500.5,-316 500.5,-9.5 292.5,-9.5" /> <text text-anchor="middle" x="396.5" y="-300.8" font-family="Times,serif" font-size="14.00">guest</text> </g> <g id="clust3" class="cluster"><title>cluster_msr</title><polygon fill="none" stroke="black" points="878.5,-179 878.5,-378 1084.5,-378 1084.5,-179 878.5,-179" /> <text text-anchor="middle" x="981.5" y="-362.8" font-family="Times,serif" font-size="14.00">MSR_KVM_ASYNC_PF_EN</text> </g> <g id="clust4" class="cluster"><title>cluster_cr2</title><polygon fill="none" stroke="black" points="23.5,-8 23.5,-86 127.5,-86 127.5,-8 23.5,-8" /> <text text-anchor="middle" x="75.5" y="-70.8" font-family="Times,serif" font-size="14.00">cr2</text> </g> <g id="clust5" class="cluster"><title>cluster_shm</title><polygon fill="none" stroke="black" points="685.5,-9 685.5,-85 804.5,-85 804.5,-9 685.5,-9" /> <text text-anchor="middle" x="745" y="-69.8" font-family="Times,serif" font-size="14.00">share memory</text> </g> <g id="node1" class="node"><title>host_page_not_present</title><ellipse fill="none" stroke="red" cx="484.5" cy="-531.48" rx="78.48" ry="37.45" /> <text text-anchor="middle" x="484.5" y="-542.78" font-family="Times,serif" font-size="14.00">initiate page </text> <text text-anchor="middle" x="484.5" y="-527.78" font-family="Times,serif" font-size="14.00">not present</text> <text text-anchor="middle" x="484.5" y="-512.78" font-family="Times,serif" font-size="14.00"> APF</text> </g> <g id="node3" class="node"><title>pf_handler</title><ellipse fill="none" stroke="black" cx="396.5" cy="-267" rx="96.38" ry="18" /> <text text-anchor="middle" x="396.5" y="-263.3" font-family="Times,serif" font-size="14.00">page fault handler</text> </g> <g id="edge5" class="edge"><title>host_page_not_present&#45;&gt;pf_handler</title><path fill="none" stroke="red" d="M482.19,-494.01C479.48,-464.29 473.7,-421.55 461.5,-386 449.9,-352.21 429,-316.74 414.03,-293.62" /><polygon fill="red" stroke="red" points="416.84,-291.53 408.42,-285.1 411,-295.38 416.84,-291.53" /> <text text-anchor="middle" x="530.5" y="-442.3" font-family="Times,serif" font-size="14.00" fill="red">3. inject page </text> <text text-anchor="middle" x="530.5" y="-427.3" font-family="Times,serif" font-size="14.00" fill="red">not present </text> <text text-anchor="middle" x="530.5" y="-412.3" font-family="Times,serif" font-size="14.00" fill="red">#APF</text> </g> <g id="node7" class="node"><title>token</title><polygon fill="none" stroke="black" points="31.5,-16.5 31.5,-54.5 119.5,-54.5 119.5,-16.5 31.5,-16.5" /> <text text-anchor="middle" x="75.5" y="-39.3" font-family="Times,serif" font-size="14.00">token: </text> <text text-anchor="middle" x="75.5" y="-24.3" font-family="Times,serif" font-size="14.00"> unique id</text> </g> <g id="edge3" class="edge"><title>host_page_not_present&#45;&gt;token</title><path fill="none" stroke="red" d="M469.56,-494.35C452.41,-453.69 425.35,-392.45 415.5,-386 393.17,-371.39 195.34,-395.84 175.5,-378 109.07,-318.29 210.88,-241.93 147.5,-179 123.63,-155.31 94.65,-194.3 72.5,-169 47.69,-140.66 55.83,-94.39 64.93,-64.7" /><polygon fill="red" stroke="red" points="68.34,-65.54 68.14,-54.95 61.69,-63.36 68.34,-65.54" /> <text text-anchor="middle" x="232" y="-293.3" font-family="Times,serif" font-size="14.00" fill="red">1. initiate page </text> <text text-anchor="middle" x="232" y="-278.3" font-family="Times,serif" font-size="14.00" fill="red">not present </text> <text text-anchor="middle" x="232" y="-263.3" font-family="Times,serif" font-size="14.00" fill="red">APF, generate </text> <text text-anchor="middle" x="232" y="-248.3" font-family="Times,serif" font-size="14.00" fill="red">token write </text> <text text-anchor="middle" x="232" y="-233.3" font-family="Times,serif" font-size="14.00" fill="red">to CR2</text> </g> <g id="node8" class="node"><title>shm</title><polygon fill="none" stroke="black" points="695.5,-17.5 695.5,-53.5 793.5,-53.5 793.5,-17.5 695.5,-17.5" /> <text text-anchor="middle" x="744.5" y="-31.8" font-family="Times,serif" font-size="14.00">APF reason</text> </g> <g id="edge4" class="edge"><title>host_page_not_present&#45;&gt;shm</title><path fill="none" stroke="red" d="M539.43,-504.51C554.89,-496.24 571.33,-486.49 585.5,-476 635.25,-439.15 651.66,-430.49 684.5,-378 736.52,-294.83 739.51,-265.79 755.5,-169 760.93,-136.11 758.64,-127.18 755.5,-94 754.56,-84.08 752.72,-73.31 750.82,-63.82" /><polygon fill="red" stroke="red" points="754.18,-62.8 748.68,-53.74 747.33,-64.25 754.18,-62.8" /> <text text-anchor="middle" x="802.5" y="-270.8" font-family="Times,serif" font-size="14.00" fill="red">2. update apf </text> <text text-anchor="middle" x="802.5" y="-255.8" font-family="Times,serif" font-size="14.00" fill="red">reason to 1</text> </g> <g id="node2" class="node"><title>host_page_present</title><ellipse fill="none" stroke="green" cx="309.5" cy="-531.48" rx="78.48" ry="37.45" /> <text text-anchor="middle" x="309.5" y="-542.78" font-family="Times,serif" font-size="14.00">initiate page </text> <text text-anchor="middle" x="309.5" y="-527.78" font-family="Times,serif" font-size="14.00">have been</text> <text text-anchor="middle" x="309.5" y="-512.78" font-family="Times,serif" font-size="14.00"> present APF</text> </g> <g id="edge11" class="edge"><title>host_page_present&#45;&gt;pf_handler</title><path fill="none" stroke="green" d="M304.05,-493.85C301,-464.03 299.85,-421.25 311.5,-386 323.61,-349.33 351.6,-314.35 372.16,-292.14" /><polygon fill="green" stroke="green" points="374.75,-294.5 379.09,-284.83 369.67,-289.68 374.75,-294.5" /> <text text-anchor="middle" x="361.5" y="-442.3" font-family="Times,serif" font-size="14.00" fill="green">c. inject page </text> <text text-anchor="middle" x="361.5" y="-427.3" font-family="Times,serif" font-size="14.00" fill="green"> present </text> <text text-anchor="middle" x="361.5" y="-412.3" font-family="Times,serif" font-size="14.00" fill="green">#APF</text> </g> <g id="edge9" class="edge"><title>host_page_present&#45;&gt;token</title><path fill="none" stroke="green" d="M240.19,-513.53C174.44,-493.36 79.37,-452.62 35.5,-378 -28.51,-269.14 7.18,-214.65 44.5,-94 47.74,-83.52 52.96,-72.75 58.2,-63.4" /><polygon fill="green" stroke="green" points="61.32,-64.99 63.37,-54.59 55.29,-61.44 61.32,-64.99" /> <text text-anchor="middle" x="91.5" y="-293.3" font-family="Times,serif" font-size="14.00" fill="green">a. initiate page </text> <text text-anchor="middle" x="91.5" y="-278.3" font-family="Times,serif" font-size="14.00" fill="green"> present APF, </text> <text text-anchor="middle" x="91.5" y="-263.3" font-family="Times,serif" font-size="14.00" fill="green">write prev </text> <text text-anchor="middle" x="91.5" y="-248.3" font-family="Times,serif" font-size="14.00" fill="green">token write </text> <text text-anchor="middle" x="91.5" y="-233.3" font-family="Times,serif" font-size="14.00" fill="green">to CR2</text> </g> <g id="edge10" class="edge"><title>host_page_present&#45;&gt;shm</title><path fill="none" stroke="green" d="M362.84,-503.74C385.35,-492.13 407.35,-480.23 411.5,-476 442.97,-443.95 421.29,-412.59 457.5,-386 474.58,-373.46 488.12,-391.44 504.5,-378 577.68,-317.93 504.35,-235.26 580.5,-179 607.37,-159.15 706.42,-192.16 730.5,-169 758.38,-142.17 755.8,-93.83 750.67,-63.55" /><polygon fill="green" stroke="green" points="754.09,-62.82 748.79,-53.65 747.21,-64.13 754.09,-62.82" /> <text text-anchor="middle" x="630.5" y="-270.8" font-family="Times,serif" font-size="14.00" fill="green">b. update apf </text> <text text-anchor="middle" x="630.5" y="-255.8" font-family="Times,serif" font-size="14.00" fill="green">reason to 2</text> </g> <g id="node4" class="node"><title>guest_invoke_task</title><ellipse fill="none" stroke="black" cx="392.5" cy="-35.5" rx="63.89" ry="18" /> <text text-anchor="middle" x="392.5" y="-31.8" font-family="Times,serif" font-size="14.00">invoke task</text> </g> <g id="edge8" class="edge"><title>pf_handler&#45;&gt;guest_invoke_task</title><path fill="none" stroke="red" d="M397.42,-248.9C398.92,-217.96 401.45,-150.66 398.5,-94 397.98,-84.1 396.97,-73.27 395.92,-63.71" /><polygon fill="red" stroke="red" points="399.38,-63.1 394.75,-53.57 392.42,-63.91 399.38,-63.1" /> <text text-anchor="middle" x="429.5" y="-135.3" font-family="Times,serif" font-size="14.00" fill="red">6. sched</text> <text text-anchor="middle" x="429.5" y="-120.3" font-family="Times,serif" font-size="14.00" fill="red"> out it</text> </g> <g id="edge14" class="edge"><title>pf_handler&#45;&gt;guest_invoke_task</title><path fill="none" stroke="green" d="M375.92,-249.23C356.11,-231.64 327.46,-202 315.5,-169 304.13,-137.66 300.56,-123.8 315.5,-94 323.36,-78.31 337.76,-65.81 352,-56.52" /><polygon fill="green" stroke="green" points="354.07,-59.36 360.78,-51.16 350.42,-53.38 354.07,-59.36" /> <text text-anchor="middle" x="355" y="-127.8" font-family="Times,serif" font-size="14.00" fill="green">f.wakeup it</text> </g> <g id="edge7" class="edge"><title>pf_handler&#45;&gt;token</title><path fill="none" stroke="red" d="M380.85,-248.96C361.04,-228.58 324.85,-195.21 286.5,-179 255.12,-165.73 237.16,-190.21 210.5,-169 182.66,-146.84 205.89,-120.81 182.5,-94 168.14,-77.55 147.89,-64.99 128.86,-55.88" /><polygon fill="red" stroke="red" points="130.2,-52.65 119.65,-51.68 127.3,-59.02 130.2,-52.65" /> <text text-anchor="middle" x="256" y="-157.8" font-family="Times,serif" font-size="14.00" fill="red">5. get token </text> <text text-anchor="middle" x="256" y="-142.8" font-family="Times,serif" font-size="14.00" fill="red">from cr2,</text> <text text-anchor="middle" x="256" y="-127.8" font-family="Times,serif" font-size="14.00" fill="red">bind sched</text> <text text-anchor="middle" x="256" y="-112.8" font-family="Times,serif" font-size="14.00" fill="red"> out thread</text> <text text-anchor="middle" x="256" y="-97.8" font-family="Times,serif" font-size="14.00" fill="red"> and token</text> </g> <g id="edge13" class="edge"><title>pf_handler&#45;&gt;token</title><path fill="none" stroke="green" d="M381.74,-249.17C362.3,-228.35 325.92,-193.83 286.5,-179 265.88,-171.24 104.44,-184.2 88.5,-169 74.05,-155.22 73.18,-99.67 74.14,-65.02" /><polygon fill="green" stroke="green" points="77.66,-64.7 74.51,-54.59 70.66,-64.46 77.66,-64.7" /> <text text-anchor="middle" x="133.5" y="-157.8" font-family="Times,serif" font-size="14.00" fill="green">e. get token </text> <text text-anchor="middle" x="133.5" y="-142.8" font-family="Times,serif" font-size="14.00" fill="green">from cr2,</text> <text text-anchor="middle" x="133.5" y="-127.8" font-family="Times,serif" font-size="14.00" fill="green"> find sched </text> <text text-anchor="middle" x="133.5" y="-112.8" font-family="Times,serif" font-size="14.00" fill="green">out thread </text> <text text-anchor="middle" x="133.5" y="-97.8" font-family="Times,serif" font-size="14.00" fill="green">by token</text> </g> <g id="edge6" class="edge"><title>pf_handler&#45;&gt;shm</title><path fill="none" stroke="red" d="M421.5,-249.53C452.42,-229.89 507.28,-197.41 558.5,-179 579.82,-171.33 591.69,-184.2 608.5,-169 634.35,-145.61 609.07,-120.69 631.5,-94 645.8,-76.98 666.41,-64.44 686.12,-55.49" /><polygon fill="red" stroke="red" points="687.58,-58.67 695.39,-51.51 684.82,-52.24 687.58,-58.67" /> <text text-anchor="middle" x="681" y="-150.3" font-family="Times,serif" font-size="14.00" fill="red">4. get reason </text> <text text-anchor="middle" x="681" y="-135.3" font-family="Times,serif" font-size="14.00" fill="red">from shm:</text> <text text-anchor="middle" x="681" y="-120.3" font-family="Times,serif" font-size="14.00" fill="red"> PAGE </text> <text text-anchor="middle" x="681" y="-105.3" font-family="Times,serif" font-size="14.00" fill="red">not present</text> </g> <g id="edge12" class="edge"><title>pf_handler&#45;&gt;shm</title><path fill="none" stroke="green" d="M409.39,-248.98C423.5,-229.99 446.38,-198.11 463.5,-169 482.33,-136.96 471.41,-117.14 500.5,-94 553.29,-52 631.61,-39.78 685.19,-36.68" /><polygon fill="green" stroke="green" points="685.41,-40.17 695.23,-36.19 685.07,-33.18 685.41,-40.17" /> <text text-anchor="middle" x="552.5" y="-142.8" font-family="Times,serif" font-size="14.00" fill="green">d. get reason </text> <text text-anchor="middle" x="552.5" y="-127.8" font-family="Times,serif" font-size="14.00" fill="green">from shm:</text> <text text-anchor="middle" x="552.5" y="-112.8" font-family="Times,serif" font-size="14.00" fill="green">PAGE present </text> </g> <g id="node5" class="node"><title>cpuid</title><polygon fill="none" stroke="black" points="860,-504.98 860,-557.98 1081,-557.98 1081,-504.98 860,-504.98" /> <text text-anchor="middle" x="970.5" y="-542.78" font-family="Times,serif" font-size="14.00">cpuid:</text> <text text-anchor="middle" x="970.5" y="-527.78" font-family="Times,serif" font-size="14.00"> KVM_FEATURE_ASYNC_PF:</text> <text text-anchor="middle" x="970.5" y="-512.78" font-family="Times,serif" font-size="14.00"> 1</text> </g> <g id="node6" class="node"><title>msr_bit_map</title><polygon fill="none" stroke="black" points="887.5,-187.5 887.5,-346.5 1053.5,-346.5 1053.5,-187.5 887.5,-187.5" /> <text text-anchor="middle" x="970.5" y="-331.3" font-family="Times,serif" font-size="14.00">bit0</text> <text text-anchor="middle" x="970.5" y="-316.3" font-family="Times,serif" font-size="14.00"> enable bit</text> <text text-anchor="middle" x="970.5" y="-301.3" font-family="Times,serif" font-size="14.00"> value 1(enable)</text><polyline fill="none" stroke="black" points="887.5,-293.5 1053.5,-293.5 " /> <text text-anchor="middle" x="970.5" y="-278.3" font-family="Times,serif" font-size="14.00">bit 1&#45;5</text> <text text-anchor="middle" x="970.5" y="-263.3" font-family="Times,serif" font-size="14.00"> reserved</text> <text text-anchor="middle" x="970.5" y="-248.3" font-family="Times,serif" font-size="14.00"> value 0</text><polyline fill="none" stroke="black" points="887.5,-240.5 1053.5,-240.5 " /> <text text-anchor="middle" x="970.5" y="-225.3" font-family="Times,serif" font-size="14.00">bit 63&#45;6</text> <text text-anchor="middle" x="970.5" y="-210.3" font-family="Times,serif" font-size="14.00"> 64&#45;byte aligned GPA</text> <text text-anchor="middle" x="970.5" y="-195.3" font-family="Times,serif" font-size="14.00"> value 0xabc</text> </g> <g id="edge1" class="edge"><title>cpuid&#45;&gt;msr_bit_map</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M970.5,-504.83C970.5,-468.52 970.5,-400.55 970.5,-346.7" /> <text text-anchor="middle" x="1070" y="-464.8" font-family="Times,serif" font-size="14.00">indicate apf </text> <text text-anchor="middle" x="1070" y="-449.8" font-family="Times,serif" font-size="14.00">feature </text> <text text-anchor="middle" x="1070" y="-434.8" font-family="Times,serif" font-size="14.00">available,</text> <text text-anchor="middle" x="1070" y="-419.8" font-family="Times,serif" font-size="14.00"> so access</text> <text text-anchor="middle" x="1070" y="-404.8" font-family="Times,serif" font-size="14.00"> MSR_KVM_ASYNC_PF_EN </text> <text text-anchor="middle" x="1070" y="-389.8" font-family="Times,serif" font-size="14.00">is valid</text> </g> <g id="edge2" class="edge"><title>msr_bit_map:shm_gpa&#45;&gt;shm</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M886.5,-214C869.9,-214 882.11,-193.18 873.5,-179 842.5,-127.94 791.78,-78.62 764.07,-53.56" /> <text text-anchor="middle" x="923" y="-142.8" font-family="Times,serif" font-size="14.00">point base GPA </text> <text text-anchor="middle" x="923" y="-127.8" font-family="Times,serif" font-size="14.00">of this share</text> <text text-anchor="middle" x="923" y="-112.8" font-family="Times,serif" font-size="14.00"> memory</text> </g> </g> </svg></div>图中描述了host, guest在处理async pf时, 对寄存器/share memory 的操作 </details><p>从图中可以看出, 会涉及到<code class="language-plaintext highlighter-rouge">cpuid</code>, <code class="language-plaintext highlighter-rouge">MSR_KVM_ASYNC_PF_EN</code>, <code class="language-plaintext highlighter-rouge">share memory</code>, 由于async pf 的实现,需要注入#PF, 所以还会涉及 CR2</p><h4 id="cpuid"><span class="me-2">cpuid</span><a href="#cpuid" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>新增半虚拟化cpuid bit: <code class="language-plaintext highlighter-rouge">KVM_FEATURE_ASYNC_PF</code></p><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gh">diff --git a/arch/x86/include/asm/kvm_para.h b/arch/x86/include/asm/kvm_para.h
</span><span class="gi">+#define KVM_FEATURE_ASYNC_PF		4
</span></pre></table></code></div></div><p>关于该bit的文档说明</p><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gh">diff --git a/Documentation/kvm/cpuid.txt b/Documentation/kvm/cpuid.txt
</span><span class="gi">+KVM_FEATURE_ASYNC_PF               ||     4 || async pf can be enabled by
+                                   ||       || writing to msr 0x4b564d02
</span></pre></table></code></div></div><p>大致意思是, 该cpuid如果时能, 表示可以通过write to MSR (0x4b564d02) 来enable async pf</p><h4 id="msr--share-memaddr--enable-bit"><span class="me-2">MSR – share memaddr &amp;&amp; enable bit</span><a href="#msr--share-memaddr--enable-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gh">diff --git a/arch/x86/include/asm/kvm_para.h b/arch/x86/include/asm/kvm_para.h
</span><span class="gi">+#define MSR_KVM_ASYNC_PF_EN 0x4b564d02
</span><span class="err">
</span></pre></table></code></div></div><p>文档说明:</p><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="gh">diff --git a/Documentation/kvm/msr.txt b/Documentation/kvm/msr.txt
</span><span class="gi">+ MSR_KVM_ASYNC_PF_EN: 0x4b564d02
+   data: Bits 63-6 hold 64-byte aligned physical address of a
+   64 byte memory area which must be in guest RAM and must be
+   zeroed. Bits 5-1 are reserved and should be zero. Bit 0 is 1
+   when asynchronous page faults are enabled on the vcpu 0 when
+   disabled.
</span>    
    &gt; Bits 63-6 保存着 64-byte 对其的 一个64 byte memory area 的物理地址,
    &gt; 该memory area 必须是 guest RAM, 并且必须是被赋值为0. 
    &gt;
    &gt; Bit 5-1 被reserved并且应该为0.
    &gt;
    &gt; 当 在 vcpu 0 启用 async pf enable async pf(当是disable时), 
    &gt; Bit 0 是1
</pre></table></code></div></div><p>该段主要介绍了MSR的 bit 组成:</p><ul><li>MSR bit<ul><li><strong>Bit [63, 6]</strong>: a 64-byte aligned physical address<li><strong>Bit [5, 1]</strong>: reserved<li><strong>Bit 0</strong> : enable bit</ul></ul><blockquote><p class="prompt-info">其实文档中还介绍了. share memory format 和 CR2, 但是为了方便阅读, 我们将拆分开到各个 小节</p></blockquote><h4 id="shared-memory-structure--apf-reason"><span class="me-2">shared memory structure – APF reason</span><a href="#shared-memory-structure--apf-reason" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="gh">diff --git a/Documentation/kvm/msr.txt b/Documentation/kvm/msr.txt
</span>    ...
<span class="gi">+   First 4 byte of 64 byte memory location will be written to by
+   the hypervisor at the time of asynchronous page fault (APF)
+   injection to indicate type of asynchronous page fault. Value
+   of 1 means that the page referred to by the page fault is not
+   present. Value 2 means that the page is now available. Disabling
+   interrupt inhibits APFs. Guest must not enable interrupt
+   before the reason is read, or it may be overwritten by another
+   APF. Since APF uses the same exception vector as regular page
+   fault guest must reset the reason to 0 before it does
+   something that can generate normal page fault.  If during page
+   fault APF reason is 0 it means that this is regular page
+   fault.
</span><span class="err">
</span>    &gt; 在 hypervisor 触发 APF 注入时, 4 byte memory location的前4个byte将被
    &gt; 写入 来指示 APF 的类型. 
    &gt;    1: page fault 涉及到的page 是 not present的.
    &gt;    2: page 现在已经 available
    &gt; 另外Disabling interrupt 将会 inhibits APF.
    &gt;
    &gt; Guest必须不能enable interrupt 在reason 被read之前, 否则可能会被另一个
    &gt; APF覆盖. 因为 APF 使用 相同的 exception vector 作为 regular page
    &gt; fault, 所以在做可能生成normal page fault 的事情之前, guest 必须 reset 
    &gt; reason to 0. 如果 在 page fault 期间, APF reason 为0, 他意味着这是一个
    &gt; regular page fault.
</pre></table></code></div></div><p>shared memory 一共有64 byte, 其中前4个byte(32 bit) 用来indicate apf type. host kvm 在注入 apf之前会将type写入该地址.</p><p>APF 有两种type(APF reason):</p><ul><li><code class="language-plaintext highlighter-rouge">1</code>: page is not present<li><code class="language-plaintext highlighter-rouge">2</code>: not present page becomes available</ul><p>另外, 在处理APF时, guest和host有下面约束:</p><ul><li>如果guest处于 disable interrupt, host不能注入apf<li>guest必须在enable interrupt 之前, 处理完当前的apf<li>guest必须在触发 normal #PF时, 处理完当前的apf, 并且reset reason to 0</ul><h4 id="cr2"><span class="me-2">CR2</span><a href="#cr2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="gh">diff --git a/Documentation/kvm/msr.txt b/Documentation/kvm/msr.txt
</span>    ...
<span class="gi">+   During delivery of type 1 APF cr2 contains a token that will
+   be used to notify a guest when missing page becomes
+   available. When page becomes available type 2 APF is sent with
+   cr2 set to the token associated with the page. There is special
+   kind of token 0xffffffff which tells vcpu that it should wake
+   up all processes waiting for APFs and no individual type 2 APFs
+   will be sent.
</span><span class="err">
</span>    &gt; 在 type1 APF delivery 期间,  cr2 包含了一个token, 当missing page 
    &gt; becomes available, 该token将会用于通知guest. 
    &gt;
    &gt; 当page becomes available, type2 APF 将会把 cr2 设置为和该page相关的 
    &gt; token. 
    &gt;
    &gt; 这里有一个特殊的类型 token 0xffffffff, 他将告诉vcpu, 需要wakeup 所有
    &gt; 等待APF的process 并且不会有单独的 type 2 APF 将会再发送
    
<span class="gi">+   If APF is disabled while there are outstanding APFs, they will
+   not be delivered.
</span><span class="err">
</span>    &gt; 当 outstanding APFs时, 如果APF 被disabled, 他们将不会被delivered.
    
<span class="gi">+   Currently type 2 APF will be always delivered on the same vcpu as
+   type 1 was, but guest should not rely on that.
</span><span class="err">
</span>    &gt; 当前 type 2 APF 将始终在与type 1 相同的vcpu上deliver, 但是guest不应该依赖它.
</pre></table></code></div></div><p>cr2 包含了一个token, 该token 用来唯一标识, 当前正在发生的APF 的 id. 但是其有一个特殊 value 0xffffffff, 该值用来告诉vcpu, 需要wakeup所有的正在等待 APF (type 2) 的 进程. 并且不会有单独的type2再发送.</p><p>另外还有几点约束和限制</p><ul><li>如果还有 outstanding APFs 时, 如果 APF 被disable了, 他们将不会被deliver<li>guest 不应该依赖 type2 APF 和 type1 APF在相同vcpu上deliver, 虽然目前是这样实现的.</ul><blockquote class="prompt-tip"><p>大家可以思考下, 为什么要支持wake up all这样的API</p><p>可以想象一下热迁移场景.</p><p>当进行热迁移时, 我们先suspend vcpu, 然后迁移memory, 这时, 会等所有page swapin,然后 在进行迁移, 但是这时, guest已经不能再去注入异常了, 只能等dest端在注入.</p><p>此时来到dest端, 这时所有的memory都是present的. 所以直接注入wakeup all就可以唤醒所有 wait task.(当然, 也可能再此期间有swapout, 无非是再触发一次async pf)</p></blockquote><h3 id="gup-change"><span class="me-2">GUP change</span><a href="#gup-change" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>关于GUP 改动的细节我们放到</p><p><a href="/posts/async-pf-gup-change">link</a></p><p>中介绍.</p><h3 id="struct--host"><span class="me-2">STRUCT – host</span><a href="#struct--host" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="总体数据结构图"><span class="me-2">总体数据结构图</span><a href="#总体数据结构图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>比较简单, 如下:</p><hr /><hr /> <details open=""> <summary>struct 结构图</summary><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-7842836ccacf1278b495c08c9dc5b30c" width="654pt" height="694pt" viewBox="0.00 0.00 654.00 694.00"><title>graphviz-7842836ccacf1278b495c08c9dc5b30c</title><desc> digraph G { subgraph cluster_vcpu0 { kvm_vcpu0 [ shape=&quot;record&quot; label=&quot;{struct kvm_vcpu||&lt;queue&gt;queue|&lt;done&gt;done}&quot; ] subgraph cluster_uncomplete_work { work_uncomplete_1 [ shape=&quot;record&quot; label=&quot;{kvm_vcpu_pf||&lt;queue&gt;queue|&lt;link&gt;link}&quot; ] work_uncomplete_2 [ shape=&quot;record&quot; label=&quot;{kvm_vcpu_pf||&lt;queue&gt;queue|&lt;link&gt;link}&quot; ] label=&quot;uncomplete work&quot; } subgraph cluster_done_work { work_done_1 [ shape=&quot;record&quot; label=&quot;{kvm_vcpu_pf||&lt;queue&gt;queue|&lt;link&gt;link}&quot; ] work_done_2 [ shape=&quot;record&quot; label=&quot;{kvm_vcpu_pf||&lt;queue&gt;queue|&lt;link&gt;link}&quot; ] label=&quot;done work&quot; } label = &quot;vcpu 0&quot; } kvm_vcpu0:queue-&gt; work_done_1:queue-&gt; work_done_2:queue-&gt; work_uncomplete_1:queue-&gt; work_uncomplete_2:queue [ color=&quot;red&quot; ] kvm_vcpu0:done-&gt; work_done_1:link-&gt; work_done_2:link [ color=&quot;blue&quot; ] subgraph cluster_vcpu1 { kvm_vcpu1 [ shape=&quot;record&quot; label=&quot;struct kvm_vcpu&quot; ] work_5 [ shape=&quot;record&quot; label=&quot;kvm_vcpu_pf&quot; ] work_6 [ shape=&quot;record&quot; label=&quot;kvm_vcpu_pf&quot; ] label = &quot;vcpu 1&quot; kvm_vcpu1-&gt;work_5-&gt;work_6 } subgraph cluster_vcpu2 { kvm_vcpu2 [ shape=&quot;record&quot; label=&quot;struct kvm_vcpu&quot; ] work_7 [ shape=&quot;record&quot; label=&quot;kvm_vcpu_pf&quot; ] work_8 [ shape=&quot;record&quot; label=&quot;kvm_vcpu_pf&quot; ] label = &quot;vcpu 2&quot; kvm_vcpu2-&gt;work_7-&gt;work_8 } subgraph cluster_vcpu3 { kvm_vcpu3 [ shape=&quot;record&quot; label=&quot;struct kvm_vcpu&quot; ] work_9 [ shape=&quot;record&quot; label=&quot;kvm_vcpu_pf&quot; ] work_10 [ shape=&quot;record&quot; label=&quot;kvm_vcpu_pf&quot; ] label = &quot;vcpu 3&quot; kvm_vcpu3-&gt;work_9-&gt;work_10 } } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 690)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-690 650,-690 650,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_vcpu0</title><polygon fill="none" stroke="black" points="8,-8 8,-678 164,-678 164,-8 8,-8" /> <text text-anchor="middle" x="86" y="-662.8" font-family="Times,serif" font-size="14.00">vcpu 0</text> </g> <g id="clust2" class="cluster"><title>cluster_uncomplete_work</title><polygon fill="none" stroke="black" points="16,-16 16,-277 156,-277 156,-16 16,-16" /> <text text-anchor="middle" x="86" y="-261.8" font-family="Times,serif" font-size="14.00">uncomplete work</text> </g> <g id="clust3" class="cluster"><title>cluster_done_work</title><polygon fill="none" stroke="black" points="24,-285 24,-546 148,-546 148,-285 24,-285" /> <text text-anchor="middle" x="86" y="-530.8" font-family="Times,serif" font-size="14.00">done work</text> </g> <g id="clust4" class="cluster"><title>cluster_vcpu1</title><polygon fill="none" stroke="black" points="172,-313 172,-650 322,-650 322,-313 172,-313" /> <text text-anchor="middle" x="247" y="-634.8" font-family="Times,serif" font-size="14.00">vcpu 1</text> </g> <g id="clust5" class="cluster"><title>cluster_vcpu2</title><polygon fill="none" stroke="black" points="330,-313 330,-650 480,-650 480,-313 330,-313" /> <text text-anchor="middle" x="405" y="-634.8" font-family="Times,serif" font-size="14.00">vcpu 2</text> </g> <g id="clust6" class="cluster"><title>cluster_vcpu3</title><polygon fill="none" stroke="black" points="488,-313 488,-650 638,-650 638,-313 488,-313" /> <text text-anchor="middle" x="563" y="-634.8" font-family="Times,serif" font-size="14.00">vcpu 3</text> </g> <g id="node1" class="node"><title>kvm_vcpu0</title><polygon fill="none" stroke="black" points="19,-554.5 19,-646.5 153,-646.5 153,-554.5 19,-554.5" /> <text text-anchor="middle" x="86" y="-631.3" font-family="Times,serif" font-size="14.00">struct kvm_vcpu</text><polyline fill="none" stroke="black" points="19,-623.5 153,-623.5 " /> <text text-anchor="middle" x="86" y="-608.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="19,-600.5 153,-600.5 " /> <text text-anchor="middle" x="86" y="-585.3" font-family="Times,serif" font-size="14.00">queue</text><polyline fill="none" stroke="black" points="19,-577.5 153,-577.5 " /> <text text-anchor="middle" x="86" y="-562.3" font-family="Times,serif" font-size="14.00">done</text> </g> <g id="node4" class="node"><title>work_done_1</title><polygon fill="none" stroke="black" points="32,-422.5 32,-514.5 140,-514.5 140,-422.5 32,-422.5" /> <text text-anchor="middle" x="86" y="-499.3" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text><polyline fill="none" stroke="black" points="32,-491.5 140,-491.5 " /> <text text-anchor="middle" x="86" y="-476.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="32,-468.5 140,-468.5 " /> <text text-anchor="middle" x="86" y="-453.3" font-family="Times,serif" font-size="14.00">queue</text><polyline fill="none" stroke="black" points="32,-445.5 140,-445.5 " /> <text text-anchor="middle" x="86" y="-430.3" font-family="Times,serif" font-size="14.00">link</text> </g> <g id="edge1" class="edge"><title>kvm_vcpu0:queue&#45;&gt;work_done_1:queue</title><path fill="none" stroke="red" d="M154,-588.5C166.55,-588.5 158.99,-492.78 147.36,-464.36" /><polygon fill="red" stroke="red" points="150.01,-462.07 141,-456.5 144.57,-466.48 150.01,-462.07" /> </g> <g id="edge5" class="edge"><title>kvm_vcpu0:done&#45;&gt;work_done_1:link</title><path fill="none" stroke="blue" d="M86,-554C86,-524.4 126.36,-541.28 140,-515 154.86,-486.37 172.78,-444.09 150.93,-435.18" /><polygon fill="blue" stroke="blue" points="151.44,-431.72 141,-433.5 150.27,-438.62 151.44,-431.72" /> </g> <g id="node2" class="node"><title>work_uncomplete_1</title><polygon fill="none" stroke="black" points="32,-153.5 32,-245.5 140,-245.5 140,-153.5 32,-153.5" /> <text text-anchor="middle" x="86" y="-230.3" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text><polyline fill="none" stroke="black" points="32,-222.5 140,-222.5 " /> <text text-anchor="middle" x="86" y="-207.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="32,-199.5 140,-199.5 " /> <text text-anchor="middle" x="86" y="-184.3" font-family="Times,serif" font-size="14.00">queue</text><polyline fill="none" stroke="black" points="32,-176.5 140,-176.5 " /> <text text-anchor="middle" x="86" y="-161.3" font-family="Times,serif" font-size="14.00">link</text> </g> <g id="node3" class="node"><title>work_uncomplete_2</title><polygon fill="none" stroke="black" points="32,-24.5 32,-116.5 140,-116.5 140,-24.5 32,-24.5" /> <text text-anchor="middle" x="86" y="-101.3" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text><polyline fill="none" stroke="black" points="32,-93.5 140,-93.5 " /> <text text-anchor="middle" x="86" y="-78.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="32,-70.5 140,-70.5 " /> <text text-anchor="middle" x="86" y="-55.3" font-family="Times,serif" font-size="14.00">queue</text><polyline fill="none" stroke="black" points="32,-47.5 140,-47.5 " /> <text text-anchor="middle" x="86" y="-32.3" font-family="Times,serif" font-size="14.00">link</text> </g> <g id="edge4" class="edge"><title>work_uncomplete_1:queue&#45;&gt;work_uncomplete_2:queue</title><path fill="none" stroke="red" d="M141,-187.5C194.75,-187.5 198.11,-74.12 151.08,-59.95" /><polygon fill="red" stroke="red" points="151.4,-56.46 141,-58.5 150.4,-63.39 151.4,-56.46" /> </g> <g id="node5" class="node"><title>work_done_2</title><polygon fill="none" stroke="black" points="32,-293.5 32,-385.5 140,-385.5 140,-293.5 32,-293.5" /> <text text-anchor="middle" x="86" y="-370.3" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text><polyline fill="none" stroke="black" points="32,-362.5 140,-362.5 " /> <text text-anchor="middle" x="86" y="-347.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="32,-339.5 140,-339.5 " /> <text text-anchor="middle" x="86" y="-324.3" font-family="Times,serif" font-size="14.00">queue</text><polyline fill="none" stroke="black" points="32,-316.5 140,-316.5 " /> <text text-anchor="middle" x="86" y="-301.3" font-family="Times,serif" font-size="14.00">link</text> </g> <g id="edge2" class="edge"><title>work_done_1:queue&#45;&gt;work_done_2:queue</title><path fill="none" stroke="red" d="M141,-456.5C166.31,-456.5 169.27,-355.96 149.9,-332.4" /><polygon fill="red" stroke="red" points="151.45,-329.26 141,-327.5 148.07,-335.39 151.45,-329.26" /> </g> <g id="edge6" class="edge"><title>work_done_1:link&#45;&gt;work_done_2:link</title><path fill="none" stroke="blue" d="M86,-422C86,-393.16 126.23,-411.35 140,-386 155.4,-357.65 172.9,-315.15 150.95,-306.19" /><polygon fill="blue" stroke="blue" points="151.45,-302.73 141,-304.5 150.27,-309.63 151.45,-302.73" /> </g> <g id="edge3" class="edge"><title>work_done_2:queue&#45;&gt;work_uncomplete_1:queue</title><path fill="none" stroke="red" d="M141,-327.5C168.71,-327.5 171.74,-216.45 150.09,-192.16" /><polygon fill="red" stroke="red" points="151.5,-188.94 141,-187.5 148.3,-195.17 151.5,-188.94" /> </g> <g id="node6" class="node"><title>kvm_vcpu1</title><polygon fill="none" stroke="black" points="180,-582.5 180,-618.5 314,-618.5 314,-582.5 180,-582.5" /> <text text-anchor="middle" x="247" y="-596.8" font-family="Times,serif" font-size="14.00">struct kvm_vcpu</text> </g> <g id="node7" class="node"><title>work_5</title><polygon fill="none" stroke="black" points="193,-450.5 193,-486.5 301,-486.5 301,-450.5 193,-450.5" /> <text text-anchor="middle" x="247" y="-464.8" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text> </g> <g id="edge7" class="edge"><title>kvm_vcpu1&#45;&gt;work_5</title><path fill="none" stroke="black" d="M247,-582.24C247,-560.48 247,-522.82 247,-497.06" /><polygon fill="black" stroke="black" points="250.5,-496.83 247,-486.83 243.5,-496.83 250.5,-496.83" /> </g> <g id="node8" class="node"><title>work_6</title><polygon fill="none" stroke="black" points="193,-321.5 193,-357.5 301,-357.5 301,-321.5 193,-321.5" /> <text text-anchor="middle" x="247" y="-335.8" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text> </g> <g id="edge8" class="edge"><title>work_5&#45;&gt;work_6</title><path fill="none" stroke="black" d="M247,-450.37C247,-429.26 247,-393.1 247,-368.06" /><polygon fill="black" stroke="black" points="250.5,-367.76 247,-357.76 243.5,-367.76 250.5,-367.76" /> </g> <g id="node9" class="node"><title>kvm_vcpu2</title><polygon fill="none" stroke="black" points="338,-582.5 338,-618.5 472,-618.5 472,-582.5 338,-582.5" /> <text text-anchor="middle" x="405" y="-596.8" font-family="Times,serif" font-size="14.00">struct kvm_vcpu</text> </g> <g id="node10" class="node"><title>work_7</title><polygon fill="none" stroke="black" points="351,-450.5 351,-486.5 459,-486.5 459,-450.5 351,-450.5" /> <text text-anchor="middle" x="405" y="-464.8" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text> </g> <g id="edge9" class="edge"><title>kvm_vcpu2&#45;&gt;work_7</title><path fill="none" stroke="black" d="M405,-582.24C405,-560.48 405,-522.82 405,-497.06" /><polygon fill="black" stroke="black" points="408.5,-496.83 405,-486.83 401.5,-496.83 408.5,-496.83" /> </g> <g id="node11" class="node"><title>work_8</title><polygon fill="none" stroke="black" points="351,-321.5 351,-357.5 459,-357.5 459,-321.5 351,-321.5" /> <text text-anchor="middle" x="405" y="-335.8" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text> </g> <g id="edge10" class="edge"><title>work_7&#45;&gt;work_8</title><path fill="none" stroke="black" d="M405,-450.37C405,-429.26 405,-393.1 405,-368.06" /><polygon fill="black" stroke="black" points="408.5,-367.76 405,-357.76 401.5,-367.76 408.5,-367.76" /> </g> <g id="node12" class="node"><title>kvm_vcpu3</title><polygon fill="none" stroke="black" points="496,-582.5 496,-618.5 630,-618.5 630,-582.5 496,-582.5" /> <text text-anchor="middle" x="563" y="-596.8" font-family="Times,serif" font-size="14.00">struct kvm_vcpu</text> </g> <g id="node13" class="node"><title>work_9</title><polygon fill="none" stroke="black" points="509,-450.5 509,-486.5 617,-486.5 617,-450.5 509,-450.5" /> <text text-anchor="middle" x="563" y="-464.8" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text> </g> <g id="edge11" class="edge"><title>kvm_vcpu3&#45;&gt;work_9</title><path fill="none" stroke="black" d="M563,-582.24C563,-560.48 563,-522.82 563,-497.06" /><polygon fill="black" stroke="black" points="566.5,-496.83 563,-486.83 559.5,-496.83 566.5,-496.83" /> </g> <g id="node14" class="node"><title>work_10</title><polygon fill="none" stroke="black" points="509,-321.5 509,-357.5 617,-357.5 617,-321.5 509,-321.5" /> <text text-anchor="middle" x="563" y="-335.8" font-family="Times,serif" font-size="14.00">kvm_vcpu_pf</text> </g> <g id="edge12" class="edge"><title>work_9&#45;&gt;work_10</title><path fill="none" stroke="black" d="M563,-450.37C563,-429.26 563,-393.1 563,-368.06" /><polygon fill="black" stroke="black" points="566.5,-367.76 563,-357.76 559.5,-367.76 566.5,-367.76" /> </g> </g> </svg></div><p>每个cpu有自己链表, 串起属于该cpu的<code class="language-plaintext highlighter-rouge">async pf work</code>, 其中有两条链.</p><ul><li> <font color="red"><b>queue:</b></font><p>串起所有work</p><li> <font color="blue"><b>done:</b></font><p>串起所有完成的work</p></ul></details><hr /><hr /><h4 id="struct-kvm_async_pf"><span class="me-2">struct kvm_async_pf</span><a href="#struct-kvm_async_pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>该数据结构主要用来描述上面提到的<code class="language-plaintext highlighter-rouge">dedicated thread</code></p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_async_pf</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">work_struct</span> <span class="n">work</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">link</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">queue</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
        <span class="n">gva_t</span> <span class="n">gva</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_arch_async_pf</span> <span class="n">arch</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">done</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><ul><li><strong>work</strong>: <code class="language-plaintext highlighter-rouge">dedicated thread</code>实例, 使用 workqueue机制<li><strong>link</strong>: 在patch中, 链接点主要有一个: vcpu 的work完成队列<li><strong>queue</strong>: 用于链接该vcpu上的所有 <code class="language-plaintext highlighter-rouge">kvm_async_pf</code><li><strong>gva</strong>: 触发EPT violation, 需要<code class="language-plaintext highlighter-rouge">get_user_page_slow</code>的 GVA<li><strong>addr</strong>: hva<li><strong>done</strong>: indicate该work完没完成<li><strong>kvm_arch_async_pf</strong>:<div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_arch_async_pf</span> <span class="p">{</span>
        <span class="n">u32</span> <span class="n">token</span><span class="p">;</span>
        <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><ul><li><strong>token</strong>: 该成员用于唯一标识一次<code class="language-plaintext highlighter-rouge">async PF</code>, 由<code class="language-plaintext highlighter-rouge">kvm_vcpu.arch.apf.id</code>和 <code class="language-plaintext highlighter-rouge">vcpu-&gt;vcpu_id</code>综合计算得到. 在注入#PF时, 会当作 <code class="language-plaintext highlighter-rouge">CR2</code> 传入GUEST, 方便guest管理每一次的async PF.</ul></ul><p>上面说提到的<code class="language-plaintext highlighter-rouge">kvm_async_pf-&gt;link</code>,<code class="language-plaintext highlighter-rouge">kvm_async_pf-&gt;queue</code>所链接的队列, 如下:</p><h4 id="change-of-struct-kvm_vcpu"><span class="me-2">CHANGE of <code class="language-plaintext highlighter-rouge">struct kvm_vcpu</code></span><a href="#change-of-struct-kvm_vcpu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">@@ -104,6 +125,15 @@</span> struct kvm_vcpu {
    gpa_t mmio_phys_addr;
 #endif
<span class="err">
</span><span class="gi">+#ifdef CONFIG_KVM_ASYNC_PF
+   struct {
+       u32 queued;
+       struct list_head queue;
+       struct list_head done;
+       spinlock_t lock;
+   } async_pf;
+#endif
</span></pre></table></code></div></div><ul><li><strong>queue</strong>: 链接所有<code class="language-plaintext highlighter-rouge">kvm_async_pf</code>(work)<li><strong>done</strong>: 链接以完成的<code class="language-plaintext highlighter-rouge">kvm_async_pf</code>(work)<li><strong>lock</strong>: 队列锁</ul><h4 id="change-of-struct-kvm_vcpu_arch"><span class="me-2">change of <code class="language-plaintext highlighter-rouge">struct kvm_vcpu_arch</code></span><a href="#change-of-struct-kvm_vcpu_arch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">struct kvm_vcpu_arch {
</span>    ...
<span class="gi">+   struct {
+           bool halted;
+           gfn_t gfns[roundup_pow_of_two(ASYNC_PF_PER_VCPU)];
+           struct gfn_to_hva_cache data;
+           u64 msr_val;
+           u32 id;
+           bool send_user_only;
+   } apf;
</span>    ...
}
</pre></table></code></div></div><blockquote class="prompt-info"><p>该数据结构变动涉及多个patch, 这里把最终的数据结构变动列出.</p></blockquote><ul><li><strong>halted</strong>: 表示是否因为async PF halt 了vcpu<li><strong>gfns</strong> : 这里做了一个数组, 用于记录所有现存的async pf work 的 gfn<li><p><strong>data</strong>: 相当于<code class="language-plaintext highlighter-rouge">HVA-&gt;HPA</code>的cache, 这个映射关系一直存在且不变(大多数情况下, 除非执行<code class="language-plaintext highlighter-rouge">__kvm_set_memory_region</code>更改映射关系), 该HPA 指向上面提到的 share memory</p><blockquote class="prompt-tip"><p>该部分被作者做成了一个通用功能, 相当于是 <code class="language-plaintext highlighter-rouge">memslot-cached kvm_put_guest() and kvm_get_guest().</code> 我们放到<a href="/posts/async-pf-gfn2hva-cache">另一篇文章</a>中介绍. 主要介绍 这个功能引入和其实现.</p></blockquote><li><strong>msr_val</strong>: 记录guest设置的msr值<li><strong>id</strong>: 记录下一个async pf work的id, 和<code class="language-plaintext highlighter-rouge">kvm_vcpu-&gt;vcpu_id</code>一起,唯一标识一次async PF<li><strong>send_user_only</strong>: 表示只有trigger EPT violation in guest user space, host才能做async PF</ul><h3 id="struct---guest"><span class="me-2">STRUCT - GUEST</span><a href="#struct---guest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>guest 数据结构主要是用于管理, 因为async PF 调度出去的task.</p><h4 id="数据结构图"><span class="me-2">数据结构图</span><a href="#数据结构图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><details open=""> <summary>数据结构图</summary><div class="graphviz-wrapper"> <svg role="img" aria-label="graphviz-e889c62c04290bdb7d5685fb187da7d7" width="852pt" height="727pt" viewBox="0.00 0.00 852.19 727.00"><title>graphviz-e889c62c04290bdb7d5685fb187da7d7</title><desc> digraph G { sleep_head [ shape=&quot;record&quot; label=&quot;{ kvm_task_sleep_head|| [0]| &lt;key0&gt;link(key0)|| [1]| &lt;key1&gt;link(key1)|| [2]| &lt;key2&gt;link(key2) }&quot; ] subgraph cluster_cpu0 { sleep_node0 [ shape=&quot;record&quot; label=&quot;{ kvm_task_sleep_node|| &lt;link&gt;link| token=[id=0, vcpu=0]| cpu=0| mm=mm_struct of task0| halted=false }&quot; ] sleep_node1 [ shape=&quot;record&quot; label=&quot;{ kvm_task_sleep_node|| &lt;link&gt;link| token=[id=1, vcpu=0]| cpu=0| mm=mm_struct of task1| halted=false }&quot; ] run_task_vcpu0 [ label=&quot;current task: task2&quot; shape=&quot;record&quot; color=&quot;red&quot; ] label=&quot;cpu0 RUNNING&quot; } subgraph cluster_cpu1 { run_task_vcpu1 [ label=&quot;current task: task4&quot; shape=&quot;record&quot; color=&quot;red&quot; ] sleep_node3 [ shape=&quot;record&quot; label=&quot;{ kvm_task_sleep_node|| &lt;link&gt;link| token=[id=0, vcpu=1]| cpu=1| mm=mm_struct of task3| halted=false }&quot; ] sleep_node4 [ shape=&quot;record&quot; label=&quot;{ kvm_task_sleep_node|| &lt;link&gt;link| token=[id=1, vcpu=1]| cpu=1| mm=mm_struct of task4| halted=true }&quot; color=&quot;red&quot; ] label=&quot;cpu1 HALT&quot; } sleep_head:key0-&gt;sleep_node0:link [ color=&quot;blue&quot; ] sleep_head:key1-&gt;sleep_node1:link [ color=&quot;gold&quot; ] sleep_head:key2-&gt; sleep_node3:link-&gt; sleep_node4:link [ color=&quot;green&quot; ] sleep_node4-&gt;run_task_vcpu1 [ arrowhead=none style=dashed ] } </desc> <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 723)"><title>G</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-723 848.19,-723 848.19,4 -4,4" /> <g id="clust1" class="cluster"><title>cluster_cpu0</title><polygon fill="none" stroke="black" points="8,-279 8,-480 600,-480 600,-279 8,-279" /> <text text-anchor="middle" x="304" y="-464.8" font-family="Times,serif" font-size="14.00">cpu0 RUNNING</text> </g> <g id="clust2" class="cluster"><title>cluster_cpu1</title><polygon fill="none" stroke="black" points="608,-8 608,-480 818,-480 818,-8 608,-8" /> <text text-anchor="middle" x="713" y="-464.8" font-family="Times,serif" font-size="14.00">cpu1 HALT</text> </g> <g id="node1" class="node"><title>sleep_head</title><polygon fill="none" stroke="black" points="410.5,-488.5 410.5,-718.5 579.5,-718.5 579.5,-488.5 410.5,-488.5" /> <text text-anchor="middle" x="495" y="-703.3" font-family="Times,serif" font-size="14.00">kvm_task_sleep_head</text><polyline fill="none" stroke="black" points="410.5,-695.5 579.5,-695.5 " /> <text text-anchor="middle" x="495" y="-680.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="410.5,-672.5 579.5,-672.5 " /> <text text-anchor="middle" x="495" y="-657.3" font-family="Times,serif" font-size="14.00">[0]</text><polyline fill="none" stroke="black" points="410.5,-649.5 579.5,-649.5 " /> <text text-anchor="middle" x="495" y="-634.3" font-family="Times,serif" font-size="14.00">link(key0)</text><polyline fill="none" stroke="black" points="410.5,-626.5 579.5,-626.5 " /> <text text-anchor="middle" x="495" y="-611.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="410.5,-603.5 579.5,-603.5 " /> <text text-anchor="middle" x="495" y="-588.3" font-family="Times,serif" font-size="14.00">[1]</text><polyline fill="none" stroke="black" points="410.5,-580.5 579.5,-580.5 " /> <text text-anchor="middle" x="495" y="-565.3" font-family="Times,serif" font-size="14.00">link(key1)</text><polyline fill="none" stroke="black" points="410.5,-557.5 579.5,-557.5 " /> <text text-anchor="middle" x="495" y="-542.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="410.5,-534.5 579.5,-534.5 " /> <text text-anchor="middle" x="495" y="-519.3" font-family="Times,serif" font-size="14.00">[2]</text><polyline fill="none" stroke="black" points="410.5,-511.5 579.5,-511.5 " /> <text text-anchor="middle" x="495" y="-496.3" font-family="Times,serif" font-size="14.00">link(key2)</text> </g> <g id="node2" class="node"><title>sleep_node0</title><polygon fill="none" stroke="black" points="398,-287.5 398,-448.5 592,-448.5 592,-287.5 398,-287.5" /> <text text-anchor="middle" x="495" y="-433.3" font-family="Times,serif" font-size="14.00">kvm_task_sleep_node</text><polyline fill="none" stroke="black" points="398,-425.5 592,-425.5 " /> <text text-anchor="middle" x="495" y="-410.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="398,-402.5 592,-402.5 " /> <text text-anchor="middle" x="495" y="-387.3" font-family="Times,serif" font-size="14.00">link</text><polyline fill="none" stroke="black" points="398,-379.5 592,-379.5 " /> <text text-anchor="middle" x="495" y="-364.3" font-family="Times,serif" font-size="14.00">token=[id=0, vcpu=0]</text><polyline fill="none" stroke="black" points="398,-356.5 592,-356.5 " /> <text text-anchor="middle" x="495" y="-341.3" font-family="Times,serif" font-size="14.00">cpu=0</text><polyline fill="none" stroke="black" points="398,-333.5 592,-333.5 " /> <text text-anchor="middle" x="495" y="-318.3" font-family="Times,serif" font-size="14.00">mm=mm_struct of task0</text><polyline fill="none" stroke="black" points="398,-310.5 592,-310.5 " /> <text text-anchor="middle" x="495" y="-295.3" font-family="Times,serif" font-size="14.00">halted=false</text> </g> <g id="edge1" class="edge"><title>sleep_head:key0&#45;&gt;sleep_node0:link</title><path fill="none" stroke="blue" d="M581,-638.5C593.15,-638.5 603.93,-445.61 596.82,-400.4" /><polygon fill="blue" stroke="blue" points="600,-398.95 593,-391 593.52,-401.58 600,-398.95" /> </g> <g id="node3" class="node"><title>sleep_node1</title><polygon fill="none" stroke="black" points="186,-287.5 186,-448.5 380,-448.5 380,-287.5 186,-287.5" /> <text text-anchor="middle" x="283" y="-433.3" font-family="Times,serif" font-size="14.00">kvm_task_sleep_node</text><polyline fill="none" stroke="black" points="186,-425.5 380,-425.5 " /> <text text-anchor="middle" x="283" y="-410.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="186,-402.5 380,-402.5 " /> <text text-anchor="middle" x="283" y="-387.3" font-family="Times,serif" font-size="14.00">link</text><polyline fill="none" stroke="black" points="186,-379.5 380,-379.5 " /> <text text-anchor="middle" x="283" y="-364.3" font-family="Times,serif" font-size="14.00">token=[id=1, vcpu=0]</text><polyline fill="none" stroke="black" points="186,-356.5 380,-356.5 " /> <text text-anchor="middle" x="283" y="-341.3" font-family="Times,serif" font-size="14.00">cpu=0</text><polyline fill="none" stroke="black" points="186,-333.5 380,-333.5 " /> <text text-anchor="middle" x="283" y="-318.3" font-family="Times,serif" font-size="14.00">mm=mm_struct of task1</text><polyline fill="none" stroke="black" points="186,-310.5 380,-310.5 " /> <text text-anchor="middle" x="283" y="-295.3" font-family="Times,serif" font-size="14.00">halted=false</text> </g> <g id="edge2" class="edge"><title>sleep_head:key1&#45;&gt;sleep_node1:link</title><path fill="none" stroke="gold" d="M409,-568.5C368.67,-568.5 395.26,-519.84 389,-480 387.78,-472.26 389.69,-421.32 385.67,-400.18" /><polygon fill="gold" stroke="gold" points="388.65,-398.33 381,-391 382.41,-401.5 388.65,-398.33" /> </g> <g id="node6" class="node"><title>sleep_node3</title><polygon fill="none" stroke="black" points="616,-287.5 616,-448.5 810,-448.5 810,-287.5 616,-287.5" /> <text text-anchor="middle" x="713" y="-433.3" font-family="Times,serif" font-size="14.00">kvm_task_sleep_node</text><polyline fill="none" stroke="black" points="616,-425.5 810,-425.5 " /> <text text-anchor="middle" x="713" y="-410.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="black" points="616,-402.5 810,-402.5 " /> <text text-anchor="middle" x="713" y="-387.3" font-family="Times,serif" font-size="14.00">link</text><polyline fill="none" stroke="black" points="616,-379.5 810,-379.5 " /> <text text-anchor="middle" x="713" y="-364.3" font-family="Times,serif" font-size="14.00">token=[id=0, vcpu=1]</text><polyline fill="none" stroke="black" points="616,-356.5 810,-356.5 " /> <text text-anchor="middle" x="713" y="-341.3" font-family="Times,serif" font-size="14.00">cpu=1</text><polyline fill="none" stroke="black" points="616,-333.5 810,-333.5 " /> <text text-anchor="middle" x="713" y="-318.3" font-family="Times,serif" font-size="14.00">mm=mm_struct of task3</text><polyline fill="none" stroke="black" points="616,-310.5 810,-310.5 " /> <text text-anchor="middle" x="713" y="-295.3" font-family="Times,serif" font-size="14.00">halted=false</text> </g> <g id="edge3" class="edge"><title>sleep_head:key2&#45;&gt;sleep_node3:link</title><path fill="none" stroke="green" d="M581,-499.5C594.4,-499.5 597.63,-491.79 604,-480 611.7,-465.75 600.99,-415.9 607.4,-397.71" /><polygon fill="green" stroke="green" points="609.82,-400.24 615,-391 605.19,-394.99 609.82,-400.24" /> </g> <g id="node4" class="node"><title>run_task_vcpu0</title><polygon fill="none" stroke="red" points="16,-350 16,-386 168,-386 168,-350 16,-350" /> <text text-anchor="middle" x="92" y="-364.3" font-family="Times,serif" font-size="14.00">current task: task2</text> </g> <g id="node5" class="node"><title>run_task_vcpu1</title><polygon fill="none" stroke="red" points="637,-16.5 637,-52.5 789,-52.5 789,-16.5 637,-16.5" /> <text text-anchor="middle" x="713" y="-30.8" font-family="Times,serif" font-size="14.00">current task: task4</text> </g> <g id="node7" class="node"><title>sleep_node4</title><polygon fill="none" stroke="red" points="616,-89.5 616,-250.5 810,-250.5 810,-89.5 616,-89.5" /> <text text-anchor="middle" x="713" y="-235.3" font-family="Times,serif" font-size="14.00">kvm_task_sleep_node</text><polyline fill="none" stroke="red" points="616,-227.5 810,-227.5 " /> <text text-anchor="middle" x="713" y="-212.3" font-family="Times,serif" font-size="14.00"> </text><polyline fill="none" stroke="red" points="616,-204.5 810,-204.5 " /> <text text-anchor="middle" x="713" y="-189.3" font-family="Times,serif" font-size="14.00">link</text><polyline fill="none" stroke="red" points="616,-181.5 810,-181.5 " /> <text text-anchor="middle" x="713" y="-166.3" font-family="Times,serif" font-size="14.00">token=[id=1, vcpu=1]</text><polyline fill="none" stroke="red" points="616,-158.5 810,-158.5 " /> <text text-anchor="middle" x="713" y="-143.3" font-family="Times,serif" font-size="14.00">cpu=1</text><polyline fill="none" stroke="red" points="616,-135.5 810,-135.5 " /> <text text-anchor="middle" x="713" y="-120.3" font-family="Times,serif" font-size="14.00">mm=mm_struct of task4</text><polyline fill="none" stroke="red" points="616,-112.5 810,-112.5 " /> <text text-anchor="middle" x="713" y="-97.3" font-family="Times,serif" font-size="14.00">halted=true</text> </g> <g id="edge4" class="edge"><title>sleep_node3:link&#45;&gt;sleep_node4:link</title><path fill="none" stroke="green" d="M811,-391C851.56,-391 854.73,-222.73 820.51,-196.44" /><polygon fill="green" stroke="green" points="821.59,-193.11 811,-193 819.21,-199.69 821.59,-193.11" /> </g> <g id="edge5" class="edge"><title>sleep_node4&#45;&gt;run_task_vcpu1</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M713,-89.41C713,-75.57 713,-62.48 713,-52.68" /> </g> </g> </svg></div><ul><li>图中一共有4个涉及async PF的task, 同时每个task关联一个<code class="language-plaintext highlighter-rouge">kvm_task_sleep_node</code><li><code class="language-plaintext highlighter-rouge">kvm_task_sleep_head[]-&gt;link</code>负责将所有key相同的 <code class="language-plaintext highlighter-rouge">sleep_node</code>串联起来, 方便查找<li>每个<code class="language-plaintext highlighter-rouge">kvm_task_sleep_node</code>有一个唯一的 identify <code class="language-plaintext highlighter-rouge">kvm_task_sleep_node-&gt;token</code><li>cpu0 上之前触发过两次async PF, 并且涉及到的task调度走了,目前正在运行task2<li>cpu1 上触发过两次async PF, 当task3 触发时, 成功将task3 sched out, 当task4 触发时, 由于此时guest vcpu 不能调度, 所以将该cpu halt. 目前该cpu正在task4 的上下文中halt.</ul></details><h4 id="kvm_task_sleep_head"><span class="me-2">kvm_task_sleep_head</span><a href="#kvm_task_sleep_head" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_task_sleep_head</span> <span class="p">{</span>
        <span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">hlist_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span> <span class="n">async_pf_sleepers</span><span class="p">[</span><span class="n">KVM_TASK_SLEEP_HASHSIZE</span><span class="p">];</span>
</pre></table></code></div></div><p>该数据结构是一个hash map, 使用<code class="language-plaintext highlighter-rouge">token</code>作为hash key.</p><ul><li><strong>lock</strong>: 可以看到是每个hash key, 有一个lock. 减少race情况</ul><h4 id="kvm_task_sleep_node"><span class="me-2">kvm_task_sleep_node</span><a href="#kvm_task_sleep_node" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_task_sleep_node</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">hlist_node</span> <span class="n">link</span><span class="p">;</span>
        <span class="n">wait_queue_head_t</span> <span class="n">wq</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">token</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">halted</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p>该数据结构作为hash node, 描述每一个因为async pf 调度出去的task</p><blockquote class="prompt-info"><p>这里并不一定指被调度出去的task, 可能链接着即将发生调度的task信息, 我们下面会介绍到.</p></blockquote><ul><li><strong>wq</strong>: 等待队列<li><strong>token</strong>: 和上面描述一样, 唯一标识一次async PF<li><strong>halted</strong>: 有时候kvm注入async PF时, guest在这个时间点不能做schedule, 又 为了再次避免执行该代码流, 只能halt 该cpu. 这里用于标识是否该task halt了cpu</ul><h3 id="initiate-async-pf-inject-async-pf"><span class="me-2">initiate async pf-&gt;inject async pf</span><a href="#initiate-async-pf-inject-async-pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>上面提到了为了使用<code class="language-plaintext highlighter-rouge">GUP noio</code>接口, 将<code class="language-plaintext highlighter-rouge">tdp_page_fault</code>中的<code class="language-plaintext highlighter-rouge">gfn_to_pfn</code>改动为 <code class="language-plaintext highlighter-rouge">try_async_pf</code>. 我们来看下该接口</p><h4 id="try_async_pf"><span class="me-2">try_async_pf</span><a href="#try_async_pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">bool</span> <span class="nf">try_async_pf</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">gva</span><span class="p">,</span>
            <span class="n">pfn_t</span> <span class="o">*</span><span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">bool</span> <span class="n">async</span><span class="p">;</span>
   <span class="c1">//==(1)==</span>
   <span class="o">*</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">gfn_to_pfn_async</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">async</span><span class="p">);</span>

   <span class="c1">//==(2)==</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async</span><span class="p">)</span>
       <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* *pfn has correct page already */</span>

   <span class="c1">//==(3)==</span>
   <span class="n">put_page</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="o">*</span><span class="n">pfn</span><span class="p">));</span>

   <span class="c1">//==(4)==</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">can_do_async_pf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">trace_kvm_try_async_get_page</span><span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="o">*</span><span class="n">pfn</span><span class="p">);</span>
       <span class="c1">//==(5)==</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">kvm_find_async_pf_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">trace_kvm_async_pf_doublefault</span><span class="p">(</span><span class="n">gva</span><span class="p">,</span> <span class="n">gfn</span><span class="p">);</span>
           <span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_APF_HALT</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
           <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
       <span class="c1">//==(6)==</span>
       <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvm_arch_setup_async_pf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva</span><span class="p">,</span> <span class="n">gfn</span><span class="p">))</span>
           <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">//==(7)==</span>
   <span class="o">*</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">gfn_to_pfn</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">);</span>

   <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>前面提到过, 在<code class="language-plaintext highlighter-rouge">try_async_pf</code> 中会执行到<code class="language-plaintext highlighter-rouge">gfn_to_pfn_async()</code>, <code class="language-plaintext highlighter-rouge">async</code> 作为oparam 表示是否需要做async pf, 另外还有一个返回值, 该返回值 表示在该过程中得到的 <strong>pfn</strong> of <code class="language-plaintext highlighter-rouge">gfn</code><li>当然, 如果得到的async为false, 说明不需要async pf, 那肯定得到了pfn 所以直接返回 false<li>put_page<li>这里会判断当前vcpu的状态是否可以做async pf <details open=""> <summary><code>can_do_async_pf</code>细节</summary><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gi">+static bool can_do_async_pf(struct kvm_vcpu *vcpu)
+{
+	if (unlikely(!irqchip_in_kernel(vcpu-&gt;kvm) ||
+		     kvm_event_needs_reinjection(vcpu)))
+		return false;
+
+	return kvm_x86_ops-&gt;interrupt_allowed(vcpu);
+}
</span></pre></table></code></div></div><p>我们这里详细讲解下, 这三个判断条件,</p><ul><li><strong>irqchip_in_kernel()</strong><li><strong>kvm_event_need_reinjection()</strong>:<div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">kvm_event_needs_reinjection</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exception</span><span class="p">.</span><span class="n">pending</span> <span class="o">||</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">pending</span> <span class="o">||</span>
                <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">nmi_injected</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>可以看到这里, 在检测到有其他pending 事件的情况下, 不允许做async pf.</p><details open=""> <summary>自己的理解</summary><blockquote class="prompt-tip"><p>关于pending的event, 我们需要参考<code class="language-plaintext highlighter-rouge">__vmx_complete_interrupts</code>, 但是这里我们 不过度展开, 大概就是在 VM entry inject event 期间, 由于某些原因, 触发了 VM exit, 此时, VM entry, 还没有完成, 所以这些事件并没有被inject, 需要再次 VM entry时注入. 再这种情况下, 就会有这样的顺序</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>inject_event1-&gt;
  VM entry-&gt;
  VM exit(get uncomplete event)-&gt;
  get vm exit reason: EPT violation PAGE not present-&gt;
  (do some handler)-&gt;
  VM entry
</pre></table></code></div></div><p>那现在问题来了, 本次是该注入async PF, 还是注入 uncomplete event呢?</p><p>我个人认为是注入uncomplete event. 首先按照顺序 uncomplete event先发生. 如果不注入 uncomplete event的情况下, 直接注入async pf, 给guest感觉是某些 event延后了.</p><p>另外, uncomplete event是由于 EPT violation 而触发的. 所以在本次处理完EPT violation 之后,正好可以注入 uncomplete event, 并且大概率不会再次触发VM exit during EVENT inject.</p><blockquote class="prompt-warning"><p>以上是自己的理解, 而且不确定处理 <code class="language-plaintext highlighter-rouge">tdp_page_fault()</code>时, 所有的event是否都来自于 上一次注入失败的uncomplete event.</p><p>遗留问题</p></blockquote></blockquote></details><ul><li><strong>interrupt_allowed</strong>: 我们来看下intel vmx 代码<div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">vmx_interrupt_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">vmcs_readl</span><span class="p">(</span><span class="n">GUEST_RFLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_IF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="p">(</span><span class="n">vmcs_read32</span><span class="p">(</span><span class="n">GUEST_INTERRUPTIBILITY_INFO</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">GUEST_INTR_STATE_STI</span> <span class="o">|</span> <span class="n">GUEST_INTR_STATE_MOV_SS</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><p>该部分代码, 主要是检测当前interrupt windows 是否open, 这里对 这些判断条件不做过多 解释, 详细见<a href="">virtual interrupt</a> 文章</p><blockquote class="prompt-danger"><p>还未写该文章</p><p>遗留部分</p></blockquote><p>但是我们需要理解下, 为什么要关注guest 是否能接收中断呢? 毕竟async pf 注入的是<code class="language-plaintext highlighter-rouge">#PF</code> 首先我们需要明确的是:</p><details open=""> <summary>自己的理解</summary><blockquote class="prompt-tip"><ul><li>Q: async pf的目的是什么?<ul><li>A: 调度</ul><li>Q: 该调度能发生在guest 运行的任何时机么<ul><li>A: 需要满足guest意愿</ul></ul><p>所以, 综上所述, 得需要在guest认为自己可以调度的情况下, 才能做async pf这个事情. 否则, 即使去启动了一个<code class="language-plaintext highlighter-rouge">dedicated thread</code>, 让guest调度, guest也不会去调度, 这样就没有意义了.</p><p>那好在这样的背景下, 我们分情况考虑:</p><ul><li><p>non-para virt: halt</p><p>在halt vcpu之后, 能够wakeup vcpu的方式有两种event</p><ul><li>interrupt<li>async pf work complete</ul><p>那在guest 不能注入中断的情况下, 只能由第二种event wakeup, 那就变成了sync的方式. 没有意义.</p><li><p>para virt, 因为是半虚拟化方式, 相当于通知guest去主动做一次调度, 但是也得满足guest意愿. 这实际上就像是和guest 协商的过程, 需要去关心guest这一刻是否能做调度. 作者在介绍 <code class="language-plaintext highlighter-rouge">MSR_KVM_ASYNC_PF_EN</code>明确了, guest在关中断时, 不能去再次注入async PF, guest可能还处在 APF handler中. 如果在此期间再次注入APF, 可能会导致 APF information 被覆盖, 例如:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>host                       guest             cr2
write token(a) to cr2
                                             value: a
inject APF1
                           trigger #PF
                             (disable 
                             interrupt
                             in VM-entry)
                           do some thing...

write token(b) to cr2
                                             value: b
inject APF2
                           intend to read
                            cr2 to get 
                            APF1 token, 
                            loss it !!!
</pre></table></code></div></div><p>在<a href="https://lore.kernel.org/all/4B0D2B22.4030403@redhat.com/">avi 的自问自答</a> 中, 我们也能看到关于 interrupt allow的解释.</p></ul></blockquote></details></ul></ul></details><li>这里说明之前, 该vcpu触发过该地址的 EPT violation , 并且已经做了async pf, 相当于再次遇到了. 说明频率比较高, 那么直接halt该vcpu<blockquote class="prompt-warning"><p>??? ??? ???</p></blockquote><li><strong>下个小节中介绍</strong><li>如果上述条件不满足, 则直接同步去做.</ol><h4 id="kvm_setup_async_pf"><span class="me-2">kvm_setup_async_pf</span><a href="#kvm_setup_async_pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">kvm_setup_async_pf</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">gva</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span>
                       <span class="k">struct</span> <span class="nc">kvm_arch_async_pf</span> <span class="o">*</span><span class="n">arch</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">kvm_async_pf</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
        <span class="c1">//==(1)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">queued</span> <span class="o">&gt;=</span> <span class="n">ASYNC_PF_PER_VCPU</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* setup delayed work */</span>

        <span class="cm">/*
         * do alloc nowait since if we are going to sleep anyway we
         * may as well sleep faulting in page
         */</span>
        <span class="c1">//==(2)==</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">async_pf_cache</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">work</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">work</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">work</span><span class="o">-&gt;</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">vcpu</span><span class="p">;</span>
        <span class="n">work</span><span class="o">-&gt;</span><span class="n">gva</span> <span class="o">=</span> <span class="n">gva</span><span class="p">;</span>
        <span class="n">work</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">gfn_to_hva</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">);</span>
        <span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span> <span class="o">=</span> <span class="o">*</span><span class="n">arch</span><span class="p">;</span>
        <span class="n">work</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
        <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mm_count</span><span class="p">);</span>
        <span class="n">kvm_get_kvm</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">);</span>

        <span class="cm">/* this can't really happen otherwise gfn_to_pfn_async
           would succeed */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">kvm_is_error_hva</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)))</span>
                <span class="k">goto</span> <span class="n">retry_sync</span><span class="p">;</span>

        <span class="c1">//==(2.1)==</span>
        <span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">async_pf_execute</span><span class="p">);</span>
        <span class="c1">//==(3)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">))</span>
                <span class="k">goto</span> <span class="n">retry_sync</span><span class="p">;</span>

        <span class="c1">//==(4)==</span>
        <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
        <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">queued</span><span class="o">++</span><span class="p">;</span>
        <span class="c1">//==(5)==</span>
        <span class="n">kvm_arch_async_page_not_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">retry_sync:</span>
        <span class="n">kvm_put_kvm</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">);</span>
        <span class="n">mmdrop</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">);</span>
        <span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">async_pf_cache</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>说明per cpu async_pf(work)超过了最大限制 – <code class="language-plaintext highlighter-rouge">ASYNC_PF_PER_VCPU</code><li>申请,work并做相关初始化, 在(2.1)中将work hook设置为<code class="language-plaintext highlighter-rouge">async_pf_execute</code><li>schedule work<li>将work加到 <code class="language-plaintext highlighter-rouge">vcpu-&gt;async_pf.queue</code>队列中<li>代码如下:<div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">kvm_arch_async_page_not_present</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                     <span class="k">struct</span> <span class="nc">kvm_async_pf</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">trace_kvm_async_pf_not_present</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">token</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">gva</span><span class="p">);</span>
        <span class="n">kvm_add_async_pf_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gfn</span><span class="p">);</span>
        <span class="c1">//==(1)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apf</span><span class="p">.</span><span class="n">msr_val</span> <span class="o">&amp;</span> <span class="n">KVM_ASYNC_PF_ENABLED</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apf</span><span class="p">.</span><span class="n">send_user_only</span> <span class="o">&amp;&amp;</span>
             <span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">get_cpl</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_APF_HALT</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
        <span class="c1">//==(2)==</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apf_put_user</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">KVM_PV_REASON_PAGE_NOT_PRESENT</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">token</span><span class="p">;</span>
                <span class="n">kvm_inject_page_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>和<code class="language-plaintext highlighter-rouge">can_do_async_pf</code>, 这里也有一些判断当前状态是否合适向guest注入async pf 的条件, 我们放到下面介绍<li>如果可以注入, 则将<code class="language-plaintext highlighter-rouge">KVM_PV_REASON_PAGE_NOT_PRESENT</code>其写入 guest host 共享的 内存中, 表示本次注入的是<code class="language-plaintext highlighter-rouge">page not present</code>类型的 async pf. 另外, 设置好 本次注入异常的 address和 error code</ol></ol><h3 id="async-pf-work"><span class="me-2">async pf work</span><a href="#async-pf-work" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">async_pf_execute</span><span class="p">(</span><span class="k">struct</span> <span class="nc">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_async_pf</span> <span class="o">*</span><span class="n">apf</span> <span class="o">=</span>
                <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_async_pf</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">apf</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">apf</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">apf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
        <span class="n">gva_t</span> <span class="n">gva</span> <span class="o">=</span> <span class="n">apf</span><span class="o">-&gt;</span><span class="n">gva</span><span class="p">;</span>

        <span class="n">might_sleep</span><span class="p">();</span>

        <span class="n">use_mm</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
        <span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
        <span class="c1">//==(1)==</span>
        <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
        <span class="n">unuse_mm</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>

        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
        <span class="c1">//==(2)==</span>
        <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apf</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
        <span class="n">apf</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
        <span class="n">apf</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

        <span class="cm">/*
         * apf may be freed by kvm_check_async_pf_completion() after
         * this point
         */</span>

        <span class="n">trace_kvm_async_pf_completed</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">gva</span><span class="p">);</span>

        <span class="c1">//==(3)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span>
                <span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

        <span class="n">mmdrop</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
        <span class="n">kvm_put_kvm</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>调用<code class="language-plaintext highlighter-rouge">get_user_pages</code>, 该接口可以处理MAJOR fault<blockquote class="prompt-tip"><p>get_user_pages() 第四个参数, 如果不为空,则会设置<code class="language-plaintext highlighter-rouge">FOLL_GET</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>int get_user_pages(struct task_struct *tsk, struct mm_struct *mm,
           unsigned long start, int nr_pages, int write, int force,
           struct page **pages, struct vm_area_struct **vmas)
{
        int flags = FOLL_TOUCH;

        if (pages)
                flags |= FOLL_GET;
        ...
}
</pre></table></code></div></div><p>如果设置了<code class="language-plaintext highlighter-rouge">FOLL_GET</code>, 则会在<code class="language-plaintext highlighter-rouge">get_user_pages()</code>的过程中, pin this page. 也就是<code class="language-plaintext highlighter-rouge">get_page()</code>, 但是需要注意的是, 该接口可能会返回错误, 但是看起来此流程 并没有判断该接口是否执行成功. IOW, 无论该接口是否执行成功, 都认为该work已经 complete, 都需要再次wakeup GUEST blocking thread.</p></blockquote><li>将该work, 链接到<code class="language-plaintext highlighter-rouge">vcpu-&gt;async_pf.done</code>链表中<li>如果vcpu在等待队列中(halt), 唤醒该vcpu</ol><p>接下来, 我们来看下, host是如何检测 <code class="language-plaintext highlighter-rouge">page present</code>事件, 并注入<code class="language-plaintext highlighter-rouge">page present async pf</code> 的</p><h3 id="host-inject-page-present-aync-pf"><span class="me-2">host inject PAGE PRESENT aync pf</span><a href="#host-inject-page-present-aync-pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="p">@@ -5272,6 +5288,9 @@</span> static int __vcpu_run(struct kvm_vcpu *vcpu)
 			vcpu-&gt;run-&gt;exit_reason = KVM_EXIT_INTR;
 			++vcpu-&gt;stat.request_irq_exits;
 		}
<span class="gi">+		
+		kvm_check_async_pf_completion(vcpu);
+
</span> 		if (signal_pending(current)) {
 			r = -EINTR;
</pre></table></code></div></div><p>在vm exit后, 检测是否有需要 async pf complete</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">kvm_check_async_pf_completion</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">kvm_async_pf</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
        <span class="c1">//==(1)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">list_empty_careful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">done</span><span class="p">)</span> <span class="o">||</span>
            <span class="o">!</span><span class="n">kvm_arch_can_inject_async_page_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
                <span class="k">return</span><span class="p">;</span>

        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">work</span><span class="p">),</span> <span class="n">link</span><span class="p">);</span>
        <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
        <span class="c1">//==(2)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
                <span class="n">kvm_arch_async_page_ready</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
        <span class="c1">//==(3)==</span>
        <span class="n">kvm_arch_async_page_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

        <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
        <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">async_pf</span><span class="p">.</span><span class="n">queued</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
                <span class="n">put_page</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
        <span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">async_pf_cache</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>有两个判断条件:<ul><li>判断是否有完成的work<li>guest此时是否适合注入 page present async PF (下面章节介绍)</ul><li><p>如果<code class="language-plaintext highlighter-rouge">work-&gt;page</code>为 NULL, 说明async work中, 执行<code class="language-plaintext highlighter-rouge">get_user_pages()</code>失败了, 那么本次就不需要在执行<code class="language-plaintext highlighter-rouge">kvm_arch_async_page_ready()</code>, 该函数作用是, 再 次执行<code class="language-plaintext highlighter-rouge">tdp_page_fault</code>, 如果page is ready, 那只需要执行<code class="language-plaintext highlighter-rouge">get_user_page</code> fast path和<code class="language-plaintext highlighter-rouge">__direct_map</code>建立<code class="language-plaintext highlighter-rouge">GPA-&gt;HPA</code>的映射.</p><p>但是如果page is not ready(work-&gt;page)为NULL, 作者的想法是, 让其在次vm entry, wakeup guest blocking thread, 让其再次触发EPT violation, 然后再发起async pf. 所以在这里没有必要在做一次<code class="language-plaintext highlighter-rouge">kvm_arch_async_page_ready-&gt;tdp_page_fault</code>, 那可能 有同学会说, 那为什么不在HOST中, 等待<code class="language-plaintext highlighter-rouge">get_user_pages()</code>一定返回成功之后, 再 注入 <code class="language-plaintext highlighter-rouge">page present #PF</code>,</p><blockquote class="prompt-warning"><p>实话说,我也不知道, 但这里总感觉作者不想增加复杂的代码逻辑, 需要关注下后续的patch, 看看是否对这部分有优化</p><blockquote class="prompt-danger"><p>遗留问题</p></blockquote></blockquote><li>kvm_arch_async_page_present<div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">kvm_arch_async_page_present</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                 <span class="k">struct</span> <span class="nc">kvm_async_pf</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">trace_kvm_async_pf_ready</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">token</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">gva</span><span class="p">);</span>
        <span class="c1">//==(1)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_error_page</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">))</span>
                <span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span> <span class="cm">/* broadcast wakeup */</span>
        <span class="k">else</span>
                <span class="n">kvm_del_async_pf_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gfn</span><span class="p">);</span>
   
        <span class="c1">//==(2)==</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apf</span><span class="p">.</span><span class="n">msr_val</span> <span class="o">&amp;</span> <span class="n">KVM_ASYNC_PF_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">apf_put_user</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">KVM_PV_REASON_PAGE_READY</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">token</span><span class="p">;</span>
                <span class="n">kvm_inject_page_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li><p>关于<code class="language-plaintext highlighter-rouge">error page</code>, 我们放在另一篇文章中讲述.</p><blockquote class="prompt-warning"><p>遗留问题</p></blockquote><li><p>置入<code class="language-plaintext highlighter-rouge">KVM_ASYNC_PF_PF_ENABLED</code>, 准备注入 page present async #PF</p></ol></ol><h3 id="guest-handle-async-pf"><span class="me-2">guest handle async PF</span><a href="#guest-handle-async-pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">dotraplinkage</span> <span class="kt">void</span> <span class="n">__kprobes</span>
<span class="nf">do_async_page_fault</span><span class="p">(</span><span class="k">struct</span> <span class="nc">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">//==(1)==</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">kvm_read_and_reset_pf_reason</span><span class="p">())</span> <span class="p">{</span>
        <span class="nl">default:</span>
        <span class="c1">//==(2)==</span>
                <span class="n">do_page_fault</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">error_code</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">KVM_PV_REASON_PAGE_NOT_PRESENT</span><span class="p">:</span>
        <span class="c1">//==(3)==</span>
                <span class="cm">/* page is swapped out by the host. */</span>
                <span class="n">kvm_async_pf_task_wait</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">read_cr2</span><span class="p">());</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="c1">//==(4)==</span>
        <span class="k">case</span> <span class="n">KVM_PV_REASON_PAGE_READY</span><span class="p">:</span>
                <span class="n">kvm_async_pf_task_wake</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">read_cr2</span><span class="p">());</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>该部分代码逻辑很清晰, async PF event 是使用了原有的#PF exception vector, guest 需要在exception handler 中判断这个#PF的类型, 然后执行相应的handler</p><ol><li>从share memory 中获取 async pf reason<li>indicate NORMAL #PF<li>indicate PAGE NOT PRESENT async pf<li>indicate PAGE PRESENT async pf</ol><h4 id="page-not-present-async-pf"><span class="me-2">page not present async pf</span><a href="#page-not-present-async-pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">kvm_async_pf_task_wait</span><span class="p">(</span><span class="n">u32</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">u32</span> <span class="n">key</span> <span class="o">=</span> <span class="n">hash_32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">KVM_TASK_SLEEP_HASHBITS</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">kvm_task_sleep_head</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async_pf_sleepers</span><span class="p">[</span><span class="n">key</span><span class="p">];</span>
        <span class="k">struct</span> <span class="nc">kvm_task_sleep_node</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
        <span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">idle</span><span class="p">;</span>

        <span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>
        <span class="n">idle</span> <span class="o">=</span> <span class="n">idle_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
        <span class="n">put_cpu</span><span class="p">();</span>

        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="c1">//===(1)==</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">_find_apf_task</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* dummy entry exist -&gt; wake up was delivered ahead of PF */</span>
                <span class="n">hlist_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
                <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//===(2)==</span>
        <span class="n">n</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
        <span class="n">n</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
        <span class="n">n</span><span class="p">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">active_mm</span><span class="p">;</span>
        <span class="c1">//===(2.1)==</span>
        <span class="n">n</span><span class="p">.</span><span class="n">halted</span> <span class="o">=</span> <span class="n">idle</span> <span class="o">||</span> <span class="n">preempt_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">.</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mm_count</span><span class="p">);</span>
        <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">.</span><span class="n">wq</span><span class="p">);</span>
        <span class="c1">//===(3)==</span>
        <span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
                <span class="c1">//===(4)==</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="n">halted</span><span class="p">)</span>
                        <span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">.</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">.</span><span class="n">link</span><span class="p">))</span>
                        <span class="k">break</span><span class="p">;</span>

                <span class="c1">//===(4)==</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="n">halted</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">local_irq_enable</span><span class="p">();</span>
                        <span class="n">schedule</span><span class="p">();</span>
                        <span class="n">local_irq_disable</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="cm">/*
                         * We cannot reschedule. So halt.
                         */</span>
                        <span class="n">native_safe_halt</span><span class="p">();</span>
                        <span class="n">local_irq_disable</span><span class="p">();</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="n">halted</span><span class="p">)</span>
                <span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">.</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>在kernel doc介绍<code class="language-plaintext highlighter-rouge">MSR_KVM_ASYNC_PF_EN</code>, 作者有提到过. 一对[type2 APF, type1 APF] 不一定 会在同一个vcpu上触发, 那也就意味着两者可能并行执行(虽然现在的host kvm 没有这样做,但是guest 不能依赖它), 如下:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>kvm                vcpu1      vcpu2
1.inject type1 
  APF to VCPU1
                                      
2. inject type2 
  APF to VCPU2
                               3. handle type2 APF
                   4. handle
                    type1 APF
</pre></table></code></div></div><p>可以看到kvm虽然是按照顺序注入的type1 APF, 和type2 APF, 但是注入到了不同的vcpu. vcpu在处理时, <code class="language-plaintext highlighter-rouge">handle type2 APF</code>先执行, 此时page 已经present了, 不需要再sched out, 这里会在<code class="language-plaintext highlighter-rouge">type2 APF</code>handler 中预先将带有该token的<code class="language-plaintext highlighter-rouge">sleep_node</code>放到head中, 以便<code class="language-plaintext highlighter-rouge">type 1 APF</code> handler 可以跳过这次的sched out (需要结合<code class="language-plaintext highlighter-rouge">type2 APF</code> handle – <code class="language-plaintext highlighter-rouge">kvm_async_pf_task_wake()</code>.)</p><li>将task(current-&gt;active_mm)和token绑定, 这样当<code class="language-plaintext highlighter-rouge">type2 APF</code>触发时, 可以根据token找到当前block的 task<ul class="prompt-info"><li>需要注意的时, guest在某些情况下不能sched out, 这时, 只能halt当前cpu<blockquote><p>我们放到另一篇文章中去介绍</p><blockquote class="prompt-warning"><p>遗留问题</p></blockquote></blockquote></ul><li>将<code class="language-plaintext highlighter-rouge">sleep_node</code>链到<code class="language-plaintext highlighter-rouge">sleep_head</code>上<li>如果guest此时可以调度, 则将进程D住, sched out</ol><h4 id="page-present-async-pf"><span class="me-2">page present async pf</span><a href="#page-present-async-pf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">kvm_async_pf_task_wake</span><span class="p">(</span><span class="n">u32</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">u32</span> <span class="n">key</span> <span class="o">=</span> <span class="n">hash_32</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">KVM_TASK_SLEEP_HASHBITS</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">kvm_task_sleep_head</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">async_pf_sleepers</span><span class="p">[</span><span class="n">key</span><span class="p">];</span>
        <span class="k">struct</span> <span class="nc">kvm_task_sleep_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">apf_task_wake_all</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

<span class="n">again</span><span class="o">:</span>
        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="c1">//===(1)==</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_find_apf_task</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
        <span class="c1">//===(2)==</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/*
                 * async PF was not yet handled.
                 * Add dummy entry for the token.
                 */</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/*
                         * Allocation failed! Busy wait while other cpu
                         * handles async PF.
                         */</span>
                        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                        <span class="n">cpu_relax</span><span class="p">();</span>
                        <span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">n</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
                <span class="n">n</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
                <span class="n">n</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
                <span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span>
        <span class="c1">//===(3)==</span>
                <span class="n">apf_task_wake_one</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>根据token, 在<code class="language-plaintext highlighter-rouge">sleep_head</code>中查找<code class="language-plaintext highlighter-rouge">sleep_node</code><li>同<code class="language-plaintext highlighter-rouge">type1 APF handler</code>, <code class="language-plaintext highlighter-rouge">type2 APF</code>可能在于<code class="language-plaintext highlighter-rouge">type1 APF</code>不同的cpu上先执行, 此时 在<code class="language-plaintext highlighter-rouge">sleep_head</code>中找不到和该token相关的<code class="language-plaintext highlighter-rouge">sleep_node</code>, 这时, 需要新创建一个 <code class="language-plaintext highlighter-rouge">sleep_node</code>将其添加到<code class="language-plaintext highlighter-rouge">sleep_head</code>中, 以便<code class="language-plaintext highlighter-rouge">type1 APF handler</code>可以查找到, 避免block该task<li>如果查找到了, 说明<code class="language-plaintext highlighter-rouge">type1 APF handler</code>已经触发, task已经block, 需要wakeup 该task</ol><h2 id="参考链接"><span class="me-2">参考链接</span><a href="#参考链接" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li><p>MAIL list:<br /> <a href="https://lore.kernel.org/all/1257076590-29559-1-git-send-email-gleb@redhat.com/">v1</a></p><p><a href="https://lore.kernel.org/all/1258985167-29178-1-git-send-email-gleb@redhat.com/">v2</a></p><p><a href="https://lore.kernel.org/all/1262700774-1808-1-git-send-email-gleb@redhat.com/">v3</a></p><p><a href="https://lore.kernel.org/all/1278433500-29884-1-git-send-email-gleb@redhat.com/">v4</a></p><p><a href="https://lore.kernel.org/all/1279553462-7036-1-git-send-email-gleb@redhat.com/">v5</a></p><p><a href="https://lore.kernel.org/all/1286207794-16120-1-git-send-email-gleb@redhat.com/">v6</a></p><p><a href="https://lore.kernel.org/all/1287048176-2563-1-git-send-email-gleb@redhat.com/">v7</a></p></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/kvm/">kvm</a>, <a href="/categories/async-pf/">async_pf</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/para-virt/" class="post-tag no-text-decoration" >para_virt</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=async%20pf%20-%20one%20step%20at%20a%20time&url=%2Fposts%2Fasync-pf%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=async%20pf%20-%20one%20step%20at%20a%20time&u=%2Fposts%2Fasync-pf%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fasync-pf%2F&text=async%20pf%20-%20one%20step%20at%20a%20time" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/coroutine/">qemu coroutine</a><li class="text-truncate lh-lg"> <a href="/posts/pqos/">qpos -- amd spec</a><li class="text-truncate lh-lg"> <a href="/posts/rdt/">rdt -- intel spec</a><li class="text-truncate lh-lg"> <a href="/posts/dirty-tracking/">dirty tracking</a><li class="text-truncate lh-lg"> <a href="/posts/vfio/">vfio</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/amd-sdm/">amd_sdm</a> <a class="post-tag btn btn-outline-primary" href="/tags/apic-timer/">apic-timer</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/async-pf-gfn2hva-cache/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713250800" data-df="ll" > Apr 16, 2024 </time><h4 class="pt-0 my-2">async pf -- gfn2hva cache</h4><div class="text-muted"><p>introduce 该功能仅通过name就可以得知, 是为了缓存gfn(gpa)到hva的映射. 但是这个映射关系 不是一直存在么, 为什么设计看似比较复杂的机制, 我们一步步来看 user memory region support 我们知道,在比较早期的版本, kvm 创建memslot API 1 2 kvm_vm_ioctl KVM_SET_USER_MEMORY_REGI...</p></div></div></a></article><article class="col"> <a href="/posts/async-pf-gup-change/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1713250800" data-df="ll" > Apr 16, 2024 </time><h4 class="pt-0 my-2">async pf -- GUP change</h4><div class="text-muted"><p>参考代码 该部分代码, mail list中和commit中内容不同, 而且mail list中也没有提到为什么当时没有全部 合入, 我们先以mail list 为准: [KVM: Add host swap event notifications for PV guest][v7] 后续, 我们在另一篇文章中详细介绍: [link][2] 遗留问题 ...</p></div></div></a></article><article class="col"> <a href="/posts/wbinvd-emulate/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1737522300" data-df="ll" > Jan 22, 2025 </time><h4 class="pt-0 my-2">emulate wbinvd</h4><div class="text-muted"><p>related patch KVM: VMX: wbinvd exiting commit e5edaa01c4cea5f60c617fac989c6458df0ecc4e Eddie Dong Sun Nov 11 12:28:35 2007 +0200 ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"><div class="btn btn-outline-primary disabled" aria-label="Older"><p>-</p></div><a href="/posts/embedding_markdown_in_html_tag/" class="btn btn-outline-primary" aria-label="Newer" ><p>embedding markdown in HTML tag</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/fuqiang_cai">fuqiang wang</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v6.5.5" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/amd-sdm/">amd_sdm</a> <a class="post-tag btn btn-outline-primary" href="/tags/apic-timer/">apic-timer</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
