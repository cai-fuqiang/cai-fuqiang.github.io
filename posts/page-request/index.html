<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="page request" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><meta property="og:description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><link rel="canonical" href="/posts/page-request/" /><meta property="og:url" content="/posts/page-request/" /><meta property="og:site_name" content="one step at a time" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-05-06T11:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="page request" /><meta name="twitter:site" content="@fuqiang_cai" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2025-05-06T11:00:00+08:00","datePublished":"2025-05-06T11:00:00+08:00","description":"A minimal, responsive and feature-rich Jekyll theme for technical writing.","headline":"page request","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/page-request/"},"url":"/posts/page-request/"}</script><title>page request | one step at a time</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="one step at a time"><meta name="application-name" content="one step at a time"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"></a><h1 class="site-title"> <a href="/">one step at a time</a></h1><p class="site-subtitle fst-italic mb-0">a noob's growing diary</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cai-fuqiang" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fuqiang_cai" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['iwng86','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>page request</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>page request</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1746500400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 6, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5203 words" > <em>28 min</em> read</span></div></div></div></header><div class="content"><style> blockquote { font-family: Arial, sans-serif; /* 修改字体 */ color: gray; /* 修改颜色 */ font-size: 13px; border-left: 5px solid orange; /* 修改左边框颜色 */ padding-left: 10px; /* 左侧内边距 */ margin: 10px 0; /* 上下外边距 */ } blockquote blockquote { font-weight: bold; }</style><h2 id="104-page-request-services"><span class="me-2">10.4 Page Request Services</span><a href="#104-page-request-services" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The general model for a page request is as follows:</p><ol><li><p>A Function determines that it requires access to a page for which an ATS translation is not available.</p><li><p>The Function causes the associated Page Request Interface to send a Page Request Message to its RC. A Page Request Message contains a page address and a Page Request Group (PRG) index. The PRG index is used to identify the transaction and is used to match requests with responses.</p><li><p>When the RC determines its response to the request (which will typically be to make the requested page resident), it sends a PRG Response Message back to the requesting Function.</p><li><p>The Function can then employ ATS to request a translation for the requested page(s).</p></ol><blockquote><ol><li>Function 判断其需要访问某个尚未有 ATS 转换的页面。<li>Function 促使其关联的页面请求接口（Page Request Interface）向其 RC 发送一个 页面请求消息（Page Request Message）。页面请求消息包含一个页面地址和一个页 面请求组（PRG）索引。PRG 索引用于标识该事务，并用于将请求与响应进行匹配。<li>当 RC 确定对该请求的响应（通常是使所请求的页面变为常驻内存）后，它会向发起 请求的 Function 发送一个 PRG 响应消息（PRG Response Message）。<li>随后，Function 可以使用 ATS 请求所需页面的转换</ol></blockquote><p>A Page Request Message is a PCIe Message Request that is Routed to the Root Complex with a Message Code of 4 (0000 0100b). The mechanism employed at the RC to buffer requests is implementation specific. The only requirement is that an RC not silently discard requests.</p><blockquote><p>Page Request Message 是一种 PCIe Message Request，其会以 Message Code 4（0000 0100b）路由到 Root Complex。RC 端用于缓存请求的机制由具体实现决定。唯一的要求 是，RC 不能悄无声息地丢弃请求。</p></blockquote><p>All Page Request Messages and PRG Response Messages travel in PCIe Traffic Class</p><ol><li>A Page Request Message or PRG Response Message with a Traffic Class other than 0 shall be treated as Malformed TLPs by the RC or endpoint that receives the same. Intermediate routing elements (e.g., Switches) shall not detect this error.</ol><blockquote><blockquote><p>Malformed TLPs（Malformed Transaction Layer Packets）是指格式错误的 PCIe 事务 层数据包。</p></blockquote><p>所有 Page Request Message 和 PRG Response Message 都在 PCIe Traffic Class 0 中 传输。带有非 0 Traffic Class 的 Page Request Message 或 PRG Response Message， 应当被接收该消息的 RC 或 endpoint 视为 Malformed TLPs。中间的路由元件（例如 Switches）不应检测此类错误</p></blockquote><p>The Relaxed Ordering and ID-Based Ordering bits in the Attr field of Page Request Messages and PRG Response messages may be used. The No Snoop bit in the Attr field is reserved.</p><blockquote><p>Page Request Message 和 PRG Response message 的 Attr 字段中的 Relaxed Ordering 和 ID-Based Ordering 位可以使用。Attr 字段中的 No Snoop 位为保留位。</p></blockquote><p>The page request service allows grouping of page requests into Page Request Groups (PRGs). A PRG can contain one or more page requests. All pages in a PRG are responded to en mass by the host. Individual pages within a PRG are requested with independent Page Request Messages and are recognized as belonging to a common PRG by sharing the same PRG index. The last request of a PRG is marked as such within its Page Request Message. One request credit is consumed per page request (not per PRG).</p><blockquote><p>page request service 允许将多个页面请求分组为 Page Request Groups（PRGs）。一 个 PRG 可以包含一个或多个页面请求。host会对 PRG 中的所有页面统一响应。PRG 内的 每个页面通过独立的 Page Request Message 请求，并通过共享相同的 PRG index 被识 别为属于同一个 PRG。PRG 的最后一个请求会在其 Page Request Message 中被标记为最 后一个。每个页面请求会消耗一个 request credit（而不是每个 PRG 消耗一个）。</p></blockquote><p>A PRG Response Message is a PCIe Message Request that is Routed by ID back to the requesting Function. It is used by system software to alert a Function that the page request(s) associated with the corresponding PRG has (have) been satisfied. The page request mechanism does not guarantee any request completion order and all requests are inherently independent of all other concurrently outstanding requests. If a Function requires that a particular request be completed before another request, the initial request will need to complete before the subsequent request is issued. It is valid for a Function to speculatively request a page without ascertaining its residence state and/or to issue multiple concurrently outstanding requests for the same page.</p><blockquote><p>PRG Response Message 是一种 PCIe Message Request，它会通过 ID 路由回发起请求的 Function。系统软件使用它来通知 Function，与对应 PRG 相关联的页面请求已经被满足。 page request 机制不保证请求完成的顺序，所有请求本质上都是彼此独立的，与其他并 发未完成的请求没有依赖关系。如果 Function 需要某个请求在另一个请求之前完成，必 须等到初始请求完成后再发起后续请求。Function 可以在不确定页面是否常驻的情况下， 提前发起页面请求，也可以对同一页面同时发起多个并发的请求，这都是允许的。</p></blockquote><p>A Page Request Interface is allocated a specific number of page request message credits. An RC (system software) can divide the available credits in any manner deemed appropriate. Any measures the host chooses to employ to ensure that credits are correctly metered by Page Request Interfaces (a Page Request Interface is not using more than its allocation) is an implementation choice. A Page Request Interface is not allowed to oversubscribe the available number of requests (doing so can result in the page request mechanism being disabled if the buffer limit is exceeded at the root). A Page Request Interface’s page request allocation is static. It is determined when the Page Request Interface is enabled and can only be changed by disabling and then re-enabling the interface.</p><blockquote><p>Page Request Interface 会被分配一定数量的 page request message credit。RC （system software）可以以任何认为合适的方式分配这些可用的 credit。host为确保 Page Request Interface 正确计量 credit（即 Page Request Interface 没有超出分配 额度使用 credit）所采取的任何措施，属于实现选择。Page Request Interface 不允许 超额发起请求（如果超出 root 端的 buffer 限制，可能导致 page request 机制被禁 用）。Page Request Interface 的 page request credit 分配是静态的：它在 Page Request Interface 启用时确定，只有在禁用并重新启用接口时才能更改。</p></blockquote><h3 id="1041-page-request-message"><span class="me-2">10.4.1 Page Request Message</span><a href="#1041-page-request-message" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A Function uses a Page Request Message to send page requests to its associated host. A page request indicates a page needed by the Function. The Page Request Interface associated with a Function is given a specific Page Request allocation. A Page Request Interface shall not issue page requests that exceed its page request allocation.</p><blockquote><p>Function 使用 Page Request Message 向其关联的host发送页面请求。每个页面请求表 示 Function 需要的一个页面。与 Function 关联的 Page Request Interface 会被分配 一个特定的 Page Request allocation。Page Request Interface 不得发起超过其 page request allocation 的页面请求。</p></blockquote><p>A page request contains the untranslated address of the page that is needed, the access permissions needed for that page, and a PRG index. A PRG Index is a 9-bit scalar that is assigned by the Function to identify the associated page request. Multiple pages may be requested using a single PRG index. When more than a single page is to be associated with a given PRG, the Last flag in the Page Request Record is cleared in all the requests except the last request associated with a given PRG (the flag is set in the last request). Page requests are responded to en mass. No response is possible (except for a Response Failure error) until the last request of a PRG has been received by the root. The number of PRGs that a Function can have outstanding at any given time is less than or equal to the associated Page Request Interface’s Outstanding Page Request Allocation. It is valid for a request group to contain multiple requests for the same page and for multiple outstanding PRGs to request the same page.</p><blockquote><p>page request 包含所需页面的未转换地址、该页面所需的访问权限，以及一个 PRG index。PRG index 是由 Function 分配的 9-bit 标量，用于标识相关的 page request。 可以通过同一个 PRG index 请求多个页面。当需要将多个页面关联到同一个 PRG 时， Page Request Record 中的 Last 标志位在该 PRG 关联的所有请求中都被清除，只有在 最后一个请求中该标志位才会被置位。page request 会被统一响应。在 root 收到某个 PRG 的最后一个请求之前，不会有响应（除了 Response Failure 错误之外）。Function 在任意时刻可拥有的未完成 PRG 数量小于等于其关联 Page Request Interface 的 Outstanding Page Request Allocation。一个请求组包含对同一页面的多个请求，以及 多个未完成的 PRG 同时请求同一页面，都是允许的。</p></blockquote><p>A Page Request Interface applies to the “main” Function and its enabled Shadow Functions (where the “main” is the Function that contains both the Page Request Extended Capability and the Shadow Function Extended Capability). All pages request messages of a single PRG must have the same Requester ID (of either the “main” Function or one of its Shadows).</p><blockquote><p>Page Request Interface 适用于 “main” Function 及其已启用的 Shadow Function（其 中 “main” 指同时包含 Page Request Extended Capability 和 Shadow Function Extended Capability 的 Function）。单个 PRG 的所有 page request message 必须具 有相同的 Requester ID（可以是 “main” Function，也可以是其某个 Shadow Function 的 Requester ID）。</p></blockquote><p>The first two DWs of a Page Request Message contain a standard PCIe message header. The second two DWs of the message contain page request specific data fields.</p><blockquote><p>Page Request Message 的前两个 DW（Double Word，双字）包含标准的 PCIe message header。该消息的后两个 DW 包含 page request 专用的数据字段。</p></blockquote><p><img src="pic/page_request_message.png" alt="page_request_message" /></p><p><img src="pic/page_request_message_fm.png" alt="page_request_message_fm" /></p><ul><li><p><strong><em>R</em></strong>: <strong>Read Access Requested</strong> - This field, when Set, indicates that the requesting Function seeks read access to the associated page. When Clear, this field indicates that the requesting Function will not read the associated page. If R and W are both Clear and L is Set, this is a Stop Marker (see § Section 10.4.1.2.1 ). The R field must be Set for Page Requests with a PASID and that have the Execute Requested bit Set.</p><blockquote><p>当该字段被置位时，表示请求的 Function 需要对关联页面的读访问权限。若该字段 为清除状态，则表示请求的 Function 不会读取关联页面。如果 R 和 W 都为清除状 态且 L 被置位，则该请求为 Stop Marker（参见第 10.4.1.2.1 节）。对于带有 PASID 且设置了 Execute Requested 位的 Page Request，R 字段必须被置位。</p></blockquote><li><p><strong><em>W</em></strong> <strong>Write Access Requested</strong> - This field, when Set, indicates that the requesting Function seeks write access and/or zero-length read access to the associated page. When Clear, this field indicates that the requesting Function will not write to the associated page.</p><p>Upon receiving a Page Request Message with the W field Set, the host is permitted to mark the associated page dirty.</p><p>If R and W are both Clear and L is Set, this is a Stop Marker (see § Section 10.4.1.2.1 ).</p><blockquote><p>当该字段被置位时，表示请求的 Function 需要对关联页面进行写访问和/或零长度 读访问。若该字段为清除状态，则表示请求的 Function 不会向关联页面写入数据。</p><p>当收到 W 字段被置位的 Page Request Message 时，host 可以将关联页面标记为 dirty。</p></blockquote><li><p><strong><em>L</em></strong> <strong>Last Request in PRG</strong> - This field, when Set, indicates that the associated page request is the last request of the associated PRG. A PRG can have a single entry, in which case the PRG consists of a single request in which this field is Set. When Clear, this field indicates that additional page requests will be posted using this record’s PRG Index.</p><blockquote><p>当该字段被置位时，表示关联的 page request 是对应 PRG 的最后一个请求。一个 PRG 可以只包含一个条目，此时该 PRG 仅由一个请求组成，并且该字段被置位。若 该字段为清除状态，则表示还会有更多的 page request 使用该记录的 PRG Index 被提交。</p></blockquote><p>If R and W are both Clear and L is Set, this is a Stop Marker (see § Section 10.4.1.2.1 ).</p><li><p><strong>Page Request Group Index</strong> - This field contains a Function supplied identifier for the associated page request. A Function need not employ the entire available range of PRG index values. A host shall never respond with a PRG Index that has not been previously issued by the Function and that is not currently an outstanding request PRG Index (except when issuing a Response Failure, in which case the host need not preserve the associated request’s PRG Index value in the error response).</p><blockquote><p>该字段包含由 Function 提供的、用于标识关联 page request 的标识符。Function 不必使用全部可用范围的 PRG index 值。host 不应对 Function 尚未发出的，或者 当前不是未完成请求的 PRG Index 进行响应（除非是在发出 Response Failure 时， 此时 host 在错误响应中无需保留关联请求的 PRG Index 值）。</p></blockquote><li><p><strong>Page Address</strong> - This field contains the untranslated address of the page to be loaded. For pages larger than 4096 bytes, the least significant bits of this field are ignored. For example, the least significant bit of this field is ignored when an 8096-byte page is being requested.</p><blockquote><p>该字段包含要加载页面的未转换地址。对于大于 4096 字节的页面，该字段的低位会 被忽略。例如，当请求一个 8096 字节的页面时，该字段的最低位会被忽略。</p></blockquote></ul><h4 id="10411-pasid-usage"><span class="me-2">10.4.1.1 PASID Usage</span><a href="#10411-pasid-usage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The PASID Extended Capability indicates whether a Function supports PASID TLP Prefixes (NFM) or OHC-A1 with PASID (FM), and whether it is enabled to send and receive them.</p><blockquote><p>PASID Extended Capability 指示一个 Function 是否支持 PASID TLP Prefix（NFM）或 OHC-A1 with PASID（FM），以及它是否已启用以发送和接收这些前缀。</p></blockquote><p>Functions that support PASID are permitted to send a PASID on Page Request Messages. The PASID field contains the process address space of the page being requested and the Execute Requested and Privileged Mode Requested bits indicate the access being requested.</p><blockquote><p>支持 PASID 的 Function 可以在 Page Request Message 中发送 PASID。PASID 字段包 含所请求页面的进程地址空间，Execute Requested 和 Privileged Mode Requested 位 指示所请求的访问权限。</p></blockquote><p>If one Page Request Message in a PRG has a PASID, all Page Request Messages in that PRG must contain identical PASID values. Behavior is undefined when the PASID values are inconsistent.</p><blockquote><p>如果一个 PRG 中的某个 Page Request Message 有 PASID，那么该 PRG 中所有的 Page Request Message 必须包含相同的 PASID 值。如果 PASID 值不一致，行为未定义。</p></blockquote><p>Functions that support PASID and have the PRG Response PASID Required bit Set (see § Section 10.5.2.3 ), expect that PRG Response Messages will contain a PASID if the associated Page Request Message had a PASID. For such PRG Response Messages, the Execute Requested and Privileged Mode Requested bits are reserved and the PASID field contains the PASID from the associated Page Request Message.</p><blockquote><p>支持 PASID 并且设置了 PRG Response PASID Required 位（参见第 10.5.2.3 节）的 Function，期望当相关的 Page Request Message 带有 PASID 时，PRG Response Message 也包含 PASID。对于这样的 PRG Response Message，Execute Requested 和 Privileged Mode Requested 位为保留位，PASID 字段包含来自关联 Page Request Message 的 PASID。</p></blockquote><h4 id="10412-managing-pasid-usage-on-prg-requests"><span class="me-2">10.4.1.2 Managing PASID Usage on PRG Requests</span><a href="#10412-managing-pasid-usage-on-prg-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>There are rules for stopping and starting the use of a PASID.</p><blockquote><p>对于停止和启动 PASID 的使用有相关规则。</p></blockquote><p>This section describes additional rules that apply to Functions that have issued Page Request Messages in a PASID that is being stopped. No additional rules are required to start the usage of the Page Request Interface for a PASID.</p><blockquote><p>本节描述了适用于在被停止的 PASID 中已经发出 Page Request Message 的 Function 的附加规则。对于启动 PASID 的 Page Request Interface 的使用，不需要额外的规则。</p></blockquote><p>When stopping the use of a particular PASID, a Stop Marker Message may be optionally used to avoid waiting for PRG Response Messages before the Function indicates that the stop request for a particular PASID has completed.</p><blockquote><p>当停止使用某个特定 PASID 时，可以选择性地使用 Stop Marker Message，以避免在 Function 指示某个 PASID 的停止请求已完成之前，必须等待 PRG Response Message。</p></blockquote><p>To stop without using a Stop Marker Message, the Function shall:</p><ol><li><p>Stop queueing new Page Request Messages for this PASID.</p><li><p>Finish transmitting any multi-page Page Request Messages for this PASID (i.e., send the Page Request Message with the L bit Set).</p><li><p>Wait for PRG Response Messages associated any outstanding Page Request Messages for the PASID.</p><li><p>Indicate that the PASID has stopped using a device specific mechanism. This mechanism must indicate that a Stop Marker Message will not be generated.</p></ol><blockquote><p>按照你的要求（功能、专业名词不翻译），下面是你的英文内容的中文翻译：</p></blockquote><blockquote><p>如果在停止时不使用 Stop Marker Message，Function 应当：</p></blockquote><blockquote><ol><li>停止为该 PASID 排队新的 Page Request Message。<li>完成对该 PASID 的所有多页 Page Request Message 的发送（即，发送带有 L 位设 置的 Page Request Message）。<li>等待与该 PASID 所有未完成 Page Request Message 相关的 PRG Response Message。<li>通过设备特定的机制指示该 PASID 已经停止。该机制必须能够指示不会生成 Stop Marker Message。</ol></blockquote><p>To stop with the use of a Stop Marker Message the Function shall:</p><ol><li><p>Stop queueing new Page Request Messages for this PASID.</p><li><p>Finish transmitting any multi-page Page Request Messages for this PASID (i.e., send the Page Request Message with the L bit Set).</p><li><p>Internally mark all outstanding Page Request Messages for this PASID as stale. PRG Response Messages associated with these requests will return Page Request Allocation credits and PRG Index values but are otherwise ignored. 184</p><li><p>Indicate that the PASID has stopped using a device specific mechanism. This mechanism must indicate that a Stop Marker Message will be generated.</p><li><p>Send a Stop Marker Message to indicate to the host that all subsequent Page Request Messages for this PASID are for a new use of the PASID value. Note: Steps 4 and 5 may be performed in either order, or in parallel.</p></ol><blockquote><p>如果在停止时使用 Stop Marker Message，Function 应当：</p><ol><li><p>停止为该 PASID 排队新的 Page Request Message。</p><li><p>完成对该 PASID 的所有多页 Page Request Message 的发送（即，发送带有 L 位设 置的 Page Request Message）。</p><li>在内部将该 PASID 的所有未完成 Page Request Message 标记为 stale。与这些请求 相关的 PRG Response Message 会返回 Page Request Allocation credit 和 PRG Index 值，但除此之外会被忽略。<li>通过设备特定的机制指示该 PASID 已经停止。该机制必须能够指示会生成 Stop Marker Message。<li>发送 Stop Marker Message，以向主机指示该 PASID 的所有后续 Page Request Message 都属于对该 PASID 值的新使用。</ol><p>注：步骤 4 和 5 可以任意顺序执行，也可以并行执行。</p></blockquote><h5 id="104121-stop-marker-messages"><span class="me-2">10.4.1.2.1 Stop Marker Messages</span><a href="#104121-stop-marker-messages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>A Stop Marker Message indicates that a Function has stopped using the Page Request Interface and has transmitted all pending Page Request Messages for a specific PASID. Stop Marker Messages are strongly ordered with respect to Page Request Messages and serve to push Page Request Messages toward the Host. When the Host receives the Stop Marker Message, this indicates that all Page Request Messages associated with the PASID being stopped have been delivered and that any subsequent Page Request Message with the same PASID value are associated with a new incarnation of that PASID value.</p><p>Stop Marker Messages do not have a response. They do not have a PRG Index and do not consume Page Request allocation (see § Section 10.5.2.5 ).</p><p>The Stop Marker Message bit layout is shown in § Figure 10-25.</p><p><img src="pic/stop_marker_message.png" alt="stop_marker_message" /></p><p>A Stop Marker Message is encoded as a Page Request Message for which:</p><ul><li><p>In NFM, includes a PASID TLP Prefix.</p><li>In FM, includes OHC-A1 with PASID. The Execute Requested and Privileged Mode Requested bits and the Last DW BW / 1st DW BE fields in the OHC-A1 are Reserved.<li>The L, W and R fields contain 1b, 0b and 0b respectively.<li>The Untranslated Address field and upper bits of the PRG Index field are Reserved.<li>The Marker Type field contains 0 0000b to indicate that this is a Stop Marker Message.<li>The Traffic Class must be 0.<li>The Relaxed Ordering attribute bit must be Clear.<li>The ID-Based Ordering attribute bit may be Set.</ul><p>Behavior is undefined if a Stop Marker Message is received and any of the following are true:</p><ul><li>Marker Type not equal to 0 0000b.<li>No PASID TLP Prefix is present (NFM).<li>The PASID value does not match an outstanding stop request.<li>An incomplete Page Request Message for the PASID is outstanding (i.e., for some PRG Index, the most recently received Page Request Message did not have the L bit Set).</ul><h3 id="1042-page-request-group-response-message"><span class="me-2">10.4.2 Page Request Group Response Message</span><a href="#1042-page-request-group-response-message" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>System hardware and/or software communicate with a Function’s page request interface via PRG Response Messages. A PRG Response Message is used by a host to signal the completion of a PRG, or the catastrophic failure of the interface. A single PRG Response Message is issued in response to a PRG, independent of the number of page requests associated with the PRG. There is no mechanism for indicating a partial request completion or partial request failure. If any of the pages associated with a given PRG cannot be satisfied, then the request is considered to have failed and the reason for the failure is supplied in the PRG Response Message. The host has no obligation to partially satisfy a multi-page request. If one of the requested pages cannot be made resident, then the entire request can, but need not, be discarded. That is, the residence of pages that share a PRG with a failed page request, but that are not associated with the failure, is indeterminate from the Function’s perspective.</p><p>There are four possible Page Request failures:</p><ol><li><p>The requested page is not a valid Untranslated Address.</p><li><p>PASID support exists, the Page Request has a PASID, and either PASID usage is not enabled for this request, the PASID value is not valid, or the Execute Requested bit is Set when R is Clear. 185</p><li><p>The requested page does not have the requested access attributes (including Execute permission and/or Privileged Mode access when those bits are present)</p><li><p>The system is, for an unspecified reason, unable to respond to the request. This response is terminal (the host may no longer respond to any page requests and may not supply any further replies to the Function until the Function’s page request interface has been reset). For example, a request that violates a Function’s assigned request limit or overflows the RC’s buffering capability may cause this type of failure.</p></ol><p>A Function’s response to Page Request failure cases 1, 2, and 3 above is implementation dependent. The failure is not necessarily persistent, that is, a failed request may, in some instances succeed if re-issued. The range of possibilities precludes the precise specification of a generalized failure behavior, though on a per Function basis, the response to a failure will be an implementation dependent behavior.</p><p>All responses are sent to their associated Functions via PRG Response Messages. A Function must be capable of sinking multiple consecutive messages without losing any information. To avoid deadlock, a Function must able to process PRG Response Messages for all of the Function’s outstanding Page Request Messages without depending on the Function sending or receiving any other TLP. 186 A PRG Response Message is an ID routed PCIe message. The only Page Request Interface specific fields in this message are the Response Code and PRG. All other fields are standard PCIe message fields. (Note: these messages are routed based on the ID in bytes 8 and 9; with bytes 4 and 5 containing the host’s Requester ID.)</p><p>Receipt of a PRG Response Message that contains a PRG Index that is not currently outstanding at a Function shall result in the UPRGI flag in the Page Request Extended Capability being Set, contingent upon the TLP otherwise being error free. Because of ambiguous language in earlier versions of this specification, it is permitted (though discouraged) to handle this case as an Unsupported Request (UR) or Unexpected Completion (UC) by the Function containing the Page Request Extended Capability, but otherwise no other error is permitted to be logged or signaled.</p><p><img src="pic/PRG.png" alt="PRG" /></p><h4 id="10422-pasid-usage-on-prg-responses"><span class="me-2">10.4.2.2 PASID Usage on PRG Responses</span><a href="#10422-pasid-usage-on-prg-responses" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If a Page Request has a PASID, the corresponding PRG Response Message may optionally contain one as well. If the PRG Response PASID Required bit is Clear, PRG Response Messages do not have a PASID.</p><p>If the PRG Response PASID Required bit is Set, PRG Response Messages have a PASID if the Page Request also had one. The Function is permitted to use the PASID value from the prefix in conjunction with the PRG Index to match requests and responses.</p><p>When a PASID is attached to PRG Response Messages, the Execute Requested and Privileged Mode Requested bits are Reserved and the PASID value is copied from the PASID value of the Page Request.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/pcie/">pcie</a>, <a href="/categories/ats/">ats</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/pcie/" class="post-tag no-text-decoration" >pcie</a> <a href="/tags/ats/" class="post-tag no-text-decoration" >ats</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=page%20request%20-%20one%20step%20at%20a%20time&url=%2Fposts%2Fpage-request%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=page%20request%20-%20one%20step%20at%20a%20time&u=%2Fposts%2Fpage-request%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fpage-request%2F&text=page%20request%20-%20one%20step%20at%20a%20time" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/sched-weight/">schedule: weight</a><li class="text-truncate lh-lg"> <a href="/posts/stride_sched_paper/">[论文翻译] Lottery and Stride Scheduling: Flexible Proportional-Share Resource Management</a><li class="text-truncate lh-lg"> <a href="/posts/RMM/">[arm] RMM</a><li class="text-truncate lh-lg"> <a href="/posts/sched/">schedule: overflow</a><li class="text-truncate lh-lg"> <a href="/posts/HOWTO-study-Linux-kernel/">How To study Linux kernel and become a committer</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/sched/">sched</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/cache/">cache</a> <a class="post-tag btn btn-outline-primary" href="/tags/io-virt/">io_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/kvm/">kvm</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/drain-pasid/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1745329860" data-df="ll" > Apr 22, 2025 </time><h4 class="pt-0 my-2">drain pasid</h4><div class="text-muted"><p>PASID 简介 PASID overflow PASID 全称Process Address Space ID, PASID 同 requester ID结合，共同确定该request 所映射的地址空间。所以 PASID 和 ASID 类似, 均标识一个地址映射关系。但是ASID 用于 标识CPU 侧的memory request，而PASID 则标识PCIe end point 的D...</p></div></div></a></article><article class="col"> <a href="/posts/acs/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1728788400" data-df="ll" > Oct 13, 2024 </time><h4 class="pt-0 my-2">acs</h4><div class="text-muted"><p>ACS defines a set of control points within a PCI Express topology to determine whether a TLP is to be routed normally, blocked, or redirected. ACS is applicable to RCs, Switches, and Multi-Function...</p></div></div></a></article><article class="col"> <a href="/posts/host-bridge/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1737639420" data-df="ll" > Jan 23, 2025 </time><h4 class="pt-0 my-2">host-bridge is pci device BUT NOT pci bridge</h4><div class="text-muted"><p>查看host-bridge配置空间 [root@A06-R08-I134-73-919XB72 openEuler-2403]# lspci -xxx -s 00:00.0 00: [86 80] [00 2f] [40 05] [10 00] 02 [00 00 06] 00 00 [00] 00 [vendor] [device] [comm...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/drain-pasid/" class="btn btn-outline-primary" aria-label="Older" ><p>drain pasid</p></a> <a href="/posts/bpf-overflow/" class="btn btn-outline-primary" aria-label="Newer" ><p>Bpf Overflow</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/fuqiang_cai">fuqiang wang</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v6.5.5" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/sched/">sched</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/cache/">cache</a> <a class="post-tag btn btn-outline-primary" href="/tags/io-virt/">io_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/kvm/">kvm</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
