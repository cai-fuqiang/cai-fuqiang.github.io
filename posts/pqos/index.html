<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="qpos – amd spec" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><meta property="og:description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><link rel="canonical" href="/posts/pqos/" /><meta property="og:url" content="/posts/pqos/" /><meta property="og:site_name" content="one step at a time" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-02-12T14:18:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="qpos – amd spec" /><meta name="twitter:site" content="@fuqiang_cai" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2025-02-12T14:18:00+08:00","datePublished":"2025-02-12T14:18:00+08:00","description":"A minimal, responsive and feature-rich Jekyll theme for technical writing.","headline":"qpos – amd spec","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/pqos/"},"url":"/posts/pqos/"}</script><title>qpos -- amd spec | one step at a time</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="one step at a time"><meta name="application-name" content="one step at a time"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"></a><h1 class="site-title"> <a href="/">one step at a time</a></h1><p class="site-subtitle fst-italic mb-0">a noob's growing diary</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cai-fuqiang" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fuqiang_cai" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['iwng86','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>qpos -- amd spec</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>qpos -- amd spec</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1739341080" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 12, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2086 words" > <em>11 min</em> read</span></div></div></div></header><div class="content"><ul><li><a href="#introduce">introduce</a><li><a href="#overflow">overflow</a><ul><li><a href="#features">features</a><li><a href="#features-detect">features detect</a></ul><li><a href="#pqm">PQM</a><ul><li><a href="#cpuid-pqm">CPUID (PQM)</a><li><a href="#configuration">configuration</a><ul><li><a href="#pqm-msr">PQM MSR</a></ul><li><a href="#monitoring-l3-occupancy">Monitoring L3 Occupancy</a><li><a href="#mbm">MBM</a><ul><li><a href="#bmec">BMEC</a><li><a href="#ambc">AMBC</a></ul></ul><li><a href="#pqe">PQE</a><ul><li><a href="#cat">cat</a><li><a href="#l3be">L3BE</a><li><a href="#l3smbe">L3SMBE</a><li><a href="#sdciae">SDCIAE</a></ul><li><a href="#相关链接">相关链接</a><ul><li><a href="#其他资讯">其他资讯</a></ul></ul><h2 id="introduce"><span class="me-2">introduce</span><a href="#introduce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>amd PQOS ~= intel RDT</p><blockquote class="prompt-info"><p>amd PQOS 和 intel RDT 实在是太像了，cpuid，包括MSR命名 格式几乎都一样。所以，之后的很多章节，我们仅把图片粘贴上， 以便之后查找。</p></blockquote><h2 id="overflow"><span class="me-2">overflow</span><a href="#overflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="features"><span class="me-2">features</span><a href="#features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>POS 包括两个主要的功能:</p><ul><li><strong>PQOS Monitoring(PQM)</strong>: monitoring the usage of shared resources<ul><li>L3 cache occupancy<li>L3 cache bandwidth</ul><li><strong>PQOS Enforcement(PQE)</strong>: set and enforce limits on usage of shared resources<ul><li>L3 cache allocation<li>L3 cache bandwidth</ul></ul><h3 id="features-detect"><span class="me-2">features detect</span><a href="#features-detect" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p>PQE, PQM</p><p>通过 CPUID Fn0000_0007_EBx[PQE, PQM] 来查看PQOS主要功能检测 :</p><p><img src="pic/CPUID_Fn0000_0000_EBX_x0.png" alt="CPUID_Fn0000_0000_EBX_x0" /></p><li><p>PQOS Versions</p><p>PQOS相关的attribute和capablities也使用CPUID 报告, 但是某些早期CPU使用PQOS version, PQOS version 和具体的 Family/Model 关系如下:</p><p><img src="pic/PQOS_Version.png" alt="PQOS_Version" /></p><li><p>capablities &amp;&amp; attribute of PQOS</p><ul><li>Fn0000_000F: PQM<li>Fn0000_0010: PQE</ul></ul><p>具体的细节，我们放到之后的章节中分别介绍。</p><h2 id="pqm"><span class="me-2">PQM</span><a href="#pqm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="cpuid-pqm"><span class="me-2">CPUID (PQM)</span><a href="#cpuid-pqm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Fn0000_000F_EDX_x0:<ul><li>EDX[bit 1] L3CacheMon: 是否支持L3 monitoring<li>EBX: RMID 最大值</ul><p><img src="pic/CPUID_Fn0000_000F_x0.png" alt="CPUID_Fn0000_000F_x0" /></p><li>Fn0000_000F_EDX_x1: 是否支持某些monitor的sub feature<ul><li>EAX<ul><li>non-zero: it indicates the size of the L3 monitoring counter, offset from 24 bits.<li>0: the counter size is determined by the PQOS version number</ul><blockquote><p>在<a href="#pqm-msr">PQM MSR</a>章节中会介绍</p></blockquote><li>EBX: counter scaling factor, 在通过QM_CTR 获取到counter值的时候， 需要在乘 scaling factor 来获取实际的 cache occupancy/bandwidth(bytes)<li><p>ECX: identifies the largest RMID for L3 monitoring</p><li>EDX[bit 0]: L3 Occupancy<li>EDX[bit 1]: L3 total bandwidth<li>EDX[bit 2]: L3 local bandwidth</ul><p><img src="pic/Fn0000_000F_EDX_x1.png" alt="Fn0000_000F_EDX_x1" /></p><li><p>Fn8000_0020_EBX_x0: 包含一些PQM和PQE的一些扩展功能:</p><p><img src="pic/Fn8000_0020_EBX_x0.png" alt="Fn8000_0020_EBX_x0" /></p><p>其中BMEC和ABMC是PQM功能，其余都是PQE功能。</p></ul><h3 id="configuration"><span class="me-2">configuration</span><a href="#configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="pqm-msr"><span class="me-2">PQM MSR</span><a href="#pqm-msr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>PQR_ASSOC</p><p><img src="pic/PQR_ASSOC.png" alt="PQR_ASSOC" /></p><li><p>QM_EVTSEL</p><p><img src="pic/QM_EVTSEL.png" alt="QM_EVTSEL" /></p><p>和intel rdt不同的是, qpos似乎支持一些Extended Event</p><p><img src="pic/QM_EVTSEL_EvtID.png" alt="QM_EVTSEL_EvtID" /></p><p>Q: 为什么要这么搞呢，按照道理EvtID[bit 0-7] 可以配置255个字段, 为什么要 弄一个类似于二维的字段呢</p><p>A: <strong>不知道</strong></p><li><p>QM_CTR</p><p><img src="pic/QM_CTR.png" alt="QM_CTR" /></p><p>其中, 关于CNT_LEN 可以在 CPUID Fn0000_000F_EAX_x1[CounterSize]中获取到。 具体值为(CounterSize + 24)</p><p>但是如果获取到CounterSize的值为0， 则需要根据PQOS Version 来判定:</p><p><img src="pic/Counter_Size_when_CounterSize_in_Fn0000_000F_EAX_x1__0.png" alt="Counter_Size_when_CounterSize_in_Fn0000_000F_EAX_x1__0" /></p></ul><h3 id="monitoring-l3-occupancy"><span class="me-2">Monitoring L3 Occupancy</span><a href="#monitoring-l3-occupancy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>如前面提到eventid为1，其他略， 和rdt cat 功能一样</p><h3 id="mbm"><span class="me-2">MBM</span><a href="#mbm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>MBM eventid 类型如下:</p><p><img src="pic/Trans_types_and_evtid.png" alt="Trans_types_and_evtid" /></p><blockquote class="prompt-tip"><ol><li>read to Local NUMA Domain: 为什么需要两个eventid。</ol><p>因为</p><ul><li>evtid 2 获取 total<li>evtid 3 获取 non-local</ul><p>所以 local = evtid2 - evtid3</p><ol><li>non-temporal 参考amd sdm <code class="language-plaintext highlighter-rouge">4.6.1.2 Move non-temporal</code>, 大概的意思 是说，操作的数据是非临时数据，短时间内不会访问到(非临时的意思是， 这个数据比较稳定，现在store了一个值，短时间内不会被访问修改)</ol></blockquote><p>从上面来看，evtid 和 并且但是其多了一些更细粒度的控制eventid功能， 主要有两个:</p><ul><li>BMEC<li>AMBC</ul><h4 id="bmec"><span class="me-2">BMEC</span><a href="#bmec" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>BMEC feature 允许软件配置指定的L3 transcation 被监控计数。其提供了一组n个MSRs, – QOS_EVT_CFG_n , 其用来指定对应的L3CacheBwMonEvt<n> 对应的event id的BW type。</n></p><p>例如QOS_EVT_CFG_1 对应与 L3CacheBwMonEvt_1, 其对应的EvtID是3，而QOS_EVT_CFG_1则 可以配置指定EvtID 3 的 BW type, 如下图所示</p><p><img src="pic/BMEC_EVENT_AND_ATTR.png" alt="BMEC_EVENT_AND_ATTR" /></p><p>上图还展示了EvtID 2 默认配置为 Total L3 Bandwidth, EvtID 3 的默认配置为 Local L3 Bandwidth</p><ul><li><p>CPUID</p><p>BMEC 通过cpuid 获取如下信息</p><ul><li>Fn8000_0020_EBX_x0[BMEC] (bit 3): 判定BMEC功能是否支持<li>Fn8000_0020_EBX_x3[EVT_NUM] (bit 7:0): 指示 QOS_EVT_CFG 中的 n<li>CPUID Fn8000_0020_ECX_x3: 指示哪些类型的L3 tranaction 被counted</ul><p>QOS_EVT_CFG_n, n 值表示EVT_NUM ， 其在实现中 &gt;= 2</p><li><p>QOS_EVT_CFG_n MSR details</p><p><img src="pic/QOS_EVT_CVFG_n.png" alt="QOS_EVT_CVFG_n" /></p></ul><p>所以，该功能就是提供了一种方式，可以指定EvtID的BW type。可以是一个集合(QOS_EVT_CFG_n 中多个bit置位)</p><h4 id="ambc"><span class="me-2">AMBC</span><a href="#ambc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>AMBC 就更加灵活, 支持指定一组counter , 这些counter 用来计数特定的RMID（COS）,BwType, counterID, 并且查询这些counter时，也仍然使用<code class="language-plaintext highlighter-rouge">QM_EVTSEL</code>, <code class="language-plaintext highlighter-rouge">QM_CTR</code>. 只不过在设置 <code class="language-plaintext highlighter-rouge">QM_EVTSEL</code>时，按照另一种方式配置，下面会介绍。</p><p>我们来看下具体细节:</p><ul><li>CPUID: Fn8000_0020_x5<ul><li>EAX: 指示counter的大小以及counter的overflow bit<li>EBX: 指示支持的ABMC counter的数量<li>ECX: 指示能不能在 QOS_ABMC_CFG 中的BwTSrc字段中填写COS 而非RMID</ul><li><p>L3_QOS_EXT_CFG</p><p><img src="pic/L3_QOS_EXT_CFG.png" alt="L3_QOS_EXT_CFG" /></p><p>该MSR 用来使能ABMC 功能.( 当然还有一个PQE相关功能 SDCIAE, 在<a href="#pqe">PQE</a> 章节中会介绍)</p><li><p>L3_QOS_AMBC_CFG MSR</p><p><img src="pic/L3_QOS_ABMC_CFG.png" alt="L3_QOS_ABMC_CFG" /></p><ul><li>CfgEn: 如果使能，则表示本次会配置该register 分配到（作用于) CtrID中指定的counter, 反之则不会有任何配置<li>CtrEn: 如果使能，则表示本次会使能对 Bw Type field tracking.<li>CtrID: 表明该寄存器作用与哪个counter<li>IsCOS: 指示 BwSrc 是 COS 还是RMID<li>BwSrc: COS/RMID<li>BwType: 上图中展示了。</ul><li><p>L3_QOS_ABMC_DEC MSR</p><p>读取该寄存器，获取的是 QOS_EVT_CFG 的配置的值, 所以其格式和 几乎QOS_ABMC_CFG MSR相同. 但是有一个字段需要注意下:</p><ul><li>CfgErr: 如果是1， 则表示上一次配置是invalid，并且相应的counter 是not enabled.</ul></ul><p>这两个寄存器用来，获取/更新 当前 AMBC 配置.</p><ul><li>QM_EVTSEL - 通过下面方式选定:<ul><li>EventedEvtID: 12<li>EvtID: L3CacheAMBC<li>RMID: 需要配置为counter id</ul><li>QM_CTR 读取QM_EVTSEL 选定的 counter值</ul><h2 id="pqe"><span class="me-2">PQE</span><a href="#pqe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>PQE 功能主要分为:</p><ul><li>CAT<li>CDP<li>L3 bandwidth allocation<li>L3 slow memory bandwidth allocation<li>SDCI allocation enforcement</ul><p>CPUID <code class="language-plaintext highlighter-rouge">Fn0000_00010_EDX_x0</code> 用来 指示 是否支持<code class="language-plaintext highlighter-rouge">L3 Alloc</code></p><p><img src="pic/CPUID_Fn0000_0010_EDX_X0.png" alt="CPUID_Fn0000_0010_EDX_X0" /></p><p>CPUID <code class="language-plaintext highlighter-rouge">Fn0000_00010_x1_ECX_1</code> 来指示是否支持哪些sub-feature:</p><ul><li>EAX: 指示 CBM_LEN<li>EBX: 指示 L3 Cache Allocation Sharing Mask<li>ECX: 指示是否支持一些增强功能，例如CDP<li>EDX: 指示 COS_MAX</ul><p>我们分功能介绍</p><h3 id="cat"><span class="me-2">cat</span><a href="#cat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>这里我们不过多介绍CAT, 因为大部分和rdt一样，只不过CBM对应于L3_MASK.</p><p>但是需要注意一点，CPUID Fn 0000_0010_EBX_x1[L3ShareAllocmask] 表示其他的一些function肯定会共享这些L3 cache。所以，在L3ShareAllocMask 中bit为1时， 对应的cache即便是配置了各个CPU对应的CLOS 的L3_MASK 没有overlap，也仍然有其他的function 和该cpu争抢cache。</p><h3 id="l3be"><span class="me-2">L3BE</span><a href="#l3be" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们主要关注下这部分，其功能配置和rdt很不一样。</p><p>AMD 的带宽控制，是允许软件配置一个最大的带宽限制(通过 L3BE MSR), 该值是一个absolute bw number:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>L3BE value ++ == limit BW + 1/8 GB/s, 所以跟rdt的比例throttle还不一样。

我们看下具体细节
</pre></table></code></div></div><ul><li>CPUID<ul><li>Fn8000_0020_EBX_x0<a href="bit 1">L3BE</a>: 指示L3BE是否支持<li>Fn8000_0020_x1:<ul><li>EAX[30:0]: BW LEN(下面会介绍)<li>EDX[31:0]: L3BE feature支持的最大 COS number</ul></ul><li><p>L3QOS_BW_CONTROL_n MSRs （用来配置 bw limit)</p><p><img src="pic/L3QOS_BW_CONTROL.png" alt="L3QOS_BW_CONTROL_n" /></p><ul><li>U(unlimited): 当设置是，表明当前COS bw 不受限制，该MSR中的BW字段被忽略<li>BW: expressed in 1/8 GB/s increment</ul></ul><p>在某些时候，某个COS怎么也达不到设置的受限制，可能是由于下面原因:</p><ol><li>The specified limit may be greater than the maximum system bandwidth.<blockquote><p>内存总带宽受限</p></blockquote><li>The sum of the limits applied to all classes of service in the domain may exceed the maximum bandwidth the system can deliver to that COS domain.<blockquote><p>软件配置的所有其他cos limit 超过了系统能给该COS domain的最大带宽。</p></blockquote><li>Multiple COS domains which share the same memory channels may demand more total bandwidth than the shared memory can supply.<blockquote><p>内存通道受限</p></blockquote><li>I/O or other system entities may consume a large fraction of system bandwidth and result in less bandwidth being available to the various processor COS domains.<blockquote><p>I/O 设备抢占带宽</p></blockquote><li>Large amounts of write traffic may affect the memory system’s ability to deliver read bandwidth.<blockquote><p>写带宽影响了读带宽</p></blockquote></ol><p>手册中还举了一个例子, 大致为，有两个COSx, y. COSx 配置 limit A， COS y 配置Limit 2 * A. 此时总带宽为 2 * A, 带宽肯定不够分，此时 分配给COS x A， COS y A， 而不是按照其比例，分配 (2/3)* A 给COS x， (4/3) * A 给 y.</p><p>另外, 当CDP enable时，L3QOS_BW_CONTROL 只能用0, 2, 4, 6这样的index寄存器， 例如</p><ul><li>COS 0 -&gt; index 0<li>COS 1 -&gt; index 1<li>COS 2 -&gt; index 2</ul><p>所以，该寄存器只能用一半。这样的操作很迷, 不知道为啥。</p><h3 id="l3smbe"><span class="me-2">L3SMBE</span><a href="#l3smbe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>L3SMBE 配置和L3BE 很像，只不过是控制slow memory 带宽，不再赘述。</p><h3 id="sdciae"><span class="me-2">SDCIAE</span><a href="#sdciae" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Smart Data Cache Injection 可以让I/O 设备访问L3 cache. 避免直接访问内存， 这样可以减少对内存带宽的占用。</p><p>而SDCIAE 功能则可以限制 SDCI 所占用的L3 cache的portion.</p><p>该功能页很简单，如果开启了该功能，只允许SDCI 使用L3<em>MASK</em>[MAX_COS]指示的缓存， 例如如果 MAX_COS 是15， 则SDCI 将根据 L3_MASK_15 分配缓存。</p><h2 id="相关链接"><span class="me-2">相关链接</span><a href="#相关链接" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li><a href="https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/40332.pdf">amd spec 19 Platform Quality of Service (PQOS) Extension</a></ol><h3 id="其他资讯"><span class="me-2">其他资讯</span><a href="#其他资讯" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><a href="https://www.phoronix.com/news/AMD-Platform-QoS-RFC-Patches">AMD Publishes Platform QoS Patches For Next-Gen Processors</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/amd-sdm/">amd_sdm</a>, <a href="/categories/qpos/">qpos</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/amd-sdm/" class="post-tag no-text-decoration" >amd_sdm</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=qpos%20--%20amd%20spec%20-%20one%20step%20at%20a%20time&url=%2Fposts%2Fpqos%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=qpos%20--%20amd%20spec%20-%20one%20step%20at%20a%20time&u=%2Fposts%2Fpqos%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fpqos%2F&text=qpos%20--%20amd%20spec%20-%20one%20step%20at%20a%20time" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/page-request/">page request</a><li class="text-truncate lh-lg"> <a href="/posts/drain-pasid/">drain pasid</a><li class="text-truncate lh-lg"> <a href="/posts/lat-mem-bench/">[perftest] lat mem rd</a><li class="text-truncate lh-lg"> <a href="/posts/Core-to-Core-latency/">[perftest] core-to-core-latency</a><li class="text-truncate lh-lg"> <a href="/posts/ats/">ats</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/cache/">cache</a> <a class="post-tag btn btn-outline-primary" href="/tags/kvm/">kvm</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/perftest/">perftest</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/rdt/" class="btn btn-outline-primary" aria-label="Older" ><p>rdt -- intel spec</p></a> <a href="/posts/coroutine/" class="btn btn-outline-primary" aria-label="Newer" ><p>qemu coroutine</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/fuqiang_cai">fuqiang wang</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v6.5.5" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/pcie/">pcie</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/cache/">cache</a> <a class="post-tag btn btn-outline-primary" href="/tags/kvm/">kvm</a> <a class="post-tag btn btn-outline-primary" href="/tags/live-migration/">live_migration</a> <a class="post-tag btn btn-outline-primary" href="/tags/perftest/">perftest</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
