<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="qemu coroutine" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction Linux User Context Switch qemu coroutine 协程状态机 CREATE and INIT enter switch yield Use Case for QEMU" /><meta property="og:description" content="Introduction Linux User Context Switch qemu coroutine 协程状态机 CREATE and INIT enter switch yield Use Case for QEMU" /><link rel="canonical" href="/posts/coroutine/" /><meta property="og:url" content="/posts/coroutine/" /><meta property="og:site_name" content="Chirpy" /><meta property="og:image" content="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/pic/coroutine_all.svg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-02-25T11:00:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/pic/coroutine_all.svg" /><meta property="twitter:title" content="qemu coroutine" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2025-02-25T11:00:00+08:00","datePublished":"2025-02-25T11:00:00+08:00","description":"Introduction Linux User Context Switch qemu coroutine 协程状态机 CREATE and INIT enter switch yield Use Case for QEMU","headline":"qemu coroutine","image":"https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/pic/coroutine_all.svg","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/coroutine/"},"url":"/posts/coroutine/"}</script><title>qemu coroutine | Chirpy</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Chirpy"><meta name="application-name" content="Chirpy"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/commons/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Chirpy</a><p class="site-subtitle fst-italic mb-0">A text-focused Jekyll theme</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/overflow/" class="nav-link"> <i class="fa-fw fas fa-star"></i> <span>OVERFLOW</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/github_username" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>qemu coroutine</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>qemu coroutine</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1740452400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 25, 2025 </time> </span><div class="mt-3 mb-3"> <a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/pic/coroutine_all.svg" class="popup img-link preview-img shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/pic/coroutine_all.svg" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2823 words" > <em>15 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">qemu coroutine</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">qemu coroutine</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><ul><li><a href="#introduction">Introduction</a><li><a href="#linux-user-context-switch">Linux User Context Switch</a><li><a href="#qemu-coroutine">qemu coroutine</a><ul><li><a href="#协程状态机">协程状态机</a><li><a href="#create-and-init">CREATE and INIT</a><li><a href="#enter">enter</a><li><a href="#switch">switch</a><li><a href="#yield">yield</a></ul><li><a href="#user-case-for-qemu">Use Case for QEMU</a></ul><h2 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>多线程和协程都可以用于并行编程，但是他们实现方式和使用场景 有很大的区别，我们来对比下:</p><div class="table-wrapper"><table><thead><tr><th>对比项<th>协程<th>多线程<tbody><tr><td>实现方式<td><strong>在用户态单线程中，完成上下文切换</strong><td>内核态完成上下文切换<tr><td>开销<td><strong>开销较低</strong><td>线程创建销毁，以及切换都需要进入内核态，<br />开销较高<tr><td>并发<td>只能在单个线程中来回切换完成并发<td><strong>可以实现真正的并行处理（在多核cpu)</strong><tr><td>调度(切换)<td>协程类似于非抢占式调度，<br />只能在主动切换<td><strong>线程可以在任何时刻被中断和切换</strong><tr><td>程序复杂度<td><strong>协程处理同步和资源共享较简单</strong><td>多线程编程需要处理线程间的同步和资 <br />源共享问题, 复杂度更高, 往往需要借助系统api<br />(锁，信号量)</table></div><p>使用场景上:</p><ul><li>协程<ul><li>当应用程序主要是 I/O 密集型任务，如网络请求、文件操作等<li>当需要高并发但不需要并行计算</ul><li>使用多线程的场景<ul><li>当应用程序是 CPU 密集型任务，需要利用多核 CPU 的并行计算能力<li>当需要处理大量需要同时执行的计算任务时</ul></ul><p>协程比较适合那种需要wait的任务, 例如上面提到的I/O 密集型任务(qemu中的 aio, 可以在协程中下发多个aio，然后等待io complete event)</p><p>我们举个例子:</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程_vs_多线程.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程_vs_多线程.svg" alt="协程vs多线程" loading="lazy"></a></p><p>在该图中, 有两个cpu core, A进程有3个thread, 其中thread1和thread2在 cpu0上运行，thread 3 有四个协程，在cpu1上运行, task A 的计算负载可 以分别落在cpu 0 和cpu 1上, 这也是多线程的很大的优点: 可以最大化的利 用多核cpu的并行处理能力。</p><p>thread1和thread2其靠kernel的任务抢占机制，来共享cpu 0, 在任何时间都有 可能被对方抢占. 而thread3 中的各个协程则是 根据自己任务的完成情况， 或者当前任务是否需要等待而主动选择调度。</p><h2 id="linux-user-context-switch"><span class="me-2">Linux User Context Switch</span><a href="#linux-user-context-switch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我们需要思考下，context switch 完成哪些任务:</p><ul><li>init new task context<ul><li>like pthread_create()<li>need init IP, SP(a new stack), Params</ul><li>context switch<ul><li>save…<li>load…</ul><li>destroy</ul><p>如果用户态要完成context switch，需要处理好上面所列的三件事。而这些事情涉及的东西 太底层了，如设置ip，如传参等等，所以libc中提供了<code class="language-plaintext highlighter-rouge">ucontext</code>系列接口来完成这些事情:</p><h3 id="ucontext"><span class="me-2">ucontext</span><a href="#ucontext" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="ucontext-api"><span class="me-2">ucontext API</span><a href="#ucontext-api" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="table-wrapper"><table><thead><tr><th>API name<th>作用<tbody><tr><td>getcontext(ucontext_t *ucp)<td>获取当前上下文, 保存到ucp中<tr><td>setcontext(ucp)<td>切换到目标(ucp)上下文<tr><td>makecontext(ucp, (*func)(), int argc, …)<td>用来modify ucp, 下面详述<tr><td>swapcontext(oucp, ucp)<td>saves current thread context <br />in oucp and makes *ucp the currently <br />active context.</table></div><p>在执行makecontext()之前，需要做一些准备工作:</p><ol><li>调用 getcontext() 来init ucp,<li>需要为其分配stack, init ucontext_t.uc_stack 相关成员<ul><li>ss_sp: 指向具体的堆栈地址<li>ss_size: 堆栈大小<li>ss_flags:</ul><li>设置<code class="language-plaintext highlighter-rouge">ucp-&gt;uc_link</code>参数，根据是否设置<code class="language-plaintext highlighter-rouge">ucp-&gt;uc_link</code> 来确定func() 返回时， 所执行的动作:<ul><li>NULL: 进程退出<li>隐式调用 setcontext(ucp-&gt;uc_link)</ul></ol><p>我们编写一个例子来演示下，该接口的使用方法和效果</p><h4 id="ucontext-example"><span class="me-2">ucontext example</span><a href="#ucontext-example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><details open=""> <summary>测试程序展开</summary><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ucontext.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="cp">#define STACK_SIZE  (4096 * 2)
</span>
<span class="kt">void</span> <span class="nf">print_current_stack</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_pointer</span><span class="p">;</span>
        <span class="n">__asm__</span><span class="p">(</span><span class="s">"movq %%rsp, %0"</span> <span class="o">:</span> <span class="s">"=r"</span><span class="p">(</span><span class="n">stack_pointer</span><span class="p">));</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"stack pointer(%lx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>  <span class="n">stack_pointer</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"the co exec, sum(%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"print co stack </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">print_current_stack</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">STACK_SIZE</span><span class="p">);</span>

        <span class="n">ucontext_t</span> <span class="n">uc</span><span class="p">,</span> <span class="n">old_uc</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"the new stack is %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">stack</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"print main stack:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">print_current_stack</span><span class="p">();</span>
        <span class="n">getcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uc</span><span class="p">);</span>
        <span class="n">uc</span><span class="p">.</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_sp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">;</span>
        <span class="n">uc</span><span class="p">.</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_size</span> <span class="o">=</span> <span class="n">STACK_SIZE</span><span class="p">;</span>

        <span class="n">uc</span><span class="p">.</span><span class="n">uc_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">old_uc</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"main co a(%d) b(%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
                <span class="n">makecontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">func</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"swap context</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">swapcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_uc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"swap context end</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">++</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>

        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details><p>在<code class="language-plaintext highlighter-rouge">main</code>中jum构建一个循环，来在另一个上下文中调用<code class="language-plaintext highlighter-rouge">func()</code>, 并设置 返回的context为调用者(main())的context，这样<code class="language-plaintext highlighter-rouge">func()</code>返回后， 直接返回到<code class="language-plaintext highlighter-rouge">main()</code>的<code class="language-plaintext highlighter-rouge">while</code>的上下文, 继续执行循环。</p><details open=""> <summary>输出示例</summary><p>输出如下:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>the new stack is 0x9d22a0
print main stack:
stack pointer(7fff0939ee50)
main co a(0) b(0)
swap context
the co exec, sum(0)
print co stack
stack pointer(9d4250)
swap context end
main co a(1) b(2)
swap context
the co exec, sum(3)
print co stack
stack pointer(9d4250)
swap context end
main co a(2) b(4)
swap context
the co exec, sum(6)
print co stack
stack pointer(9d4250)
swap context end
main co a(3) b(6)
swap context
the co exec, sum(9)
print co stack
stack pointer(9d4250)
swap context end
</pre></table></code></div></div></details><p>由上图可见，<code class="language-plaintext highlighter-rouge">func()</code>和<code class="language-plaintext highlighter-rouge">main()</code>运行在两个上下文，并且两个上下文切换示意图 如下:</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/ucontext_switch.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/ucontext_switch.svg" alt="ucontext_switch" loading="lazy"></a></p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/ucontext_switch_c_code.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/ucontext_switch_c_code.svg" alt="ucontext_switch_c_code" loading="lazy"></a></p><p>另外，linux中还支持另外一组上下文切换的API – sigsetjmp, siglongjmp</p><h3 id="sigsetjmp-siglongjmp"><span class="me-2">sigsetjmp, siglongjmp</span><a href="#sigsetjmp-siglongjmp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>该系列函数一般用于实现C语言中的异常处理，如在信号处理流程中，跳转到 其他的执行流程. 避免再次执行到异常代码.</p><p>我们先来看下其API</p><ul><li>sigsetjmp(sigjmp_buf env, int savemask)<ul><li><strong>功能</strong>: 保存当前的上下文和信号掩码，以便以后可以通过 siglongjmp 恢复<li><strong>参数</strong>:<ul><li>env: 保存上下文信息<li>savemask: 如果非0， 当前的信号掩码也会被保存</ul><li><strong>返回值</strong>:<ul><li>调用者返回0<li>如果通过<code class="language-plaintext highlighter-rouge">siglongjmp</code>恢复，而返回<code class="language-plaintext highlighter-rouge">siglongjmp</code> 传递的值</ul></ul><li>siglongjmp(sigjmp_buf env, int val)<ul><li><strong>功能</strong>: 恢复由 sigsetjmp 保存的上下文信息和信号掩码，并从 sigsetjmp 返回。<li><strong>参数</strong>:<ul><li><code class="language-plaintext highlighter-rouge">env</code>: 由<code class="language-plaintext highlighter-rouge">sigsetjmp</code>保存的环境信息<li><code class="language-plaintext highlighter-rouge">val</code>: <code class="language-plaintext highlighter-rouge">sigsetjmp</code><ul><li>0: return 1<li>x(x != 0) : return x</ul></ul><li>没有返回值(因为已经跳走了)</ul></ul><p>看起来sigxxxjmp也可以实现上下文切换，但是该系列接口有个很大的问题，比较适合 recover, 但不适合new。其不像<code class="language-plaintext highlighter-rouge">ucontext</code>接口, 可以通过<code class="language-plaintext highlighter-rouge">makecontext()</code>接口先new一个context, <code class="language-plaintext highlighter-rouge">sigsetjmp</code> 只能保存当前的现场, 所以相当于只能先走到要切换的流程中埋好点，然后才能切换，很不方便.</p><p>但是<code class="language-plaintext highlighter-rouge">sigxxxjmp()</code>对比<code class="language-plaintext highlighter-rouge">makecontext()</code>也有好处. 其更加轻量化. 它不会涉及完整的上下文切换, 例如其可以设置不切换信号掩码，减少因系统调用而产生的切换损耗.</p><p>而qemu中的协程实现主要有三种</p><ul><li><code class="language-plaintext highlighter-rouge">ucontext + sigjmp</code>: util/coroutine-ucontext.c<li><code class="language-plaintext highlighter-rouge">sigaltstack</code>: util/coroutine-sigaltstack.c<li><code class="language-plaintext highlighter-rouge">coroutine-win32</code></ul><p>本文主要介绍第一种，由<code class="language-plaintext highlighter-rouge">ucontext</code>和<code class="language-plaintext highlighter-rouge">sigjmp</code>结合实现。其中，<code class="language-plaintext highlighter-rouge">ucontext</code>系列接口负责 new context, 为<code class="language-plaintext highlighter-rouge">sigjmp</code>接口埋点, 而<code class="language-plaintext highlighter-rouge">sigjmp</code> 系列接口负责协程切换.</p><p>接下来，我们来看下qemu实现:</p><h2 id="qemu-coroutine"><span class="me-2">qemu coroutine</span><a href="#qemu-coroutine" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="协程状态机"><span class="me-2">协程状态机</span><a href="#协程状态机" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程状态机.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程状态机.svg" alt="协程状态机" loading="lazy"></a></p><p>这是一个典型的由 leader 创建协程的状态机，进入协程上下文会做两种事:</p><ul><li>埋sigxxxjmp跳转点, 为之后再次切换进协程做准备<li>work…</ul><p>协程运行期间，可能因为wait io等事件选择先切出协程(COROUTINE_YIELD), 此时协程是suspend状态。</p><p>等待协程处理完完整的事物后，会切出协程上下文，并置为terminal 状态.</p><p>另外除了首次进入协程是使用<code class="language-plaintext highlighter-rouge">ucontext</code>接口, 剩余的协程/leader之间的切换， 均使用<code class="language-plaintext highlighter-rouge">sigxxxjmp</code>系列接口，这样可以尽量减少因切换上下文带来性能损耗。</p><h3 id="整体流程"><span class="me-2">整体流程</span><a href="#整体流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>整个流程如下图:</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/coroutine_all.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/coroutine_all.svg" alt="co all" loading="lazy"></a></p><h3 id="create-and-init"><span class="me-2">CREATE and INIT</span><a href="#create-and-init" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>create流程主要是为协程准备好上下文环境, init 流程主要是在协程中 打好跳转点, 流程包括:</p><ol><li>为协程分配堆栈空间<li>使用makecontext(), swapcontext() 执行到一个新的上下文<li>在协程上下文中，埋 sig jmp的点<li>跳转回leader 上下文</ol><p>INIT流程只是为协程搭建了一个上下文，但是该上下文接下来要执行什么任务， 需要leader指明，所以在切回leader上下文后，leader还需要为协程准备协程要 执行的函数，以及函数参数(<span style="background-color: #CC0066; color: #00FFFF;">红底蓝字部分</span>)</p><h3 id="enter"><span class="me-2">enter</span><a href="#enter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在<code class="language-plaintext highlighter-rouge">create &amp;&amp; INIT</code> 章节中，我们介绍到首次进入协程是通过<code class="language-plaintext highlighter-rouge">swapcontext()</code>接口, 而之后再次进入协程，就需要使用<code class="language-plaintext highlighter-rouge">sigxxxjmp</code>系列接口，本章节主要介绍第二种。</p><p>而<code class="language-plaintext highlighter-rouge">enter</code>这个动作既有可能发生在<code class="language-plaintext highlighter-rouge">leader</code>上下文，也有可能发生在协程上下文, 所以我们以下面的场景为例子，看下qemu是怎么处理的。</p><ul><li>leader enter 协程A<li>协程A enter 协程B<li>假设协程A, 协程B 在处理过程中不会yield, 直接terminal.</ul><p>整个流程如下图:</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程enter.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程enter.svg" alt="协程enter" loading="lazy"></a></p><p>这样处理，会导致协程只能串行，不能嵌套执行。</p><p>我们来想下为什么要这样做, 首先我们来看下，两者上下文切换次数:</p><ul><li>串行执行<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>leader-&gt;A-&gt;leader-&gt;B-&gt;leader
</pre></table></code></div></div><p>切换4次</p><li>嵌套执行<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>leader-&gt;A-&gt;B-&gt;A-&gt;leader
</pre></table></code></div></div><p>切换4次</p></ul><p>两者切换次数相同。</p><p>所以这里的原因(猜测)很可能是，防止协程可能带来的 同步问题（避免A上下文中嵌入B的上下文从而带来死锁)</p><h3 id="switch"><span class="me-2">switch</span><a href="#switch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>接下来，我们再来看下switch过程。switch过程比较简单。主要的函数是, <code class="language-plaintext highlighter-rouge">qemu_coroutine_switch()</code>, 函数原型:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">CoroutineAction</span> <span class="nf">qemu_coroutine_switch</span><span class="p">(</span><span class="n">Coroutine</span> <span class="o">*</span><span class="n">from_</span><span class="p">,</span> <span class="n">Coroutine</span> <span class="o">*</span><span class="n">to_</span><span class="p">,</span>
                                    <span class="n">CoroutineAction</span> <span class="n">action</span><span class="p">);</span>
</pre></table></code></div></div><p>参数有三个:</p><ul><li>from: 切出的协程<li>to: 切入的协程<li>action: 本次操作的类型<ul><li><code class="language-plaintext highlighter-rouge">COROUTINE_YIELD</code>: 暂停from协程<li><code class="language-plaintext highlighter-rouge">COROUTINE_TERMINATE</code>: 终止from协程<li><code class="language-plaintext highlighter-rouge">COROUTINE_ENTER</code>: 进入to协程</ul></ul><p>我们以一个没有执行过yield协程生命周期来看下switch的细节:</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/qemu_coroutine_switch.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/qemu_coroutine_switch.svg" alt="qemu_coroutine_switch" loading="lazy"></a></p><p>可以看到在执行<code class="language-plaintext highlighter-rouge">qemu_coroutine_switch()</code>时，action参数会作为 <code class="language-plaintext highlighter-rouge">siglongjmp(, action)</code>传入，这样在另一个上下文中，会通过 <code class="language-plaintext highlighter-rouge">sigsetjmp()</code>的返回值，获取到action, 而<code class="language-plaintext highlighter-rouge">qemu_aio_coroutine_enter()</code> 会根据协程返回状态，来选择一些action:</p><ul><li>COROUTINE_TERMINATE: 销毁协程<li>COROUTINE_YIELD: 忽略，继续执行leader流程</ul><p>这里我们来总结下，不同的switch过程:</p><ul><li>leader-&gt;co<ul><li>ENTER:</ul><li>co-&gt;leader<ul><li>TERMINATE<li>YIELD</ul></ul><h3 id="yield"><span class="me-2">yield</span><a href="#yield" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>yield是一个比较特殊的存在，因为yield动作时，还需要保存协程的现场， 以便之后，再次切回协程。并且在协程yield切回leader后，leader会继续 运行执行其他流程。等待该协程的等待的事件到来后，需要再次执行enter 切换回该协程，如下图所示:</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程_yield.svg" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/qemu/coroutine/./pic/协程_yield.svg" alt="协程yield" loading="lazy"></a></p><h2 id="use-case-for-qemu"><span class="me-2">Use Case for QEMU</span><a href="#use-case-for-qemu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="附录"><span class="me-2">附录</span><a href="#附录" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="virtio-blk触发堆栈"><span class="me-2">virtio-blk触发堆栈</span><a href="#virtio-blk触发堆栈" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>virtio_blk_handle_vq
<span class="c">## 从avail ring中获取req</span>
<span class="o">=&gt;</span> blk_io_plug<span class="o">()</span>
<span class="o">=&gt;</span> <span class="k">while</span> <span class="o">(</span>virtio_blk_get_request<span class="o">())</span>
<span class="o">=&gt;</span> virtio_blk_submit_multireq<span class="o">()</span>
   <span class="o">=&gt;</span> foreach request:
      <span class="c">## 可能会merge submit</span>
      <span class="o">=&gt;</span> submit_requests<span class="o">()</span>
         <span class="o">=&gt;</span> init qemu iovc
         <span class="o">=&gt;</span> blk_aio_pwritev/blk_aio_preadv
<span class="o">=&gt;</span> blk_io_unplug<span class="o">()</span>

blk_aio_pwritev
<span class="o">=&gt;</span> blk_aio_prwv<span class="o">(</span>,,,,co_entry::blk_aio_write_entry, flags, 
        cb:: virtio_blk_rw_complete,opaque<span class="o">)</span>
   <span class="o">=&gt;</span> init acb::BlkAioEmAIOCB
   <span class="o">=&gt;</span> qemu_coroutine_create<span class="o">(</span>co_entry, acb<span class="o">)</span>
   <span class="o">=&gt;</span> bdrv_coroutine_enter<span class="o">(</span>blk_bs<span class="o">(</span>blk<span class="o">)</span>, co<span class="o">)</span>
</pre></table></code></div></div><h2 id="参考资料"><span class="me-2">参考资料</span><a href="#参考资料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li><a href="https://blog.csdn.net/huang987246510/article/details/93139257?ops_request_misc=%257B%2522request%255Fid%2522%253A%252203d32d36da34d66cc6d602cb63fa9f6e%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=03d32d36da34d66cc6d602cb63fa9f6e&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-93139257-null-null.nonecase&amp;utm_term=%E5%8D%8F%E7%A8%8B&amp;spm=1018.2226.3001.4450s">huangyong – 深入理解qemu协程</a><li><a href="https://blog.csdn.net/chengm8/article/details/94023921">_银叶先生 – 协程的原理与实现：qemu 之 Coroutine</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/qemu/">qemu</a>, <a href="/categories/coroutine/">coroutine</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/qemu/" class="post-tag no-text-decoration" >qemu</a> <a href="/tags/qemu-coroutine/" class="post-tag no-text-decoration" >qemu_coroutine</a> <a href="/tags/completed/" class="post-tag no-text-decoration" >completed</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=qemu%20coroutine%20-%20Chirpy&url=%2Fposts%2Fcoroutine%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=qemu%20coroutine%20-%20Chirpy&u=%2Fposts%2Fcoroutine%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fcoroutine%2F&text=qemu%20coroutine%20-%20Chirpy" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/seqcounter-and-seqlock/">sequence counters and sequential locks</a><li class="text-truncate lh-lg"> <a href="/posts/rcu-classic/">rcu - classic</a><li class="text-truncate lh-lg"> <a href="/posts/tdx-spec/">intel tdx (spec)</a><li class="text-truncate lh-lg"> <a href="/posts/rcu-overflow/">rcu - overflow</a><li class="text-truncate lh-lg"> <a href="/posts/intel-memory-encryption/">intel memory encryption technologies</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/synchronization/">synchronization</a> <a class="post-tag btn btn-outline-primary" href="/tags/os/">os</a> <a class="post-tag btn btn-outline-primary" href="/tags/rcu/">rcu</a> <a class="post-tag btn btn-outline-primary" href="/tags/spinlock/">spinlock</a> <a class="post-tag btn btn-outline-primary" href="/tags/tee/">tee</a> <a class="post-tag btn btn-outline-primary" href="/tags/completed/">completed</a> <a class="post-tag btn btn-outline-primary" href="/tags/mktme/">mktme</a> <a class="post-tag btn btn-outline-primary" href="/tags/non-blocking-algorithm/">non-blocking algorithm</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu/">qemu</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-coroutine/">qemu_coroutine</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/qspinlock/" class="btn btn-outline-primary" aria-label="Older" ><p>qspinlock</p></a> <a href="/posts/non-blocking-algorithm/" class="btn btn-outline-primary" aria-label="Newer" ><p>non-blocking algorithm</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://twitter.com/username">your_full_name</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/synchronization/">synchronization</a> <a class="post-tag btn btn-outline-primary" href="/tags/os/">os</a> <a class="post-tag btn btn-outline-primary" href="/tags/rcu/">rcu</a> <a class="post-tag btn btn-outline-primary" href="/tags/spinlock/">spinlock</a> <a class="post-tag btn btn-outline-primary" href="/tags/tee/">tee</a> <a class="post-tag btn btn-outline-primary" href="/tags/completed/">completed</a> <a class="post-tag btn btn-outline-primary" href="/tags/mktme/">mktme</a> <a class="post-tag btn btn-outline-primary" href="/tags/non-blocking-algorithm/">non-blocking algorithm</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu/">qemu</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-coroutine/">qemu_coroutine</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'zh-CN';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'cai-fuqiang/cai-fuqiang.github.io', 'data-repo-id': 'R_kgDOPsVm6A', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOPsVm6M4C0OXB', 'data-mapping': 'pathname', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
