<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="intel memory encryption technologies" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="introduction" /><meta property="og:description" content="introduction" /><link rel="canonical" href="/posts/intel-memory-encryption/" /><meta property="og:url" content="/posts/intel-memory-encryption/" /><meta property="og:site_name" content="Chirpy" /><meta property="og:image" content="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/MKTME_OVERFLOW.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-12-29T16:10:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/MKTME_OVERFLOW.png" /><meta property="twitter:title" content="intel memory encryption technologies" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2025-12-29T16:10:00+08:00","datePublished":"2025-12-29T16:10:00+08:00","description":"introduction","headline":"intel memory encryption technologies","image":"https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/MKTME_OVERFLOW.png","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/intel-memory-encryption/"},"url":"/posts/intel-memory-encryption/"}</script><title>intel memory encryption technologies | Chirpy</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Chirpy"><meta name="application-name" content="Chirpy"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/commons/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Chirpy</a><p class="site-subtitle fst-italic mb-0">A text-focused Jekyll theme</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/overflow/" class="nav-link"> <i class="fa-fw fas fa-star"></i> <span>OVERFLOW</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/github_username" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>intel memory encryption technologies</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>intel memory encryption technologies</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1766995800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 29, 2025 </time> </span><div class="mt-3 mb-3"> <a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/MKTME_OVERFLOW.png" class="popup img-link preview-img shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/MKTME_OVERFLOW.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2151 words" > <em>11 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">intel memory encryption technologies</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">intel memory encryption technologies</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="introduction"><span class="me-2">introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="tme"><span class="me-2">TME</span><a href="#tme" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Total Memory Encryption (TME) – the capability to encrypt the entirety of physical memory of a system. This capability is typically enabled in the very early stages of the boot process with a small change to BIOS and once configured and locked, will encrypt all the data on external memory buses of an SoC using the NIST standard AES-XTS algorithm with 128-bit keys or 256-bit keys depending on the algorithm availability and selection. The encryption key used for TME uses a hardware random number generator implemented in the Intel SoC, and the keys are not accessible by software or using external interfaces to the Intel SoC. TME capability is intended to provide protections of AES-XTS to external memory buses and DIMMs. The architecture is flexible and will support additional memory protection schemes in the future. This capability, when enabled, is intended to support (unmodified) existing system and application software. Overall performance impact of this capability is likely to be relatively small and is highly dependent on workload</p><blockquote class="prompt-trans"><p>intel TME 引入自 <code class="language-plaintext highlighter-rouge">3rd generation Intel ® Xeon ® Scalable Processor Family</code> 用来 提供内存加密支持。全内存加密 (TME) 功能可对系统的全部物理内存进行加密。此功能通 常在启动过程的早期阶段通过对 BIOS 进行少量更改即可启用。配置并锁定后，TME 将使用 NIST 标准的 AES-XTS 算法，根据算法的可用性和选择情况，使用 128 位或 256 位密钥， 对 SoC 外部内存总线上的所有数据进行加密。 TME 使用的加密密钥由 Intel SoC 中实现 的硬件随机数生成器生成，软件或通过 Intel SoC 的外部接口均无法访问这些密钥。TME 功能旨在为外部内存总线和 DIMM 提供 AES-XTS 加密保护。该架构具有灵活性，未来将支 持其他内存保护方案。启用此功能后，旨在支持（未经修改的）现有系统和应用程序软件。 此功能对整体性能的影响可能相对较小，并且高度依赖于工作负载。</p></blockquote><h3 id="mktme"><span class="me-2">MKTME</span><a href="#mktme" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Total Memory Encryption-Multi-Key (TME-MK) builds on TME and adds support for multiple encryption keys. The SoC implementation supports a fixed number of encryption keys, and software can configure the SoC to use a subset of available keys. Software manages the use of keys and can use each of the available keys for encrypting any page of the memory. Thus, TME-MK allows page granular encryption of memory. By default, TME-MK uses the TME encryption key unless explicitly specified by software. In addition to supporting a CPU generated ephemeral key (not accessible by software or using external interfaces to the SoC), TME-MK also supports software provided keys. Software provided keys are particularly useful when used with non-volatile memory or when combined with attestation mechanisms and/or used with key provisioning services. In a virtualization scenario, we anticipate the VMM or hypervisor managing the use of keys to transparently support legacy operating systems without any changes (thus, TME-MK can also be viewed as TME virtualization in such a deployment scenario). An OS may be enabled to take additional advantage of the TME-MK capability both in native and in a virtualized environment. When properly enabled, TME-MK is available to each guest OS in a virtualized environment, and the guest OS can take advantage of TME-MK in the same way as a native OS.</p><blockquote class="prompt-trans"><p>TME-MK 则在TME基础上实现, 增加了对多个密钥的支持。SoC 实现支持固定数量的加密密钥， 软件可以配置 SoC 使用可用密钥的子集。软件管理密钥的使用，并可以使用每个可用密钥 加密内存的任何页面。因此，TME-MK 允许对内存进行页级加密。默认情况下，TME-MK 使用 TME 加密密钥，除非软件明确指定。除了支持 CPU 生成的临时密钥（软件无法访问，也无 法通过 SoC 的外部接口访问）之外，TME-MK 还支持软件提供的密钥。软件提供的密钥在与 非易失性内存一起使用，或与认证机制结合使用和/或与密钥配置服务一起使用时特别有用。 在虚拟化场景中，我们预期 VMM 或虚拟机管理程序将管理密钥的使用，从而透明地支持旧 版操作系统而无需任何更改（因此，在这种部署场景下，TME-MK 也可被视为 TME 虚拟化。 操作系统可以启用 TME-MK 功能，以便在原生环境和虚拟化环境中都能充分利用其优势。正 确启用后，虚拟化环境中的每个客户操作系统都可以使用 TME-MK，并且客户操作系统可以 像原生操作系统一样利用 TME-MK。</p></blockquote><h3 id="总结"><span class="me-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">TME</code> 是intel 内存加密的早期版本，其支持一个key。可以允许对所有物理内存进行 <code class="language-plaintext highlighter-rouge">AES-XTS</code> 加密。该功能算是一个基础功能，为之后其他功能的引入奠定了基础。</p><p>而 <code class="language-plaintext highlighter-rouge">TME-MK</code> 对比 <code class="language-plaintext highlighter-rouge">TME</code> 的最大的改进是，引入了多个key的管理。而其一个很重要的应用 场景是虚拟化，可以为不同的虚拟机分配不同的密钥，进一步增加安全性。</p><h2 id="tme-简介"><span class="me-2">TME 简介</span><a href="#tme-简介" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/two_socket_configuration_tme.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/two_socket_configuration_tme.png" alt="two_socket_configuration_tme" loading="lazy"></a></p><p>加密引擎位于<code class="language-plaintext highlighter-rouge">direct data path to external memory buses</code>(总之卡在接口处, upstream 是解密downstream 是加密), 上半部分 主要是cache等都是解密的。而下面部分，主要是 DRAM 为加密。</p><p>另外系统如果使用了<code class="language-plaintext highlighter-rouge">NVRAM</code>, 可以让<code class="language-plaintext highlighter-rouge">NVRAM</code>视为 <code class="language-plaintext highlighter-rouge">DRAM</code>, 也可以使用密钥进行加披靡</p><h2 id="mktme简介"><span class="me-2">MKTME简介</span><a href="#mktme简介" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/MKTME_OVERFLOW.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/MKTME_OVERFLOW.png" alt="MKTME_OVERFLOW" loading="lazy"></a></p><p>硬件架构基本与TME相同。不同点在于 <code class="language-plaintext highlighter-rouge">MKTME</code> 是使用多个key进行加密。如上图所示:</p><p>上图是一个虚拟化环境有两个VM, VM1 VM2，另外有<code class="language-plaintext highlighter-rouge">0,1,2,3</code> 四个keyid。其中 key1, key2 分别是 VM1, VM2的私有key，用来加密内部不共享的内存。而key0为 TME 的key，可 以对任何页面使用(个人认为一般用户和host 访问的share page), key3用于加密 vm1, vm2共享的内存。</p><p>另外，这种机制不仅用于普通页表，也用于 IA 页表 IOMMU 页表。(IA页表个人认为普通页表)</p><h2 id="memory-encryption-emulation-and-control-registers"><span class="me-2">Memory Encryption Emulation and Control Registers</span><a href="#memory-encryption-emulation-and-control-registers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="emulation"><span class="me-2">emulation</span><a href="#emulation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>TME 和 TME-MK 通过一些MSR将功能暴露给软件。BIOS通过MSR激活该功能，必须在启动初期选择 用于 TME-MK 的密钥数量。激活后，链接到CPU的所有内存都会使用<code class="language-plaintext highlighter-rouge">AES-XTS</code>加密。另外, TME 可以支持<code class="language-plaintext highlighter-rouge">encryption bypass</code>, 使用该功能的话，所有使用<code class="language-plaintext highlighter-rouge">KeyID0</code> 的访问均绕过加 解密。</p><h4 id="tme-1"><span class="me-2">TME</span><a href="#tme-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">CPUID.TME (CPUID.(EAX=07H, ECX=0H): ECX[13])</code> 枚举下面MSR:</p><ul><li>IA32_TME_CAPABILITY – Address 981H<li>IA32_TME_ACTIVATE – Address 982H<li>IA32_TME_EXCLUDE_MASK – Address 983H<li>IA32_TME_EXCLUDE_BASE – Address 984H</ul><h4 id="tme-mk"><span class="me-2">TME-MK</span><a href="#tme-mk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">IA32_TME_CAPABILITY</code> 将进一步枚举<code class="language-plaintext highlighter-rouge">TME, TME-MK</code> 的功能, <code class="language-plaintext highlighter-rouge">TME-MK</code> 由 BIOS 使用 <code class="language-plaintext highlighter-rouge">IA32_TME_ACTIVATE</code> MSR 启用/配置。TME-MK 需要 TME，因此必须启用 TME 才能启用 TME-MK。</p><h4 id="ia32_tme_capability"><span class="me-2">IA32_TME_CAPABILITY</span><a href="#ia32_tme_capability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/TME_CAP_MSR.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/TME_CAP_MSR.png" alt="TME_CAP_MSR" loading="lazy"></a></p><ul><li><strong><em>31</em></strong>: 用于枚举前面提到的TME旁路（不过这里是枚举，是否启用得看activate 配置, 下面的字段同理)<li><strong><em>35:32</em></strong> : <code class="language-plaintext highlighter-rouge">MK_TME_MAX_KEYID_BITS</code> 可分配用作多密钥内存加密密钥标识符的位数 （如果不支持<code class="language-plaintext highlighter-rouge">TME-MK</code>, 该字段设置为0)<li><strong><em>50:36</em></strong> : <code class="language-plaintext highlighter-rouge">MK_TME_MAX_KEYS</code> : 表示可供使用的最大按键数量</ul><h3 id="memory-encryption-configuration-and-status-registers"><span class="me-2">Memory Encryption Configuration and Status Registers</span><a href="#memory-encryption-configuration-and-status-registers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="ia32_tme_activate"><span class="me-2">IA32_TME_ACTIVATE</span><a href="#ia32_tme_activate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_ACTIVATE_part1.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_ACTIVATE_part1.png" alt="IA32_TME_ACTIVATE_part1" loading="lazy"></a></p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_ACTIVATE_part2.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_ACTIVATE_part2.png" alt="IA32_TME_ACTIVATE_part2" loading="lazy"></a></p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_ACTIVATE_part3.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_ACTIVATE_part3.png" alt="IA32_TME_ACTIVATE_part3" loading="lazy"></a></p><ul><li><strong><em>0</em></strong> : 锁定位，写过一次该msr就会置1<li><strong><em>1</em></strong>: 是否启用TME<li><strong><em>31</em></strong> : Bypass enable bivt<li><strong><em>35:32</em></strong>: 用于 <code class="language-plaintext highlighter-rouge">TME-MK</code> 的key 的数量。注意，不能大于<code class="language-plaintext highlighter-rouge">IA32_TME_CAPABILITY</code></ul><h4 id="mk_tme_core_activate"><span class="me-2">MK_TME_CORE_ACTIVATE</span><a href="#mk_tme_core_activate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>(略, 没看懂干啥的)</p><h3 id="exclusion-range-msrs"><span class="me-2">Exclusion Range MSRs</span><a href="#exclusion-range-msrs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>TME 和 TME-MK（ <strong>仅限 KeyID=0</strong> ）支持一个用于特殊情况的排除范围。此 MSR 中指定 的物理地址范围不应用本文档中描述的内存加密。</p><p>该功能主要用于系统访问bios 初始化的一些内存（bios在早起初始化时，还没有加密，所以当时 init的内存，是未加密的内存).</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_EXCLUDE_MASK__BASE.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/IA32_TME_EXCLUDE_MASK__BASE.png" alt="IA32_TME_EXCLUDE_MASK__BASE" loading="lazy"></a></p><p><strong>MASK(MAXPHYSADDR-1:12)</strong> 和 <strong>BASE(MAXPHYSADDR-1:12)</strong> 两者构造了一段地址空间，用于 <code class="language-plaintext highlighter-rouge">keyID0</code>不加密区间</p><h2 id="runtime-behavior-of-tme-mk"><span class="me-2">Runtime Behavior of TME-MK</span><a href="#runtime-behavior-of-tme-mk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="changes-to-specification-of-physical-address"><span class="me-2">Changes to Specification of Physical Address</span><a href="#changes-to-specification-of-physical-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>同前面所述, <code class="language-plaintext highlighter-rouge">KeyID</code> 存放在[Max_pa bit , 0] 的高位部分:</p><p><a href="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/keyid_usage.png" class="popup img-link shimmer"><img src="https://cdn.jsdelivr.net/gh/cai-fuqiang/cai-fuqiang.github.io@myblob_master/_posts/tee/arch/x86/tme_and_mk_tme/pic/keyid_usage.png" alt="keyid_usage" loading="lazy"></a></p><h3 id="ia-paging"><span class="me-2">IA Paging</span><a href="#ia-paging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>不使用 EPT的情况下，IA 分页entry 中的字段从 MAX_PA 开始的高位将被重新用作 keyID 位。类似地，CR3 中物理地址的高位也将以相同的方式处理。</p><p>当 EPT 处于活动状态时，IA 分页不用 HPA ，而是用 GPA。GPA 不会被 TME-MK 修改，并 将继续像启用 TME-MK 之前一样索引到 EPT 页表遍历中。</p><h3 id="ept-paging"><span class="me-2">EPT Paging</span><a href="#ept-paging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>启用 EPT 时，EPT entry 也是这样使用 KeyID 。和 CR3 类似，EPTP 中pa 也是相同方式处理。 请注意，guest 也可以在 IA 中使用 KeyID，并且 EPT 会使用完整的 guest PA（包括 KeyID）。</p><h3 id="其他地址"><span class="me-2">其他地址</span><a href="#其他地址" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>例如 VMCS, physically addressed bitmaps也是采用类似的方式寻址。</p><h2 id="tme-mk-key-programming"><span class="me-2">TME-MK Key Programming</span><a href="#tme-mk-key-programming" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>(略)</p><h2 id="software-life-cycle-managing-pages-with-keyid"><span class="me-2">Software Life Cycle: Managing Pages with KeyID</span><a href="#software-life-cycle-managing-pages-with-keyid" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>(略)</p><h2 id="参考资料"><span class="me-2">参考资料</span><a href="#参考资料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><code class="language-plaintext highlighter-rouge">&lt;&lt;Intel ® Architecture Memory Encryption Technologies Specification&gt;&gt;</code></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/tee/">tee</a>, <a href="/categories/arch-intel/">arch_intel</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/tee/" class="post-tag no-text-decoration" >tee</a> <a href="/tags/tme/" class="post-tag no-text-decoration" >tme</a> <a href="/tags/mktme/" class="post-tag no-text-decoration" >mktme</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=intel%20memory%20encryption%20technologies%20-%20Chirpy&url=%2Fposts%2Fintel-memory-encryption%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=intel%20memory%20encryption%20technologies%20-%20Chirpy&u=%2Fposts%2Fintel-memory-encryption%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fintel-memory-encryption%2F&text=intel%20memory%20encryption%20technologies%20-%20Chirpy" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/tdx-spec/">intel tdx (spec)</a><li class="text-truncate lh-lg"> <a href="/posts/intel-memory-encryption/">intel memory encryption technologies</a><li class="text-truncate lh-lg"> <a href="/posts/non-scalable-vs-scalable-spinlock/">non-scalable VS scalable spinlock</a><li class="text-truncate lh-lg"> <a href="/posts/non-blocking-algorithm/">non-blocking algorithm</a><li class="text-truncate lh-lg"> <a href="/posts/coroutine/">qemu coroutine</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/synchronization/">synchronization</a> <a class="post-tag btn btn-outline-primary" href="/tags/spinlock/">spinlock</a> <a class="post-tag btn btn-outline-primary" href="/tags/tee/">tee</a> <a class="post-tag btn btn-outline-primary" href="/tags/completed/">completed</a> <a class="post-tag btn btn-outline-primary" href="/tags/mktme/">mktme</a> <a class="post-tag btn btn-outline-primary" href="/tags/non-blocking-algorithm/">non-blocking algorithm</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu/">qemu</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-coroutine/">qemu_coroutine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rcu-preliminaries/">rcu preliminaries</a> <a class="post-tag btn btn-outline-primary" href="/tags/tdx/">tdx</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/tdx-spec/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1767074400" data-df="ll" > Dec 30, 2025 </time><h4 class="pt-0 my-2">intel tdx (spec)</h4><div class="text-muted"><p>## overflow **_add new operation mode_** **Secure Arbitration Mode (SEAM)** 是对于VMX 架构的扩展。在 vmx root/non-root operation(我们只有称为 legacy vmx XXX operation)下新增了两组模式: * SEAM VMX root operation * SEAM V...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/non-scalable-vs-scalable-spinlock/" class="btn btn-outline-primary" aria-label="Older" ><p>non-scalable VS scalable spinlock</p></a> <a href="/posts/tdx-spec/" class="btn btn-outline-primary" aria-label="Newer" ><p>intel tdx (spec)</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/username">your_full_name</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/synchronization/">synchronization</a> <a class="post-tag btn btn-outline-primary" href="/tags/spinlock/">spinlock</a> <a class="post-tag btn btn-outline-primary" href="/tags/tee/">tee</a> <a class="post-tag btn btn-outline-primary" href="/tags/completed/">completed</a> <a class="post-tag btn btn-outline-primary" href="/tags/mktme/">mktme</a> <a class="post-tag btn btn-outline-primary" href="/tags/non-blocking-algorithm/">non-blocking algorithm</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu/">qemu</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-coroutine/">qemu_coroutine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rcu-preliminaries/">rcu preliminaries</a> <a class="post-tag btn btn-outline-primary" href="/tags/tdx/">tdx</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'zh-CN';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'cai-fuqiang/cai-fuqiang.github.io', 'data-repo-id': 'R_kgDOPsVm6A', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOPsVm6M4C0OXB', 'data-mapping': 'pathname', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
