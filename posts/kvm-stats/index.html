<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="kvm stats" /><meta name="author" content="fuqiang" /><meta property="og:locale" content="en" /><meta name="description" content="背景" /><meta property="og:description" content="背景" /><link rel="canonical" href="/posts/kvm-stats/" /><meta property="og:url" content="/posts/kvm-stats/" /><meta property="og:site_name" content="one step at a time" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-11-29T21:17:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="kvm stats" /><meta name="twitter:site" content="@fuqiang_cai" /><meta name="twitter:creator" content="@fuqiang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fuqiang"},"dateModified":"2024-11-29T21:17:00+08:00","datePublished":"2024-11-29T21:17:00+08:00","description":"背景","headline":"kvm stats","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/kvm-stats/"},"url":"/posts/kvm-stats/"}</script><title>kvm stats | one step at a time</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="one step at a time"><meta name="application-name" content="one step at a time"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"></a><h1 class="site-title"> <a href="/">one step at a time</a></h1><p class="site-subtitle fst-italic mb-0">a noob's growing diary</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cai-fuqiang" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fuqiang_cai" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['iwng86','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>kvm stats</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>kvm stats</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1732886220" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 29, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2382 words" > <em>13 min</em> read</span></div></div></div></header><div class="content"><h2 id="背景"><span class="me-2">背景</span><a href="#背景" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我们如果对一个只启动bios的虚拟机做热迁移，发现其实际迁移的数据量不大， 如下:</p><p>qemu 参数:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># src</span>
qemu-system-x86_64 <span class="nt">-m</span> 16G <span class="nt">--nographic</span> <span class="nt">--enable-kvm</span> <span class="nt">--serial</span> tcp:localhost:6666,server,nowait <span class="nt">--monitor</span> stdio
<span class="c"># dst: </span>
qemu-system-x86_64 <span class="nt">--incoming</span> tcp:xxxx:9000 <span class="nt">-m</span> 16G <span class="nt">--nographic</span> <span class="nt">--enable-kvm</span>
</pre></table></code></div></div><p>执行热迁移命令:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>(qemu) migrate -d tcp:xxxx:9000
(qemu) info migrate
globals:
store-global-state: on
only-migratable: off
send-configuration: on
send-section-footer: on
decompress-error-check: on
clear-bitmap-shift: 18
Migration status: completed
total time: 3064 ms
downtime: 10 ms
setup: 6 ms
transferred ram: 38349 kbytes
throughput: 102.73 mbps
remaining ram: 0 kbytes
total ram: 16794440 kbytes
duplicate: 4198330 pages
skipped: 0 pages
normal: 283 pages
normal bytes: 1132 kbytes
dirty sync count: 3
page size: 4 kbytes
multifd bytes: 0 kbytes
pages-per-second: 1387941
precopy ram: 38022 kbytes
downtime ram: 12 kbytes
</pre></table></code></div></div><p>可以发现</p><ul><li><code class="language-plaintext highlighter-rouge">transferrd ram</code> : 37M<li><code class="language-plaintext highlighter-rouge">normal</code> : 283 pages<li><code class="language-plaintext highlighter-rouge">duplicate</code> : 4198330 pages</ul><p>其中<code class="language-plaintext highlighter-rouge">normal</code> 表示正常发送的页, <code class="language-plaintext highlighter-rouge">duplicate</code> 表示一些特殊处理的页，可能 多个page只发送一份，或者只发送特征（如zero page，就无需发送实际数据).</p><blockquote><p>NOTE</p><p>TODO: XXX 我们在XXXX 中会介绍，在qemu read Page 时，会不会触发 mmu notify to kvm mmu page</p></blockquote><p>而VM在启动初期，guest大部分内存都不会访问，所以大部分内存在qemu看起来 都是zero page。</p><p>我们来看下这部分内存qemu是如何处理的。</p><h2 id="details"><span class="me-2">details</span><a href="#details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="qemu-migration-save-page"><span class="me-2">QEMU migration save page</span><a href="#qemu-migration-save-page" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>热迁移save page 流程大致如下:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre>qemu_savevm_state_iterate
<span class="o">=&gt;</span> foreach_savevm_state<span class="o">(</span>se<span class="o">)</span>
   <span class="o">=&gt;</span> se-&gt;ops-&gt;save_live_iterate<span class="o">()</span>
      <span class="o">=&gt;</span> ram_find_and_save_block
         <span class="o">=&gt;</span> get_queued_page<span class="o">()</span>   <span class="c"># for post copy</span>
         <span class="c"># 从ramlist.blocks的bitmap中获取到dirty RAMBlocks</span>
         <span class="o">=&gt;</span> found <span class="o">=</span> find_dirty_block<span class="o">()</span>  
         <span class="o">=&gt;</span> <span class="k">if </span>found
            <span class="c"># 将RAMBlocks-&gt;dirty_bitmap </span>
            <span class="o">=&gt;</span> ram_save_host_page
ram_save_host_page
  <span class="o">=&gt;</span> foreach dirtybitmap bit 
     <span class="o">=&gt;</span> migration_bitmap_clear_dirty  <span class="c">## deley clean log</span>
        <span class="o">=&gt;</span> migration_clear_memory_region_dirty_bitmap
           <span class="o">=&gt;</span> memory_region_clear_dirty_bitmap
              <span class="o">=&gt;</span> foeach memorylistener
                 <span class="c">## nodify kvm set WP or clear D</span>
                 <span class="o">=&gt;</span> listener-&gt;log_clear<span class="o">()</span>
        <span class="o">=&gt;</span> test_and_clear_bit<span class="o">(</span>page, rb-&gt;bmap<span class="o">)</span><span class="p">;</span> <span class="c"># rb = RAMBlock</span>
        <span class="o">=&gt;</span> rs-&gt;migration_dirty_pages--
     <span class="o">=&gt;</span> ram_save_target_page <span class="c">## save page</span>
        <span class="o">=&gt;</span> control_save_page<span class="o">()</span> <span class="c">## control pages</span>
        <span class="c">## compress ....</span>
        <span class="o">=&gt;</span> <span class="k">if</span> <span class="o">(</span>save_compress_page<span class="o">())</span> <span class="k">return </span>1<span class="p">;</span>
        <span class="c">## ------(1)-----</span>
        <span class="o">=&gt;</span> save_zero_page<span class="o">()</span>
           <span class="o">=&gt;</span> len +<span class="o">=</span> save_zero_page_to_file<span class="o">()</span>
              <span class="o">=&gt;</span> <span class="k">if</span> <span class="o">(</span>is_zero_range<span class="o">(</span>p, TARGET_PAGE_SIZE<span class="o">))</span> 
                 <span class="c">## only transport FREW Bytes</span>
                 <span class="o">=&gt;</span> len +<span class="o">=</span> HEADER
              <span class="o">=&gt;</span> <span class="k">return </span>0<span class="p">;</span>
           <span class="c">## !!!!</span>
           <span class="o">=&gt;</span> <span class="k">if</span> <span class="o">(</span>len<span class="o">)</span>
              <span class="o">=&gt;</span> ram_counters.duplicate++<span class="p">;</span>
              <span class="o">=&gt;</span> ram_counters.transferred +<span class="o">=</span> len<span class="p">;</span>
              <span class="o">=&gt;</span> <span class="k">return </span>1
           <span class="o">=&gt;</span> <span class="k">else</span>
              <span class="c">## means not zero page</span>
              <span class="o">=&gt;</span> <span class="k">return</span> <span class="nt">-1</span><span class="p">;</span>
        <span class="o">=&gt;</span> XBZERLE handler... <span class="k">return</span>
        <span class="o">=&gt;</span> multifd handler ... <span class="k">return</span>
        <span class="o">=&gt;</span> ram_save_page<span class="o">()</span>
           <span class="o">=&gt;</span> save_normal_page<span class="o">()</span>
              <span class="o">=&gt;</span> save_page_header<span class="o">()</span>
              <span class="o">=&gt;</span> <span class="k">if </span>async  <span class="c">## XBZLER related</span>
                 <span class="o">=&gt;</span> qemu_put_buffer_async
              <span class="o">=&gt;</span> <span class="k">else</span>
                 <span class="c">## ------(2)------</span>
                 <span class="c">## !!!!!! transport HOLE page !!!!</span>
                 <span class="o">=&gt;</span> qemu_put_buffer<span class="o">(</span>TARGET_PAGE_SIZE<span class="o">)</span>
           <span class="o">=&gt;</span> ram_counters.transferred +<span class="o">=</span> header_bytes
           <span class="o">=&gt;</span> ram_counters.transferred +<span class="o">=</span> TARGET_PAGE_SIZE<span class="p">;</span>
           <span class="c">## !!!!</span>
           <span class="o">=&gt;</span> ram_counters.normal++<span class="p">;</span>
</pre></table></code></div></div><p>判断zero page的的方法很简单，就是判断该页中的每一个byte是不是0， 当然有很多加速的指令，我们下面会介绍。</p><p>如果是zero page，则会发送很少量的数据（一些header数据），并且 自增<code class="language-plaintext highlighter-rouge">ram_counters.duplicate</code>, 如果不是zero page(还有一些其他的，暂时 不介绍), 则会发送<code class="language-plaintext highlighter-rouge">header + 整个的page</code>.</p><p>那么，我们在热迁移之前想看下这些zero page有多少, 如果zero page很多， 并且脏页速率很低，我们可以认为该机器比较适合热迁移，在各个节点资源调度时， 可以优先处理这部分机器。</p><p>我们来看下相关细节</p><h3 id="how-to-determine-if-a-page-is-a-zero-page"><span class="me-2">How to determine if a page is a zero page</span><a href="#how-to-determine-if-a-page-is-a-zero-page" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>上面提到过，判断page是否是zero page的函数为<code class="language-plaintext highlighter-rouge">is_zero_range</code>, 大致 流程为:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>is_zero_range<span class="o">()</span>
<span class="o">=&gt;</span> buffer_is_zero<span class="o">()</span>
   <span class="o">=&gt;</span> __builtin_prefetch<span class="o">()</span>
   <span class="o">=&gt;</span> select_accel_fn<span class="o">()</span>
      <span class="o">=&gt;</span> <span class="k">if </span>len <span class="o">&gt;=</span> length_to_accel
         <span class="o">=&gt;</span> <span class="k">return </span>buffer_accel<span class="o">()</span>
      <span class="c">## else</span>
      <span class="o">=&gt;</span> <span class="k">return </span>buffer_zero_int
</pre></table></code></div></div><p>QEMU 会利用SIMD 对该操作做一些优化. 看下相关初始化代码:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>init_cpuid_cache
<span class="o">=&gt;</span> cpuid<span class="o">(</span>1,...<span class="o">)</span>
<span class="o">=&gt;</span> init <span class="sb">`</span>cache<span class="sb">`</span> var base on cpuid
   <span class="o">=&gt;</span> sse2 <span class="nt">--</span><span class="o">&gt;</span> cache |<span class="o">=</span> CACHE_SSE2
   <span class="o">=&gt;</span> avx  <span class="nt">--</span><span class="o">&gt;</span> cache |<span class="o">=</span> CACHE_SSE4
   <span class="o">=&gt;</span> avx2 <span class="nt">--</span><span class="o">&gt;</span> cache |<span class="o">=</span> CACHE_AVX2
   <span class="o">=&gt;</span> avx512f <span class="nt">--</span><span class="o">&gt;</span> cache |<span class="o">=</span> CACHE_AVX512F
<span class="o">=&gt;</span> cpuid_cache <span class="o">=</span> cache
<span class="o">=&gt;</span> init_accel
   <span class="o">=&gt;</span> <span class="k">if </span>cache &amp; CACHE_SSE2  buffer_accel <span class="o">=</span> buffer_zero_sse2<span class="p">;</span> length_to_accel <span class="o">=</span> 64<span class="p">;</span>
   <span class="o">=&gt;</span> <span class="k">if </span>cache &amp; CACHE_SSE4  buffer_accel <span class="o">=</span> buffer_zero_sse4<span class="p">;</span> length_to_accel <span class="o">=</span> 64<span class="p">;</span>
   <span class="o">=&gt;</span> <span class="k">if </span>cache &amp; CACHE_AVX2  buffer_accel <span class="o">=</span> buffer_zero_avx2<span class="p">;</span> length_to_accel <span class="o">=</span> 128<span class="p">;</span>
   <span class="o">=&gt;</span> <span class="k">if </span>cache &amp; CACHE_AVX512F  buffer_accel <span class="o">=</span> buffer_zero_avx512<span class="p">;</span> length_to_accel <span class="o">=</span> 256<span class="p">;</span>
</pre></table></code></div></div><p>做简单性能测试:</p><p>程序代码:</p><details open=""> <summary>测试代码</summary><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;immintrin.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
<span class="cp">#define DATA     0
</span><span class="kt">char</span> <span class="o">*</span> <span class="nf">my_mmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 定义要分配的内存大小</span>
    <span class="c1">// 使用 mmap 分配内存</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap failed"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 初始化随机数生成器</span>
    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>

    <span class="c1">// 将内存初始化为随机数据</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//data[i] = rand() % 256; // 生成 0 到 255 的随机字节</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATA</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 打印前 16 个字节的内容作为示例</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Random data:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%02x "</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">bool</span> <span class="nf">buffer_zero_avx2</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Begin with an unaligned head of 32 bytes.  */</span>
    <span class="n">__m256i</span> <span class="n">t</span> <span class="o">=</span> <span class="n">_mm256_loadu_si256</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="n">__m256i</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__m256i</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">32</span><span class="p">);</span>
    <span class="n">__m256i</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">__m256i</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">32</span><span class="p">);</span>

    <span class="cm">/* Loop over 32-byte aligned blocks of 128.  */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__builtin_prefetch</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_mm256_testz_si256</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span> <span class="p">;</span>

    <span class="cm">/* Finish the last block of 128 unaligned.  */</span>
    <span class="n">t</span> <span class="o">|=</span> <span class="n">_mm256_loadu_si256</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">t</span> <span class="o">|=</span> <span class="n">_mm256_loadu_si256</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">t</span> <span class="o">|=</span> <span class="n">_mm256_loadu_si256</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">t</span> <span class="o">|=</span> <span class="n">_mm256_loadu_si256</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>

    <span class="k">return</span> <span class="nf">_mm256_testz_si256</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">print_timestamp</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 获取当前时间</span>
    <span class="kt">time_t</span> <span class="n">raw_time</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">tm</span> <span class="o">*</span><span class="n">time_info</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

    <span class="c1">// 获取当前时间</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw_time</span><span class="p">);</span>

    <span class="c1">// 将时间转换为本地时间</span>
    <span class="n">time_info</span> <span class="o">=</span> <span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw_time</span><span class="p">);</span>

    <span class="c1">// 格式化时间为字符串</span>
    <span class="n">strftime</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">,</span> <span class="n">time_info</span><span class="p">);</span>

    <span class="c1">// 打印时间戳</span>
    <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define MY_DEB(...) do {printf("%s: ", print_timestamp()); printf(__VA_ARGS__);}while(0)
</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">ldq_he_p</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">__builtin_memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">bool</span>
<span class="nf">buffer_zero_int</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* For a very small buffer, simply accumulate all the bytes.  */</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">do</span> <span class="p">{</span>
            <span class="n">t</span> <span class="o">|=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* Otherwise, use the unaligned memory access functions to
           handle the beginning and end of the buffer, with a couple
           of loops handling the middle aligned section.  */</span>
        <span class="kt">uint64_t</span> <span class="n">t</span> <span class="o">=</span> <span class="n">ldq_he_p</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">const</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">8</span><span class="p">);</span>
        <span class="k">const</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">8</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(;</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">;</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">__builtin_prefetch</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">t</span> <span class="o">|=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">t</span> <span class="o">|=</span> <span class="n">ldq_he_p</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
        <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">MY_DEB</span><span class="p">(</span><span class="s">"mmap begin </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">my_mmap</span><span class="p">();</span>
        <span class="n">MY_DEB</span><span class="p">(</span><span class="s">"mmap  end </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="n">MY_DEB</span><span class="p">(</span><span class="s">"random end</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">MY_DEB</span><span class="p">(</span><span class="s">"i = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">4096</span><span class="p">)</span>  <span class="p">{</span>
                        <span class="n">buffer_zero_avx2</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">MY_DEB</span><span class="p">(</span><span class="s">"buffer zero avx end</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">MY_DEB</span><span class="p">(</span><span class="s">"i = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">4096</span><span class="p">)</span>  <span class="p">{</span>
                        <span class="n">buffer_zero_int</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">MY_DEB</span><span class="p">(</span><span class="s">"buffer zero int</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details><p>该部分代码主要copy qemu的 <code class="language-plaintext highlighter-rouge">buffer_zero_xxx</code>, 并在<code class="language-plaintext highlighter-rouge">Intel(R) Xeon(R) CPU E5-2640 v3 @ 2.60GHz</code> cpu上进行测试. DATA设置为0，性能最差.</p><p>我们主要以其为基准得到测试结果</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>Random data:
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
2024-12-02 15:34:01: mmap  end
2024-12-02 15:34:01: random end
2024-12-02 15:34:01: i = 0
...
2024-12-02 15:34:09: i = 90
2024-12-02 15:34:10: buffer zero avx end
2024-12-02 15:34:10: i = 0
...
2024-12-02 15:34:20: i = 90
2024-12-02 15:34:22: buffer zero int
</pre></table></code></div></div><p>令人意外的是，两者性能差距并不是很大，大概都是1s处理10G数据。不过无论是哪种方法， 性能都不符合当前需求。</p><p>能不能通过一种粗略的方式，来获取KVM 建立 ept 映射 内存的数量, 来粗略估计zero page 数量。</p><p>内核中提供了kvm stats 相关api，可以完成这个事情。我们先来看下kvm stats 相关历史.</p><h2 id="kvm-stat"><span class="me-2">kvm stat</span><a href="#kvm-stat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="org-kvm-patch"><span class="me-2">ORG KVM PATCH</span><a href="#org-kvm-patch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>KVM stat 其实在 kvm的第一个patch中就引入了，当时的kvm stats 比较简单，使用全局变量 来进行全局的 kvm 事件统计, 并通过<code class="language-plaintext highlighter-rouge">debugfs</code>来和用户态交互。</p><ul><li><p>全局变量</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_stat</span> <span class="p">{</span>
    <span class="n">u32</span> <span class="n">pf_fixed</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">pf_guest</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">tlb_flush</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">invlpg</span><span class="p">;</span>

    <span class="n">u32</span> <span class="n">exits</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">io_exits</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">mmio_exits</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">signal_exits</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">irq_exits</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">kvm_stat</span> <span class="n">kvm_stat</span><span class="p">;</span>
</pre></table></code></div></div><li><p>debugfs 相关</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_stats_debugfs_item</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
<span class="p">}</span> <span class="n">debugfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">"pf_fixed"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">pf_fixed</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"pf_guest"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">pf_guest</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"tlb_flush"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">tlb_flush</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"invlpg"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">invlpg</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"exits"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">exits</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"io_exits"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">io_exits</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"mmio_exits"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">mmio_exits</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"signal_exits"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">signal_exits</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"irq_exits"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_stat</span><span class="p">.</span><span class="n">irq_exits</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">kvm_init_debug</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">kvm_stats_debugfs_item</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="n">debugfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">"kvm"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">debugfs_entries</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">debugfs_dir</span><span class="p">,</span>
                           <span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>以<code class="language-plaintext highlighter-rouge">pf_fixed</code>为例，其会在fixed page fault exception，相关处理流程中自增</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>FNAME<span class="o">(</span>page_fault<span class="o">)</span>
<span class="o">=&gt;</span> <span class="k">if </span>write_fault
   <span class="c"># main use for dirty tracking </span>
   <span class="o">=&gt;</span> fixed <span class="o">=</span> FNAME<span class="o">(</span>fix_write_pf<span class="o">)</span>
<span class="o">=&gt;</span> <span class="k">else</span> 
   <span class="c"># for emulate CR4.WP </span>
   <span class="o">=&gt;</span> fixed <span class="o">=</span> fix_read_pf<span class="o">()</span>
<span class="o">=&gt;</span> <span class="k">if </span>fixed 
   <span class="o">=&gt;</span> ++kvm_stat.pf_fixed<span class="p">;</span>
</pre></table></code></div></div></ul><p>###</p><h2 id="参考链接"><span class="me-2">参考链接</span><a href="#参考链接" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://lore.kernel.org/kvm/1463570785-6766-1-git-send-email-frankja@linux.vnet.ibm.com/#t">v2: Improve KVM per VM monitoring</a><li><a href="https://lore.kernel.org/all/ed02f9c9-ae4a-8694-316d-88fc82677b4d@redhat.com/T/#mb548aae542f17352f728f10ac3339d9324060177">kvm: x86: export TSC information to user-space</a><li><a href="https://patchwork.kernel.org/project/linux-kselftest/cover/20210611124624.1404010-1-jingzhangos@google.com/">KVM stat basedfd mail</a><li><a href="https://patchwork.kernel.org/project/qemu-devel/cover/20220530150714.756954-1-pbonzini@redhat.com/">QEMU kvm stat based-fd mail</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/live-migration/">live_migration</a>, <a href="/categories/kvm-stats/">kvm stats</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/kvm-stats/" class="post-tag no-text-decoration" >kvm-stats</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=kvm%20stats%20-%20one%20step%20at%20a%20time&url=%2Fposts%2Fkvm-stats%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=kvm%20stats%20-%20one%20step%20at%20a%20time&u=%2Fposts%2Fkvm-stats%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fkvm-stats%2F&text=kvm%20stats%20-%20one%20step%20at%20a%20time" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/kvm-stats/">kvm stats</a><li class="text-truncate lh-lg"> <a href="/posts/dirty-rate/">dirty-rate calc</a><li class="text-truncate lh-lg"> <a href="/posts/guestperf/">guestperf</a><li class="text-truncate lh-lg"> <a href="/posts/kernel-pml/">kernel PML</a><li class="text-truncate lh-lg"> <a href="/posts/live-migration-workflow/">live migration</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-bitmap/">dirty-bitmap</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-ring/">dirty-ring</a> <a class="post-tag btn btn-outline-primary" href="/tags/guestperf/">guestperf</a> <a class="post-tag btn btn-outline-primary" href="/tags/html-details/">html-details</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/live-migration-workflow/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1731424800" data-df="ll" > Nov 12, 2024 </time><h4 class="pt-0 my-2">live migration</h4><div class="text-muted"><p>热迁移简述 热迁移(live migration) 可以在虚拟机正在RUNNING时，对用户透明的从 source host 迁移到dest host. 涉及迁移对象种类 热迁移的流程会大概包含几个对象: cpu 内存 设备 主要工作 而热迁移主要工作是将这几个对象的信息，从原...</p></div></div></a></article><article class="col"> <a href="/posts/Migration-auto-converge-problem/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1731424800" data-df="ll" > Nov 12, 2024 </time><h4 class="pt-0 my-2">[Translate]: Migration auto-converge problem</h4><div class="text-muted"><p>From: &quot;Jason J. Herne&quot; &amp;lt;jjherne@linux.vnet.ibm.com&amp;gt; To: &quot;qemu-devel@nongnu.org qemu-devel&quot; &amp;lt;qemu-devel@nongnu.org&amp;gt;, Christian Borntraeger &amp;lt;borntraeger@de.ibm.com&amp;gt; Subject: [Qemu-...</p></div></div></a></article><article class="col"> <a href="/posts/auto-converge/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1731424800" data-df="ll" > Nov 12, 2024 </time><h4 class="pt-0 my-2">auto-converge</h4><div class="text-muted"><p>简介 在大型机器，并且系统负载高时热迁移，工作负载往往比热迁移速度更快，从而导致 live migration无法 converge. 这个往往受限于bandwidth, 虽然现在网卡的带宽越来越高。但是虚拟机的核心数量 以及cpu主频，内存带宽也在逐渐增大。 Chegu Vinod 在 2013 年提出了 auto-converge, （但是的场景即使使用了10Gig NICs也仍然...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/dirty-rate/" class="btn btn-outline-primary" aria-label="Older" ><p>dirty-rate calc</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://twitter.com/fuqiang_cai">fuqiang wang</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v6.5.5" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/virt/">virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/para-virt/">para_virt</a> <a class="post-tag btn btn-outline-primary" href="/tags/autoconverge/">autoconverge</a> <a class="post-tag btn btn-outline-primary" href="/tags/qemu-hot-upgrade/">qemu_hot_upgrade</a> <a class="post-tag btn btn-outline-primary" href="/tags/acs/">acs</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-rate/">dirty rate</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-bitmap/">dirty-bitmap</a> <a class="post-tag btn btn-outline-primary" href="/tags/dirty-ring/">dirty-ring</a> <a class="post-tag btn btn-outline-primary" href="/tags/guestperf/">guestperf</a> <a class="post-tag btn btn-outline-primary" href="/tags/html-details/">html-details</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
