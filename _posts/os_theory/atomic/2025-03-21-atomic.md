---
layout: post
title:  "atomic"
author: fuqiang
date:   2025-03-21 17:51:00 +0800
categories: [atomic]
tags: [atomic]
---

* [semantics]()
* [knowledge background]()
  + [RMW instruction]()
  + [who measures atomic]()
  + [memory order]()
* [atomic operation]()
  + [Guaranteed Atomic Operations]()
  + [LOCKED ATOMIC OPERATIONS]()
* [cache locking VS BUS locking]()
  + [cache locking]()
  + [BUS locking]()
* [split lock is a big weapon]()
* [How to counter this big weapon]()
  + [intel]()
  + [amd]()

## semnatics

atom 一词园子古希腊语，意思是"不可分割", 大约在2500
年前，古希腊原子派，原子派认为物质在无数次分割之后，
最终会小到无法分割。

atomic 就是用来描述事物已经是不可分割的。在计算机系统中,
软件侧通过指令来控制CPU，对于软件来说，每一条指令就是
atomic operation. 但是对于硬件来说，一条指令执行可以
分为很多步骤。由于乱序执行的存在，指令的某些步骤
可以并行执行, 甚至倒反天罡（out-of-order). 但是软件又
希望某些指令硬件侧可以保持"原子性", 这些操作被称为
原子操作, 使用原子操作操作的变量被称为原子变量。

## knowledge background

本章节来介绍下相关知识背景。

### RMW instruction
RMW 全程 read-modify-write. 该指令有两个访存动作，先读再写,
这在单核上没有什么问题，但是在多核架构上，我们想象下两个cpu都
执行`i++`, 我们将指令拆解，并按照如下顺序执行:

```
init i = 0

CPU 0          CPU 1
load i = 0
               load i = 0
               let i = i + 1
let i = i + 1
               store i
store i
```

当两个cpu 都执行完i++ 后，最终i的结果是1. 这显然不合理。

于是，为确保多个cpu同时执行RMW 操作是correct, CPU 引入了
atomic operation. 其最终达成的效果是，让在一个cpu执行RMW
操作时, 其他的CPU不能执行，如下图所示:
```
CPU 0            CPU 0
 +------------+
 | load i     |
 | modify i   |
 | store i    |
 +------------+    
                 +-------------+
                 | load i      |
                 | modify i    |
                 | store i     |
                 +-------------+
```

### who measures atomic         
