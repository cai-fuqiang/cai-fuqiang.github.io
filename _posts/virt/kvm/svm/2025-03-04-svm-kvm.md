---
layout: post
title:  "amd svm kvm code"
author: fuqiang
date:   2025-03-04 10:18:00 +0800
categories: [kvm,svm]
tags: [svm]
---

## 代码流程

svm_hardware_setup
```sh
svm_hardware_setup
=> for_each_possible_cpu(cpu)
   => sd->cpu = cpu
   => svm_cpu_init(cpu)
   # 为每个cpu分配一个page，用于VMRUN/#VMEXIT save/load
   # host state
   => sd->save_area = alloc_page(GFP_KERNEL | __GFP_ZERO)
```

svm_hardware_enable
```sh
svm_hardware_enable
=> wrmsrl(MSR_VM_HSAVE_PA, __sme_page_pa(sd->save_area))
=> sd = per_cpu(svm_data, me)
## 即使那个
=> wrmsrl(MSR_VM_HSAVE_PA, __sme_page_pa(sd->save_area))
```

svm_create_vcpu
```sh => svm_create_vcpu
   => vmcb01_page = alloc_page()
   => avic_init_vcpu()
   => svm->vmcb01.ptr = page_address(vmcb01_page)
   => svm->vmcb01.pa = page_to_pfn(vmcb01_page)
   => svm_switch_vmcb(svm, &svm->vmcb01)
      ## 赋值 current_vmcb
      => svm->current_vmcb = target_vmcb;
      => svm->vmcb = target_vmcb->ptr;
   => svm->guest_state_loaded = false;
```

svm_vcpu_load:
```sh
=> svm_vcpu_load
   ## svm_data表示每个cpu上当前正要运行的guest信息
   ## 找到当前cpu 的percpu变量
   => struct svm_cpu_data *sd = per_cpu(svm_data, cpu);
   => if sd->current_vmcb != svm->vmcb
      # just so? just so!
      # VMCB和VMCS不一样，不用显式指明当前正要运行的guest
      # vmcs
      => sd->current_vmcb = svm->vmcb
   => if kvm_vcpu_apicv_active(vcpu)
      => avic_vcpu_load(vcpu, cpu)
```

svm_vcpu_put:
```sh
=> svm_vcpu_put
   => if kvm_vcpu_apicv_active(vcpu)
      => avic_vcpu_put(vcpu)
   => svm_prepare_host_switch
      => to_svm(vcpu)->guest_state_loaded = false;
```

vcpu_enter_guest (part):
```sh
vcpu_enter_guest
=> svm_vcpu_run
   => svm_vcpu_enter_exit
      => if sev_es_guest(vcpu->kvm)
         # why so simple ???
         => __svm_sev_es_vcpu_run(vmcb_pa)
      =else:
         # load guest external vmcb information
         => vmload(svm->vmcb01.pa)
         # 执行VMRUN进入guest
         => __svm_vcpu_run(vmcb_pa, (unsigned long *)&vcpu->arch.regs)
         # save guest external vmcb information
         => vmsave(svm->vmcb01.pa)
         # 这是什么操作?
         #
         # 手册中的vmload说明了rAX参数为VMCB,
         # 难道存储host state的格式，和VMCB一样?
         #
         # 相关patch引入
         # e79b91bb3c916a52ce823ab60489c717c925c49f
         #
         # KVM: SVM: use vmsave/vmload for saving/restoring additional host state
         => vmload(__sme_page_pa(sd->save_area))
```
