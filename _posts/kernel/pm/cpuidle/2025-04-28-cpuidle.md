
* [introduce]()
* [struct]()
  + [cpuidle_device]()
  + [cpuidle_driver]()
  + [cpuidle_state]()
  + [cpuidle_governor]()
* 

## struct

### cpuidle_device
```cpp
struct cpuidle_device {
        unsigned int            registered:1;
        unsigned int            enabled:1;
        //表示上次poll idle时，达到了poll的时间上限
        unsigned int            poll_time_limit:1;
        unsigned int            cpu;
        ktime_t                 next_hrtimer;

        //上次idle的最后一个idle state 的index
        int                     last_state_idx;

        //上次idle的最后一个idle state 的 residency_ns
        u64                     last_residency_ns;
        // poll idle 的时间上限，如果达到了该上限，则退出poll idle
        // 状态
        u64                     poll_limit_ns;
        u64                     forced_idle_latency_limit_ns;
        //主要用来统计
        struct cpuidle_state_usage      states_usage[CPUIDLE_STATE_MAX];
        // /sys/devices/system/cpu/cpuxxx/cpuidle
        struct cpuidle_state_kobj *kobjs[CPUIDLE_STATE_MAX];
        struct cpuidle_driver_kobj *kobj_driver;
        struct cpuidle_device_kobj *kobj_dev;
        struct list_head        device_list;

#ifdef CONFIG_ARCH_NEEDS_CPU_IDLE_COUPLED
        cpumask_t               coupled_cpus;
        struct cpuidle_coupled  *coupled;
#endif
};
```
### cpuidle_driver

* **_bctimer_**:
* **_cpuidle_state_**: 
* **_state_count:_**: cpuidle_state 数量
* **_safe_state_index_**:
* **_cpumask_**: 表示该driver在哪些cpu上正在运行
* **_governor_**: 注册是首选的 governor

### cpuidle_state

* **_exit_latency_** : 从该idle状态退出所需的延迟(us单位)
* **_exit_latency_ns_** : 同上, ns 单位
* **_target_residency_** : 处理器进入到该idle状态后, 应停留的最短时间
* **_target_residency_ns_** : 同上, ns 单位
* **_power_usage_** : 在这个状态下的功耗
* **_enter_** : 进入该状态的方法
* **_enter_dead_** :
* **_enter_s2idle_** :

### cpuidle_governor
```cpp
struct cpuidle_governor {
        char                    name[CPUIDLE_NAME_LEN];
        struct list_head        governor_list;
        /*
         * 该值用来表示 governor 的使用优先级，rating 大的优先选择;
         * 但是如果用户通过module param: governor指定的类型优先级最高
         */
        unsigned int            rating;

        int  (*enable)          (struct cpuidle_driver *drv,
                                        struct cpuidle_device *dev);
        void (*disable)         (struct cpuidle_driver *drv,
                                        struct cpuidle_device *dev);

        int  (*select)          (struct cpuidle_driver *drv,
                                        struct cpuidle_device *dev,
                                        bool *stop_tick);
        void (*reflect)         (struct cpuidle_device *dev, int index);
};
```
* select: 用来选择进入哪个 idle 状态
* reflect: 反馈调节。在该idle state结束时调用, 相当于根据idle的结果来反馈
           调节部分参数.

## 大体流程


## register
### governor
### device
### driver

### state
#### poll_idle_init
```cpp
void cpuidle_poll_state_init(struct cpuidle_driver *drv)
{
        struct cpuidle_state *state = &drv->states[0];

        snprintf(state->name, CPUIDLE_NAME_LEN, "POLL");
        snprintf(state->desc, CPUIDLE_DESC_LEN, "CPUIDLE CORE POLL IDLE");
        state->exit_latency = 0;
        state->target_residency = 0;
        state->exit_latency_ns = 0;
        state->target_residency_ns = 0;
        state->power_usage = -1;
        state->enter = poll_idle;
        state->flags = CPUIDLE_FLAG_POLLING;
}
```

## 参考链接
1. [Linux 服务器功耗与性能管理（三）：cpuidle 子系统的实现（2024）](https://arthurchiao.art/blog/linux-cpu-3-zh/)
2. [Linux Cpuidle介绍](https://blog.csdn.net/feelabclihu/article/details/125688355)
3. [Advances in CPU Idle Time Management](https://events19.linuxfoundation.org/wp-content/uploads/2017/11/Advances-in-CPU-Idle-Time-Management-Rafael-Wysocki-Intel.pdf)
4. [Advances in CPU Idle Time Management - YOUTUBE](https://www.youtube.com/watch?v=vh2_xkCnwhI)
4. [cpuidle cluster](https://blog.linuxplumbersconf.org/2012/wp-content/uploads/2012/09/cpuidle-cluster.pdf)

* ['Green' Code Development](https://www.cprogramming.com/appup6.html)
